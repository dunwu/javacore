<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>æºç çº§æ·±åº¦ç†è§£ Java SPI | JAVACORE</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/javacore/img/favicon.ico">
    <script src="https://cdn.wwads.cn/js/makemoney.js" type="text/javascript"></script>
    <meta name="description" content="â˜• JavaCore æ˜¯ä¸€ä¸ª Java æ ¸å¿ƒæŠ€æœ¯æ•™ç¨‹ã€‚">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    <meta name="wwads-cn-verify" content="mxqWx62nfQQ9ocT4e5DzISHzOWyF4s">
    
    <link rel="preload" href="/javacore/assets/css/0.styles.be3ea3bc.css" as="style"><link rel="preload" href="/javacore/assets/js/app.44fc03ae.js" as="script"><link rel="preload" href="/javacore/assets/js/2.aded268b.js" as="script"><link rel="preload" href="/javacore/assets/js/24.e47f9024.js" as="script"><link rel="prefetch" href="/javacore/assets/js/10.b7bca9b5.js"><link rel="prefetch" href="/javacore/assets/js/11.033d3a41.js"><link rel="prefetch" href="/javacore/assets/js/12.b093ffe4.js"><link rel="prefetch" href="/javacore/assets/js/13.d561ca11.js"><link rel="prefetch" href="/javacore/assets/js/14.90010e0b.js"><link rel="prefetch" href="/javacore/assets/js/15.37509588.js"><link rel="prefetch" href="/javacore/assets/js/16.cd24ed18.js"><link rel="prefetch" href="/javacore/assets/js/17.5e555f8c.js"><link rel="prefetch" href="/javacore/assets/js/18.df926f74.js"><link rel="prefetch" href="/javacore/assets/js/19.8da3be6e.js"><link rel="prefetch" href="/javacore/assets/js/20.fb42e052.js"><link rel="prefetch" href="/javacore/assets/js/21.9d7decc0.js"><link rel="prefetch" href="/javacore/assets/js/22.f31ecff9.js"><link rel="prefetch" href="/javacore/assets/js/23.6f5cde97.js"><link rel="prefetch" href="/javacore/assets/js/25.da7e1173.js"><link rel="prefetch" href="/javacore/assets/js/26.e041331b.js"><link rel="prefetch" href="/javacore/assets/js/27.8f2ef716.js"><link rel="prefetch" href="/javacore/assets/js/28.a919e270.js"><link rel="prefetch" href="/javacore/assets/js/29.4846001f.js"><link rel="prefetch" href="/javacore/assets/js/3.d34c63b0.js"><link rel="prefetch" href="/javacore/assets/js/30.b3879734.js"><link rel="prefetch" href="/javacore/assets/js/31.e74cfb72.js"><link rel="prefetch" href="/javacore/assets/js/32.55bb9631.js"><link rel="prefetch" href="/javacore/assets/js/33.c695a6d1.js"><link rel="prefetch" href="/javacore/assets/js/34.146194b0.js"><link rel="prefetch" href="/javacore/assets/js/35.47c615d2.js"><link rel="prefetch" href="/javacore/assets/js/36.36c11b19.js"><link rel="prefetch" href="/javacore/assets/js/37.e4c911e1.js"><link rel="prefetch" href="/javacore/assets/js/38.612b0f0f.js"><link rel="prefetch" href="/javacore/assets/js/39.a8479ee6.js"><link rel="prefetch" href="/javacore/assets/js/4.884deeca.js"><link rel="prefetch" href="/javacore/assets/js/40.301701cc.js"><link rel="prefetch" href="/javacore/assets/js/41.7c62f68f.js"><link rel="prefetch" href="/javacore/assets/js/42.e9e5707c.js"><link rel="prefetch" href="/javacore/assets/js/43.2254ee61.js"><link rel="prefetch" href="/javacore/assets/js/44.24a7c914.js"><link rel="prefetch" href="/javacore/assets/js/45.4ed583ae.js"><link rel="prefetch" href="/javacore/assets/js/46.68ab70d3.js"><link rel="prefetch" href="/javacore/assets/js/47.1716d6b6.js"><link rel="prefetch" href="/javacore/assets/js/48.8069bdf8.js"><link rel="prefetch" href="/javacore/assets/js/49.d272babd.js"><link rel="prefetch" href="/javacore/assets/js/5.0d7069e0.js"><link rel="prefetch" href="/javacore/assets/js/50.7fd74f29.js"><link rel="prefetch" href="/javacore/assets/js/51.f88d9d36.js"><link rel="prefetch" href="/javacore/assets/js/52.2adc8dae.js"><link rel="prefetch" href="/javacore/assets/js/53.e90f1fda.js"><link rel="prefetch" href="/javacore/assets/js/54.8616b845.js"><link rel="prefetch" href="/javacore/assets/js/55.1fabc8f2.js"><link rel="prefetch" href="/javacore/assets/js/56.e604e971.js"><link rel="prefetch" href="/javacore/assets/js/57.c4ac5a73.js"><link rel="prefetch" href="/javacore/assets/js/58.8e47e699.js"><link rel="prefetch" href="/javacore/assets/js/59.1c10231b.js"><link rel="prefetch" href="/javacore/assets/js/6.12339b00.js"><link rel="prefetch" href="/javacore/assets/js/60.bbcc0b2c.js"><link rel="prefetch" href="/javacore/assets/js/61.9d5ce6ce.js"><link rel="prefetch" href="/javacore/assets/js/62.db323fc4.js"><link rel="prefetch" href="/javacore/assets/js/63.ba26811b.js"><link rel="prefetch" href="/javacore/assets/js/64.b2257255.js"><link rel="prefetch" href="/javacore/assets/js/65.b3e77388.js"><link rel="prefetch" href="/javacore/assets/js/66.fbb8f12c.js"><link rel="prefetch" href="/javacore/assets/js/67.def25516.js"><link rel="prefetch" href="/javacore/assets/js/68.52669526.js"><link rel="prefetch" href="/javacore/assets/js/69.294be448.js"><link rel="prefetch" href="/javacore/assets/js/7.e7d8e450.js"><link rel="prefetch" href="/javacore/assets/js/70.8f9c4fe6.js"><link rel="prefetch" href="/javacore/assets/js/71.a20157d2.js"><link rel="prefetch" href="/javacore/assets/js/8.0ccc6dba.js"><link rel="prefetch" href="/javacore/assets/js/9.6cfc63c0.js">
    <link rel="stylesheet" href="/javacore/assets/css/0.styles.be3ea3bc.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/javacore/" class="home-link router-link-active"><img src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" alt="JAVACORE" class="logo"> <span class="site-name can-hide">JAVACORE</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/01.åŸºç¡€ç‰¹æ€§/" class="nav-link">åŸºç¡€ç‰¹æ€§</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/02.é«˜çº§ç‰¹æ€§/" class="nav-link">é«˜çº§ç‰¹æ€§</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/03.å®¹å™¨/" class="nav-link">å®¹å™¨</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/04.IO/" class="nav-link">IO</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/05.å¹¶å‘/" class="nav-link">å¹¶å‘</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/06.JVM/" class="nav-link">JVM</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">âœ¨ Javaç³»åˆ—</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/java-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/javacore/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaCore æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-boot-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring Boot æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/dunwu/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ¯ åšå®¢
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/dunwu/javacore" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/01.åŸºç¡€ç‰¹æ€§/" class="nav-link">åŸºç¡€ç‰¹æ€§</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/02.é«˜çº§ç‰¹æ€§/" class="nav-link">é«˜çº§ç‰¹æ€§</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/03.å®¹å™¨/" class="nav-link">å®¹å™¨</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/04.IO/" class="nav-link">IO</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/05.å¹¶å‘/" class="nav-link">å¹¶å‘</a></div><div class="nav-item"><a href="/javacore/01.Java/01.JavaSE/06.JVM/" class="nav-link">JVM</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">âœ¨ Javaç³»åˆ—</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/java-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Java æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/javacore/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JavaCore æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dunwu.github.io/spring-boot-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Spring Boot æ•™ç¨‹ ğŸ“š
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/dunwu/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ¯ åšå®¢
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/dunwu/javacore" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaSE</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>åŸºç¡€ç‰¹æ€§</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>é«˜çº§ç‰¹æ€§</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javacore/pages/4c1dd4/" class="sidebar-link">Java æ­£åˆ™ä»å…¥é—¨åˆ°ç²¾é€š</a></li><li><a href="/javacore/pages/a249ff/" class="sidebar-link">Java ç¼–ç å’ŒåŠ å¯†</a></li><li><a href="/javacore/pages/57003e/" class="sidebar-link">Java å›½é™…åŒ–</a></li><li><a href="/javacore/pages/ad1cce/" class="sidebar-link">JDK8 å…¥é—¨æŒ‡å—</a></li><li><a href="/javacore/pages/496a7e/" aria-current="page" class="active sidebar-link">æºç çº§æ·±åº¦ç†è§£ Java SPI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/javacore/pages/496a7e/#spi-ç®€ä»‹" class="sidebar-link">SPI ç®€ä»‹</a></li><li class="sidebar-sub-header level2"><a href="/javacore/pages/496a7e/#spi-ç¤ºä¾‹" class="sidebar-link">SPI ç¤ºä¾‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-æ¥å£" class="sidebar-link">SPI æ¥å£</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-å®ç°ç±»" class="sidebar-link">SPI å®ç°ç±»</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-é…ç½®" class="sidebar-link">SPI é…ç½®</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#serviceloader" class="sidebar-link">ServiceLoader</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/javacore/pages/496a7e/#spi-åŸç†" class="sidebar-link">SPI åŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#serviceloader-çš„æˆå‘˜å˜é‡" class="sidebar-link">ServiceLoader çš„æˆå‘˜å˜é‡</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#serviceloader-çš„å·¥ä½œæµç¨‹" class="sidebar-link">ServiceLoader çš„å·¥ä½œæµç¨‹</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-å’Œç±»åŠ è½½å™¨" class="sidebar-link">SPI å’Œç±»åŠ è½½å™¨</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#java-spi-çš„ä¸è¶³" class="sidebar-link">Java SPI çš„ä¸è¶³</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/javacore/pages/496a7e/#spi-åº”ç”¨åœºæ™¯" class="sidebar-link">SPI åº”ç”¨åœºæ™¯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-jdbc-drivermanager" class="sidebar-link">SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ JDBC DriverManager</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#åˆ›å»ºæ•°æ®åº“è¿æ¥" class="sidebar-link">åˆ›å»ºæ•°æ®åº“è¿æ¥</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#drivermanager" class="sidebar-link">DriverManager</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-common-logging" class="sidebar-link">SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ Common-Logging</a></li><li class="sidebar-sub-header level3"><a href="/javacore/pages/496a7e/#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-spring-boot" class="sidebar-link">SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ Spring Boot</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#springbootapplication-æ³¨è§£" class="sidebar-link">@SpringBootApplication æ³¨è§£</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#springbootconfiguration-æ³¨è§£" class="sidebar-link">@SpringBootConfiguration æ³¨è§£</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#enableautoconfiguration-æ³¨è§£" class="sidebar-link">@EnableAutoConfiguration æ³¨è§£</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#autoconfigurationpackage-æ³¨è§£" class="sidebar-link">@AutoConfigurationPackage æ³¨è§£</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#springfactoriesloader-loadfactorynames-æ–¹æ³•" class="sidebar-link">SpringFactoriesLoader.loadFactoryNames æ–¹æ³•</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#spring-boot-çš„-autoconfiguration-ç±»" class="sidebar-link">Spring Boot çš„ AutoConfiguration ç±»</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/javacore/pages/496a7e/#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-dubbo" class="sidebar-link">SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ Dubbo</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#extensionloader-å…¥å£" class="sidebar-link">ExtensionLoader å…¥å£</a></li><li class="sidebar-sub-header level4"><a href="/javacore/pages/496a7e/#è·å–æ‰€æœ‰çš„æ‹“å±•ç±»" class="sidebar-link">è·å–æ‰€æœ‰çš„æ‹“å±•ç±»</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/javacore/pages/496a7e/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/javacore/pages/d71f2c/" class="sidebar-link">Java ç¼–ç¨‹è§„èŒƒ</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>å®¹å™¨</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>å¹¶å‘</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/javacore/pages/5f886e/" class="sidebar-link">Java é¢è¯•æ€»ç»“</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/javacore/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/javacore/categories/?category=Java" title="åˆ†ç±»" data-v-06225672>Java</a></li><li data-v-06225672><a href="/javacore/categories/?category=JavaSE" title="åˆ†ç±»" data-v-06225672>JavaSE</a></li><li data-v-06225672><a href="/javacore/categories/?category=%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" title="åˆ†ç±»" data-v-06225672>é«˜çº§ç‰¹æ€§</a></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/dunwu" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>dunwu</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-04-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">æºç çº§æ·±åº¦ç†è§£ Java SPI<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="æºç çº§æ·±åº¦ç†è§£-java-spi"><a href="#æºç çº§æ·±åº¦ç†è§£-java-spi" class="header-anchor">#</a> æºç çº§æ·±åº¦ç†è§£ Java SPI</h1> <h2 id="spi-ç®€ä»‹"><a href="#spi-ç®€ä»‹" class="header-anchor">#</a> SPI ç®€ä»‹</h2> <p>SPI å…¨ç§° Service Provider Interfaceï¼Œæ˜¯ Java æä¾›çš„ï¼Œæ—¨åœ¨ç”±ç¬¬ä¸‰æ–¹å®ç°æˆ–æ‰©å±•çš„ APIï¼Œå®ƒæ˜¯ä¸€ç§ç”¨äºåŠ¨æ€åŠ è½½æœåŠ¡çš„æœºåˆ¶ã€‚Java ä¸­ SPI æœºåˆ¶ä¸»è¦æ€æƒ³æ˜¯å°†è£…é…çš„æ§åˆ¶æƒç§»åˆ°ç¨‹åºä¹‹å¤–ï¼Œåœ¨æ¨¡å—åŒ–è®¾è®¡ä¸­è¿™ä¸ªæœºåˆ¶å°¤å…¶é‡è¦ï¼Œå…¶æ ¸å¿ƒæ€æƒ³å°±æ˜¯ <strong>è§£è€¦</strong>ã€‚</p> <p>Java SPI æœ‰å››ä¸ªè¦ç´ ï¼š</p> <ul><li><strong>SPI æ¥å£</strong>ï¼šä¸ºæœåŠ¡æä¾›è€…å®ç°ç±»çº¦å®šçš„çš„æ¥å£æˆ–æŠ½è±¡ç±»ã€‚</li> <li><strong>SPI å®ç°ç±»</strong>ï¼šå®é™…æä¾›æœåŠ¡çš„å®ç°ç±»ã€‚</li> <li><strong>SPI é…ç½®</strong>ï¼šJava SPI æœºåˆ¶çº¦å®šçš„é…ç½®æ–‡ä»¶ï¼Œæä¾›æŸ¥æ‰¾æœåŠ¡å®ç°ç±»çš„é€»è¾‘ã€‚é…ç½®æ–‡ä»¶å¿…é¡»ç½®äº <code>META-INF/services</code> ç›®å½•ä¸­ï¼Œå¹¶ä¸”ï¼Œæ–‡ä»¶ååº”ä¸æœåŠ¡æä¾›è€…æ¥å£çš„å®Œå…¨é™å®šåä¿æŒä¸€è‡´ã€‚æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œéƒ½æœ‰ä¸€ä¸ªå®ç°æœåŠ¡ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒæ ·æ˜¯æœåŠ¡æä¾›è€…ç±»çš„å®Œå…¨é™å®šåç§°ã€‚</li> <li><strong><code>ServiceLoader</code></strong>ï¼šJava SPI çš„æ ¸å¿ƒç±»ï¼Œç”¨äºåŠ è½½ SPI å®ç°ç±»ã€‚ <code>ServiceLoader</code> ä¸­æœ‰å„ç§å®ç”¨æ–¹æ³•æ¥è·å–ç‰¹å®šå®ç°ã€è¿­ä»£å®ƒä»¬æˆ–é‡æ–°åŠ è½½æœåŠ¡ã€‚</li></ul> <h2 id="spi-ç¤ºä¾‹"><a href="#spi-ç¤ºä¾‹" class="header-anchor">#</a> SPI ç¤ºä¾‹</h2> <p>æ­£æ‰€è°“ï¼Œå®è·µå‡ºçœŸçŸ¥ï¼Œæˆ‘ä»¬ä¸å¦¨é€šè¿‡ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨ Java SPIã€‚</p> <h3 id="spi-æ¥å£"><a href="#spi-æ¥å£" class="header-anchor">#</a> SPI æ¥å£</h3> <p>é¦–å…ˆï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ª SPI æ¥å£ï¼Œå’Œæ™®é€šæ¥å£å¹¶æ²¡æœ‰ä»€ä¹ˆå·®åˆ«ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>spi</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataStorage</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="spi-å®ç°ç±»"><a href="#spi-å®ç°ç±»" class="header-anchor">#</a> SPI å®ç°ç±»</h3> <p>å‡è®¾ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºä¸­ä½¿ç”¨ä¸¤ç§ä¸åŒçš„æ•°æ®å­˜å‚¨â€”â€”Mysql å’Œ Redisã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªä¸åŒçš„å®ç°ç±»å»åˆ†åˆ«å®Œæˆç›¸åº”å·¥ä½œã€‚</p> <p>Mysql æŸ¥è¯¢ MOCK ç±»</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>spi</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlStorage</span> <span class="token keyword">implements</span> <span class="token class-name">DataStorage</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ã€Mysqlã€‘æœç´¢&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;ï¼Œç»“æœï¼šNo&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Redis æŸ¥è¯¢ MOCK ç±»</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>spi</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisStorage</span> <span class="token keyword">implements</span> <span class="token class-name">DataStorage</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ã€Redisã€‘æœç´¢&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;ï¼Œç»“æœï¼šYes&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå®šä¹‰æ¥å£ï¼Œå¹¶å®ç°æ¥å£å’Œæ™®é€šçš„ Java æ¥å£å®ç°æ²¡æœ‰ä»»ä½•ä¸åŒã€‚</p> <h3 id="spi-é…ç½®"><a href="#spi-é…ç½®" class="header-anchor">#</a> SPI é…ç½®</h3> <p>å¦‚æœæƒ³é€šè¿‡ Java SPI æœºåˆ¶æ¥å‘ç°æœåŠ¡ï¼Œå°±éœ€è¦åœ¨ SPI é…ç½®ä¸­çº¦å®šå¥½å‘ç°æœåŠ¡çš„é€»è¾‘ã€‚é…ç½®æ–‡ä»¶å¿…é¡»ç½®äº <code>META-INF/services</code> ç›®å½•ä¸­ï¼Œå¹¶ä¸”ï¼Œæ–‡ä»¶ååº”ä¸æœåŠ¡æä¾›è€…æ¥å£çš„å®Œå…¨é™å®šåä¿æŒä¸€è‡´ã€‚æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œéƒ½æœ‰ä¸€ä¸ªå®ç°æœåŠ¡ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒæ ·æ˜¯æœåŠ¡æä¾›è€…ç±»çš„å®Œå…¨é™å®šåç§°ã€‚ä»¥æœ¬ç¤ºä¾‹ä»£ç ä¸ºä¾‹ï¼Œå…¶æ–‡ä»¶ååº”è¯¥ä¸º <code>io.github.dunwu.javacore.spi.DataStorage</code>ï¼Œæ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>io.github.dunwu.javacore.spi.MysqlStorage
io.github.dunwu.javacore.spi.RedisStorage
</code></pre></div><h3 id="serviceloader"><a href="#serviceloader" class="header-anchor">#</a> ServiceLoader</h3> <p>å®Œæˆäº†ä¸Šé¢çš„æ­¥éª¤ï¼Œå°±å¯ä»¥é€šè¿‡ <code>ServiceLoader</code> æ¥åŠ è½½æœåŠ¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ServiceLoader</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpiDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataStorage</span><span class="token punctuation">&gt;</span></span> serviceLoader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">DataStorage</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;============ Java SPI æµ‹è¯•============&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceLoader<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>loader <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token string">&quot;Yes Or No&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è¾“å‡ºï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>============ Java SPI æµ‹è¯•============
ã€Mysqlã€‘æœç´¢Yes Or Noï¼Œç»“æœï¼šNo
ã€Redisã€‘æœç´¢Yes Or Noï¼Œç»“æœï¼šYes
</code></pre></div><h2 id="spi-åŸç†"><a href="#spi-åŸç†" class="header-anchor">#</a> SPI åŸç†</h2> <p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£ Java SPI çš„è¦ç´ ä»¥åŠä½¿ç”¨ Java SPI çš„æ–¹æ³•ã€‚ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼ŒJava SPI å’Œæ™®é€š Java æ¥å£æœ‰ä½•ä¸åŒï¼ŒJava SPI æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å®é™…ä¸Šï¼ŒJava SPI æœºåˆ¶ä¾èµ–äº <code>ServiceLoader</code> ç±»å»è§£æã€åŠ è½½æœåŠ¡ã€‚å› æ­¤ï¼ŒæŒæ¡äº† <code>ServiceLoader</code> çš„å·¥ä½œæµç¨‹ï¼Œå°±æŒæ¡äº† SPI çš„åŸç†ã€‚<code>ServiceLoader</code> çš„ä»£ç æœ¬èº«å¾ˆç²¾ç»ƒï¼Œæ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬é€šè¿‡èµ°è¯»æºç çš„æ–¹å¼ï¼Œé€ä¸€ç†è§£ <code>ServiceLoader</code> çš„å·¥ä½œæµç¨‹ã€‚</p> <h3 id="serviceloader-çš„æˆå‘˜å˜é‡"><a href="#serviceloader-çš„æˆå‘˜å˜é‡" class="header-anchor">#</a> ServiceLoader çš„æˆå‘˜å˜é‡</h3> <p>å…ˆçœ‹ä¸€ä¸‹ <code>ServiceLoader</code> ç±»çš„æˆå‘˜å˜é‡ï¼Œå¤§è‡´æœ‰ä¸ªå°è±¡ï¼Œåé¢çš„æºç ä¸­éƒ½ä¼šä½¿ç”¨åˆ°ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">// SPI é…ç½®æ–‡ä»¶ç›®å½•</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;META-INF/services/&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// å°†è¦è¢«åŠ è½½çš„ SPI æœåŠ¡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">;</span>

    <span class="token comment">// ç”¨äºåŠ è½½ SPI æœåŠ¡çš„ç±»åŠ è½½å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">;</span>

    <span class="token comment">// ServiceLoader åˆ›å»ºæ—¶çš„è®¿é—®æ§åˆ¶ä¸Šä¸‹æ–‡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">;</span>

    <span class="token comment">// SPI æœåŠ¡ç¼“å­˜ï¼ŒæŒ‰å®ä¾‹åŒ–çš„é¡ºåºæ’åˆ—</span>
    <span class="token keyword">private</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ‡’æŸ¥è¯¢è¿­ä»£å™¨</span>
    <span class="token keyword">private</span> <span class="token class-name">LazyIterator</span> lookupIterator<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="serviceloader-çš„å·¥ä½œæµç¨‹"><a href="#serviceloader-çš„å·¥ä½œæµç¨‹" class="header-anchor">#</a> ServiceLoader çš„å·¥ä½œæµç¨‹</h3> <p>ï¼ˆ1ï¼‰<code>ServiceLoader.load</code> é™æ€æ–¹æ³•</p> <p>åº”ç”¨ç¨‹åºåŠ è½½ Java SPI æœåŠ¡ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨ <code>ServiceLoader.load</code> é™æ€æ–¹æ³•ã€‚<code>ServiceLoader.load</code> é™æ€æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼š</p> <ol><li>æŒ‡å®šç±»åŠ è½½ <code>ClassLoader</code> å’Œè®¿é—®æ§åˆ¶ä¸Šä¸‹æ–‡ï¼›</li> <li>ç„¶åï¼Œé‡æ–°åŠ è½½ SPI æœåŠ¡
<ol><li>æ¸…ç©ºç¼“å­˜ä¸­æ‰€æœ‰å·²å®ä¾‹åŒ–çš„ SPI æœåŠ¡</li> <li>æ ¹æ® <code>ClassLoader</code> å’Œ SPI ç±»å‹ï¼Œåˆ›å»ºæ‡’åŠ è½½è¿­ä»£å™¨</li></ol></li></ol> <p>è¿™é‡Œï¼Œæ‘˜å½• <code>ServiceLoader.load</code> ç›¸å…³æºç ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// service ä¼ å…¥çš„æ˜¯æœŸæœ›åŠ è½½çš„ SPI æ¥å£ç±»å‹</span>
<span class="token comment">// loader æ˜¯ç”¨äºåŠ è½½ SPI æœåŠ¡çš„ç±»åŠ è½½å™¨</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span>
										<span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¸…ç©ºç¼“å­˜ä¸­æ‰€æœ‰å·²å®ä¾‹åŒ–çš„ SPI æœåŠ¡</span>
	providers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¹æ® ClassLoader å’Œ SPI ç±»å‹ï¼Œåˆ›å»ºæ‡’åŠ è½½è¿­ä»£å™¨</span>
	lookupIterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyIterator</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç§æœ‰æ„é€ æ–¹æ³•</span>
<span class="token comment">// é‡æ–°åŠ è½½ SPI æœåŠ¡</span>
<span class="token keyword">private</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> svc<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> cl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	service <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>svc<span class="token punctuation">,</span> <span class="token string">&quot;Service interface cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æŒ‡å®šç±»åŠ è½½ ClassLoader å’Œè®¿é—®æ§åˆ¶ä¸Šä¸‹æ–‡</span>
	loader <span class="token operator">=</span> <span class="token punctuation">(</span>cl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> cl<span class="token punctuation">;</span>
	acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ç„¶åï¼Œé‡æ–°åŠ è½½ SPI æœåŠ¡</span>
	<span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ï¼ˆ2ï¼‰åº”ç”¨ç¨‹åºé€šè¿‡ <code>ServiceLoader</code> çš„ <code>iterator</code> æ–¹æ³•éå† SPI å®ä¾‹</p> <p><code>ServiceLoader</code> çš„ç±»å®šä¹‰ï¼Œæ˜ç¡®äº† <code>ServiceLoader</code> ç±»å®ç°äº† <code>Iterable&lt;T&gt;</code> æ¥å£ï¼Œæ‰€ä»¥ï¼Œå®ƒæ˜¯å¯ä»¥è¿­ä»£éå†çš„ã€‚å®é™…ä¸Šï¼Œ<code>ServiceLoader</code> ç±»ç»´æŠ¤äº†ä¸€ä¸ªç¼“å­˜ providersï¼ˆ <code>LinkedHashMap</code> å¯¹è±¡ï¼‰ï¼Œç¼“å­˜ providers ä¸­ä¿å­˜äº†å·²ç»è¢«æˆåŠŸåŠ è½½çš„ SPI å®ä¾‹ï¼Œè¿™ä¸ª Map çš„ key æ˜¯ SPI æ¥å£å®ç°ç±»çš„å…¨é™å®šåï¼Œvalue æ˜¯è¯¥å®ç°ç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</p> <p>å½“åº”ç”¨ç¨‹åºè°ƒç”¨ <code>ServiceLoader</code> çš„ <code>iterator</code> æ–¹æ³•æ—¶ï¼Œ<code>ServiceLoader</code> ä¼šå…ˆåˆ¤æ–­ç¼“å­˜ providers ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼šå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜ providers çš„è¿­ä»£å™¨ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›æ‡’åŠ è½½è¿­ä»£å™¨çš„è¿­ä»£å™¨ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// ç¼“å­˜ SPI providers</span>
		<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> knownProviders
			<span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// lookupIterator æ˜¯ LazyIterator å®ä¾‹ï¼Œç”¨äºæ‡’åŠ è½½ SPI å®ä¾‹</span>
		<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>knownProviders<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> lookupIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>knownProviders<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> knownProviders<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> lookupIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ï¼ˆ3ï¼‰æ‡’åŠ è½½è¿­ä»£å™¨çš„å·¥ä½œæµç¨‹</p> <p>ä¸Šé¢çš„æºç ä¸­æåˆ°äº†ï¼ŒlookupIterator æ˜¯ <code>LazyIterator</code> å®ä¾‹ï¼Œè€Œ <code>LazyIterator</code> ç”¨äºæ‡’åŠ è½½ SPI å®ä¾‹ã€‚é‚£ä¹ˆï¼Œ <code>LazyIterator</code> æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</p> <p>è¿™é‡Œï¼Œæ‘˜å– <code>LazyIterator</code> å…³é”®ä»£ç </p> <ul><li><code>hasNextService</code> æ–¹æ³•ï¼š
<ol><li>æ‹¼æ¥ <code>META-INF/services/</code> + SPI æ¥å£å…¨é™å®šå</li> <li>é€šè¿‡ç±»åŠ è½½å™¨ï¼Œå°è¯•åŠ è½½èµ„æºæ–‡ä»¶</li> <li>è§£æèµ„æºæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œè·å– SPI æ¥å£çš„å®ç°ç±»çš„å…¨é™å®šå <code>nextName</code></li></ol></li> <li><code>nextService</code> æ–¹æ³•ï¼š
<ol><li><code>hasNextService()</code> æ–¹æ³•è§£æå‡ºäº† SPI å®ç°ç±»çš„çš„å…¨é™å®šå <code>nextName</code>ï¼Œé€šè¿‡åå°„ï¼Œè·å– SPI å®ç°ç±»çš„ç±»å®šä¹‰ <code>Class&lt;?&gt;</code>ã€‚</li> <li>ç„¶åï¼Œå°è¯•é€šè¿‡ <code>Class&lt;?&gt;</code> çš„ <code>newInstance</code> æ–¹æ³•å®ä¾‹åŒ–ä¸€ä¸ª SPI æœåŠ¡å¯¹è±¡ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™å°†è¿™ä¸ªå¯¹è±¡åŠ å…¥åˆ°ç¼“å­˜ providers ä¸­å¹¶è¿”å›è¯¥å¯¹è±¡ã€‚</li></ol></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>nextName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.æ‹¼æ¥ META-INF/services/ + SPI æ¥å£å…¨é™å®šå</span>
            <span class="token comment">// 2.é€šè¿‡ç±»åŠ è½½å™¨ï¼Œå°è¯•åŠ è½½èµ„æºæ–‡ä»¶</span>
            <span class="token comment">// 3.è§£æèµ„æºæ–‡ä»¶ä¸­çš„å†…å®¹</span>
			<span class="token class-name">String</span> fullName <span class="token operator">=</span> <span class="token constant">PREFIX</span> <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
				configs <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				configs <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Error locating configuration files&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>pending<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configs<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		pending <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	nextName <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">S</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> cn <span class="token operator">=</span> nextName<span class="token punctuation">;</span>
	nextName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>
			 <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn <span class="token operator">+</span> <span class="token string">&quot; not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>service<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>
			 <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn  <span class="token operator">+</span> <span class="token string">&quot; not a s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token class-name">S</span> p <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		providers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> p<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>
			 <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn <span class="token operator">+</span> <span class="token string">&quot; could not be instantiated&quot;</span><span class="token punctuation">,</span>
			 x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// This cannot happen</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="spi-å’Œç±»åŠ è½½å™¨"><a href="#spi-å’Œç±»åŠ è½½å™¨" class="header-anchor">#</a> SPI å’Œç±»åŠ è½½å™¨</h3> <p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªç« èŠ‚ä¸­ï¼Œèµ°è¯» <code>ServiceLoader</code> ä»£ç ï¼Œæˆ‘ä»¬å·²ç»å¤§è‡´äº†è§£ Java SPI çš„å·¥ä½œåŸç†ï¼Œå³é€šè¿‡ <code>ClassLoader</code> åŠ è½½ SPI é…ç½®æ–‡ä»¶ï¼Œè§£æ SPI æœåŠ¡ï¼Œç„¶åé€šè¿‡åå°„ï¼Œå®ä¾‹åŒ– SPI æœåŠ¡å®ä¾‹ã€‚æˆ‘ä»¬ä¸å¦¨æ€è€ƒä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆåŠ è½½ SPI æœåŠ¡æ—¶ï¼Œéœ€è¦æŒ‡å®šç±»åŠ è½½å™¨ <code>ClassLoader</code> å‘¢ï¼Ÿ</p> <p>å­¦ä¹ è¿‡ JVM çš„è¯»è€…ï¼Œæƒ³å¿…éƒ½äº†è§£è¿‡ç±»åŠ è½½å™¨çš„<strong>åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParents Delegation Modelï¼‰</strong>ã€‚åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„ <strong><code>BootstrapClassLoader</code></strong> å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™é‡Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬é€šè¿‡ç»„åˆï¼ˆCompositionï¼‰å…³ç³»æ¥å®ç°ï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿ï¼ˆInheritanceï¼‰çš„å…³ç³»å®ç°ã€‚åŒäº²å§”æ´¾ç»§æ‰¿ä½“ç³»å›¾å¦‚ä¸‹ï¼š</p> <img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/jvm/jmm-%E7%B1%BB%E5%8A%A0%E8%BD%BD-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE.png" alt="img" style="zoom:50%;"> <p>åŒäº²å§”æ´¾æœºåˆ¶çº¦å®šäº†ï¼š<strong>ä¸€ä¸ªç±»åŠ è½½å™¨é¦–å…ˆå°†ç±»åŠ è½½è¯·æ±‚ä¼ é€åˆ°çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆç±»åŠ è½½è¯·æ±‚æ—¶æ‰å°è¯•åŠ è½½</strong>ã€‚</p> <p><strong>åŒäº²å§”æ´¾çš„å¥½å¤„</strong>ï¼šä½¿å¾— Java ç±»ä¼´éšç€å®ƒçš„ç±»åŠ è½½å™¨ï¼Œå¤©ç„¶å…·å¤‡ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ï¼Œä»è€Œä½¿å¾—ç±»åŠ è½½å¾—åˆ°ç»Ÿä¸€ï¼Œä¸ä¼šå‡ºç°é‡å¤åŠ è½½çš„é—®é¢˜ï¼š</p> <ul><li>ç³»ç»Ÿç±»é˜²æ­¢å†…å­˜ä¸­å‡ºç°å¤šä»½åŒæ ·çš„å­—èŠ‚ç </li> <li>ä¿è¯ Java ç¨‹åºå®‰å…¨ç¨³å®šè¿è¡Œ</li></ul> <p>ä¾‹å¦‚ï¼š <code>java.lang.Object</code> å­˜æ”¾åœ¨ <code>rt.jar</code> ä¸­ï¼Œå¦‚æœç¼–å†™å¦å¤–ä¸€ä¸ª <code>java.lang.Object</code> çš„ç±»å¹¶æ”¾åˆ° <code>classpath</code> ä¸­ï¼Œç¨‹åºå¯ä»¥ç¼–è¯‘é€šè¿‡ã€‚å› ä¸ºåŒäº²å§”æ´¾æ¨¡å‹çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨ rt.jar ä¸­çš„ <code>Object</code> æ¯”åœ¨ <code>classpath</code> ä¸­çš„ <code>Object</code> ä¼˜å…ˆçº§æ›´é«˜ï¼Œå› ä¸º rt.jar ä¸­çš„ <code>Object</code> ä½¿ç”¨çš„æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè€Œ <code>classpath</code> ä¸­çš„ <code>Object</code> ä½¿ç”¨çš„æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚æ­£å› ä¸º rt.jar ä¸­çš„ <code>Object</code> ä¼˜å…ˆçº§æ›´é«˜ï¼Œå› ä¸ºç¨‹åºä¸­æ‰€æœ‰çš„ <code>Object</code> éƒ½æ˜¯è¿™ä¸ª <code>Object</code>ã€‚</p> <p><strong>åŒäº²å§”æ´¾çš„é™åˆ¶</strong>ï¼šå­ç±»åŠ è½½å™¨å¯ä»¥ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨å·²ç»åŠ è½½çš„ç±»ï¼Œè€Œçˆ¶ç±»åŠ è½½å™¨æ— æ³•ä½¿ç”¨å­ç±»åŠ è½½å™¨å·²ç»åŠ è½½çš„ã€‚â€”â€”è¿™å°±å¯¼è‡´äº†åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„ç±»åŠ è½½å™¨é—®é¢˜ã€‚Java SPI å°±é¢ä¸´ç€è¿™æ ·çš„é—®é¢˜ï¼š</p> <ul><li>SPI çš„æ¥å£æ˜¯ Java æ ¸å¿ƒåº“çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ç”± <code>BootstrapClassLoader</code> åŠ è½½çš„ï¼›</li> <li>è€Œ SPI å®ç°çš„ Java ç±»ä¸€èˆ¬æ˜¯ç”± <code>AppClassLoader</code> æ¥åŠ è½½çš„ã€‚<code>BootstrapClassLoader</code> æ˜¯æ— æ³•æ‰¾åˆ° SPI çš„å®ç°ç±»çš„ï¼Œå› ä¸ºå®ƒåªåŠ è½½ Java çš„æ ¸å¿ƒåº“ã€‚å®ƒä¹Ÿä¸èƒ½ä»£ç†ç»™ <code>AppClassLoader</code>ï¼Œå› ä¸ºå®ƒæ˜¯æœ€é¡¶å±‚çš„ç±»åŠ è½½å™¨ã€‚è¿™ä¹Ÿè§£é‡Šäº†æœ¬èŠ‚å¼€å§‹çš„é—®é¢˜â€”â€”ä¸ºä»€ä¹ˆåŠ è½½ SPI æœåŠ¡æ—¶ï¼Œéœ€è¦æŒ‡å®šç±»åŠ è½½å™¨ <code>ClassLoader</code> å‘¢ï¼Ÿå› ä¸ºå¦‚æœä¸æŒ‡å®š <code>ClassLoader</code>ï¼Œåˆ™æ— æ³•è·å– SPI æœåŠ¡ã€‚</li></ul> <p>å¦‚æœä¸åšä»»ä½•çš„è®¾ç½®ï¼ŒJava åº”ç”¨çš„çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯ <code>AppClassLoader</code>ã€‚åœ¨æ ¸å¿ƒç±»åº“ä½¿ç”¨ SPI æ¥å£æ—¶ï¼Œä¼ é€’çš„ç±»åŠ è½½å™¨ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå°±å¯ä»¥æˆåŠŸçš„åŠ è½½åˆ° SPI å®ç°çš„ç±»ã€‚çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åœ¨å¾ˆå¤š SPI çš„å®ç°ä¸­éƒ½ä¼šç”¨åˆ°ã€‚</p> <p>é€šå¸¸å¯ä»¥é€šè¿‡ <code>Thread.currentThread().getClassLoader()</code> å’Œ <code>Thread.currentThread().getContextClassLoader()</code> è·å–çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚</p> <h3 id="java-spi-çš„ä¸è¶³"><a href="#java-spi-çš„ä¸è¶³" class="header-anchor">#</a> Java SPI çš„ä¸è¶³</h3> <p>Java SPI å­˜åœ¨ä¸€äº›ä¸è¶³ï¼š</p> <ul><li><p>ä¸èƒ½æŒ‰éœ€åŠ è½½ï¼Œéœ€è¦éå†æ‰€æœ‰çš„å®ç°ï¼Œå¹¶å®ä¾‹åŒ–ï¼Œç„¶ååœ¨å¾ªç¯ä¸­æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„å®ç°ã€‚å¦‚æœä¸æƒ³ç”¨æŸäº›å®ç°ç±»ï¼Œæˆ–è€…æŸäº›ç±»å®ä¾‹åŒ–å¾ˆè€—æ—¶ï¼Œå®ƒä¹Ÿè¢«è½½å…¥å¹¶å®ä¾‹åŒ–äº†ï¼Œè¿™å°±é€ æˆäº†æµªè´¹ã€‚</p></li> <li><p>è·å–æŸä¸ªå®ç°ç±»çš„æ–¹å¼ä¸å¤Ÿçµæ´»ï¼Œåªèƒ½é€šè¿‡ Iterator å½¢å¼è·å–ï¼Œä¸èƒ½æ ¹æ®æŸä¸ªå‚æ•°æ¥è·å–å¯¹åº”çš„å®ç°ç±»ã€‚</p></li> <li><p>å¤šä¸ªå¹¶å‘å¤šçº¿ç¨‹ä½¿ç”¨ ServiceLoader ç±»çš„å®ä¾‹æ˜¯ä¸å®‰å…¨çš„ã€‚</p></li></ul> <h2 id="spi-åº”ç”¨åœºæ™¯"><a href="#spi-åº”ç”¨åœºæ™¯" class="header-anchor">#</a> SPI åº”ç”¨åœºæ™¯</h2> <p>SPI åœ¨ Java å¼€å‘ä¸­åº”ç”¨ååˆ†å¹¿æ³›ã€‚é¦–å…ˆï¼Œåœ¨ Java çš„ <code>java.util.spi</code> package ä¸­å°±çº¦å®šäº†å¾ˆå¤š SPI æ¥å£ã€‚ä¸‹é¢ï¼Œåˆ—ä¸¾ä¸€äº› SPI æ¥å£ï¼š</p> <ul><li><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/spi/TimeZoneNameProvider.html" target="_blank" rel="noopener noreferrer"><em>TimeZoneNameProvider:</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä¸º TimeZone ç±»æä¾›æœ¬åœ°åŒ–çš„æ—¶åŒºåç§°ã€‚</li> <li><em><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/text/spi/DateFormatProvider.html" target="_blank" rel="noopener noreferrer">DateFormatProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</em> ä¸ºæŒ‡å®šçš„è¯­è¨€ç¯å¢ƒæä¾›æ—¥æœŸå’Œæ—¶é—´æ ¼å¼ã€‚</li> <li><em><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/text/spi/NumberFormatProvider.html" target="_blank" rel="noopener noreferrer">NumberFormatProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</em> ä¸º NumberFormat ç±»æä¾›è´§å¸ã€æ•´æ•°å’Œç™¾åˆ†æ¯”å€¼ã€‚</li> <li><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.sql/java/sql/Driver.html" target="_blank" rel="noopener noreferrer"><em>Driver:</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä» 4.0 ç‰ˆå¼€å§‹ï¼ŒJDBC API æ”¯æŒ SPI æ¨¡å¼ã€‚æ—§ç‰ˆæœ¬ä½¿ç”¨ Class.forName() æ–¹æ³•åŠ è½½é©±åŠ¨ç¨‹åºã€‚</li> <li><a href="https://docs.oracle.com/javaee/7/api/javax/persistence/spi/PersistenceProvider.html" target="_blank" rel="noopener noreferrer"><em>PersistenceProvider:</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> æä¾› JPA API çš„å®ç°ã€‚</li> <li>ç­‰ç­‰</li></ul> <p>é™¤æ­¤ä»¥å¤–ï¼ŒSPI è¿˜æœ‰å¾ˆå¤šåº”ç”¨ï¼Œä¸‹é¢åˆ—ä¸¾å‡ ä¸ªç»å…¸æ¡ˆä¾‹ã€‚</p> <h3 id="spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-jdbc-drivermanager"><a href="#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-jdbc-drivermanager" class="header-anchor">#</a> SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ JDBC DriverManager</h3> <p>ä½œä¸º Java å·¥ç¨‹å¸ˆï¼Œå°¤å…¶æ˜¯ CRUD å·¥ç¨‹å¸ˆï¼Œç›¸å¿…éƒ½éå¸¸ç†Ÿæ‚‰ JDBCã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œå…³ç³»å‹æ•°æ®åº“æœ‰å¾ˆå¤šç§ï¼Œå¦‚ï¼šMysqlã€Oracleã€PostgreSQL ç­‰ç­‰ã€‚JDBC å¦‚ä½•è¯†åˆ«å„ç§æ•°æ®åº“çš„é©±åŠ¨å‘¢ï¼Ÿ</p> <h4 id="åˆ›å»ºæ•°æ®åº“è¿æ¥"><a href="#åˆ›å»ºæ•°æ®åº“è¿æ¥" class="header-anchor">#</a> åˆ›å»ºæ•°æ®åº“è¿æ¥</h4> <p>æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ï¼ŒJDBC å¦‚ä½•åˆ›å»ºæ•°æ®åº“è¿æ¥çš„å‘¢ï¼Ÿ</p> <p>åœ¨ <strong>JDBC4.0 ä¹‹å‰</strong>ï¼Œè¿æ¥æ•°æ®åº“çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šç”¨ <strong><code>Class.forName(XXX)</code></strong> æ–¹æ³•æ¥åŠ è½½æ•°æ®åº“ç›¸åº”çš„é©±åŠ¨ï¼Œç„¶åå†è·å–æ•°æ®åº“è¿æ¥ï¼Œç»§è€Œè¿›è¡Œ CRUD ç­‰æ“ä½œã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>è€Œ J<strong>DBC4.0 ä¹‹å</strong>ï¼Œä¸å†éœ€è¦ç”¨ <strong><code>Class.forName(XXX)</code></strong> æ–¹æ³•æ¥åŠ è½½æ•°æ®åº“é©±åŠ¨ï¼Œç›´æ¥è·å–è¿æ¥å°±å¯ä»¥äº†ã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p> <ul><li><p>JDBC æ¥å£ï¼šé¦–å…ˆï¼ŒJava ä¸­å†…ç½®äº†æ¥å£ <code>java.sql.Driver</code>ã€‚</p></li> <li><p>JDBC æ¥å£å®ç°ï¼šå„ä¸ªæ•°æ®åº“çš„é©±åŠ¨è‡ªè¡Œå®ç° <code>java.sql.Driver</code> æ¥å£ï¼Œç”¨äºç®¡ç†æ•°æ®åº“è¿æ¥ã€‚</p> <ul><li>Mysqlï¼šåœ¨ mysql çš„ Java é©±åŠ¨åŒ… <code>mysql-connector-java-XXX.jar</code> ä¸­ï¼Œå¯ä»¥æ‰¾åˆ° <code>META-INF/services</code> ç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ªåå­—ä¸º<code>java.sql.Driver</code> çš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯ <code>com.mysql.cj.jdbc.Driver</code>ã€‚ <code>com.mysql.cj.jdbc.Driver</code> æ­£æ˜¯ Mysql ç‰ˆçš„ <code>java.sql.Driver</code> å®ç°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ul> <p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220505201455.png" alt=""></p> <ul><li>PostgreSQL å®ç°ï¼šåœ¨ PostgreSQL çš„ Java é©±åŠ¨åŒ… <code>postgresql-42.0.0.jar</code> ä¸­ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ°åŒæ ·çš„é…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯ <code>org.postgresql.Driver</code>ï¼Œ<code>org.postgresql.Driver</code> æ­£æ˜¯ PostgreSQL ç‰ˆçš„ <code>java.sql.Driver</code> å®ç°ã€‚</li></ul></li> <li><p>åˆ›å»ºæ•°æ®åº“è¿æ¥</p> <p>ä»¥ Mysql ä¸ºä¾‹ï¼Œåˆ›å»ºæ•°æ®åº“è¿æ¥ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DB_URL</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://%s:%s/%s&quot;</span><span class="token punctuation">,</span> <span class="token constant">DB_HOST</span><span class="token punctuation">,</span> <span class="token constant">DB_PORT</span><span class="token punctuation">,</span> <span class="token constant">DB_SCHEMA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token constant">DB_URL</span><span class="token punctuation">,</span> <span class="token constant">DB_USER</span><span class="token punctuation">,</span> <span class="token constant">DB_PASSWORD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h4 id="drivermanager"><a href="#drivermanager" class="header-anchor">#</a> DriverManager</h4> <p>ä»å‰æ–‡ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ <code>DriverManager</code> æ˜¯åˆ›å»ºæ•°æ®åº“è¿æ¥çš„å…³é”®ã€‚å®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</p> <p>å¯ä»¥çœ‹åˆ°æ˜¯åŠ è½½å®ä¾‹åŒ–é©±åŠ¨çš„ï¼Œæ¥ç€çœ‹ loadInitialDrivers æ–¹æ³•ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadInitialDrivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> drivers<span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		drivers <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc.drivers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		drivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// é€šè¿‡ classloader è·å–æ‰€æœ‰å®ç° java.sql.Driver çš„é©±åŠ¨ç±»</span>
	<span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ©ç”¨ SPIï¼Œè®°è½½æ‰€æœ‰ Driver æœåŠ¡</span>
			<span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> loadedDrivers <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–è¿­ä»£å™¨</span>
			<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> driversIterator <span class="token operator">=</span> loadedDrivers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token comment">// éå†è¿­ä»£å™¨</span>
				<span class="token keyword">while</span><span class="token punctuation">(</span>driversIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					driversIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Do nothing</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ‰“å°æ•°æ®åº“é©±åŠ¨ä¿¡æ¯</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;DriverManager.initialize: jdbc.drivers = &quot;</span> <span class="token operator">+</span> drivers<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>drivers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> drivers<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> driversList <span class="token operator">=</span> drivers<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;number of Drivers:&quot;</span> <span class="token operator">+</span> driversList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> aDriver <span class="token operator">:</span> driversList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;DriverManager.Initialize: loading &quot;</span> <span class="token operator">+</span> aDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å°è¯•å®ä¾‹åŒ–é©±åŠ¨</span>
			<span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>aDriver<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;DriverManager.Initialize: load failed: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç ä¸»è¦æ­¥éª¤æ˜¯ï¼š</p> <ol><li>ä»ç³»ç»Ÿå˜é‡ä¸­è·å–é©±åŠ¨çš„å®ç°ç±»ã€‚</li> <li>åˆ©ç”¨ SPI æ¥è·å–æ‰€æœ‰é©±åŠ¨çš„å®ç°ç±»ã€‚</li> <li>éå†æ‰€æœ‰é©±åŠ¨ï¼Œå°è¯•å®ä¾‹åŒ–å„ä¸ªå®ç°ç±»ã€‚</li> <li>æ ¹æ®ç¬¬ 1 æ­¥è·å–åˆ°çš„é©±åŠ¨åˆ—è¡¨æ¥å®ä¾‹åŒ–å…·ä½“çš„å®ç°ç±»ã€‚</li></ol> <p>éœ€è¦å…³æ³¨çš„æ˜¯ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> loadedDrivers <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™é‡Œå®é™…è·å–çš„æ˜¯ <code>java.util.ServiceLoader.LazyIterator</code> è¿­ä»£å™¨ã€‚è°ƒç”¨å…¶ <code>hasNext</code> æ–¹æ³•æ—¶ï¼Œä¼šæœç´¢ classpath ä¸‹ä»¥åŠ jar åŒ…ä¸­çš„ <code>META-INF/services</code> ç›®å½•ï¼ŒæŸ¥æ‰¾ <code>java.sql.Driver</code> æ–‡ä»¶ï¼Œå¹¶æ‰¾åˆ°æ–‡ä»¶ä¸­çš„é©±åŠ¨å®ç°ç±»çš„å…¨é™å®šåã€‚è°ƒç”¨å…¶ <code>next</code> æ–¹æ³•æ—¶ï¼Œä¼šæ ¹æ®é©±åŠ¨ç±»çš„å…¨é™å®šåå»å°è¯•å®ä¾‹åŒ–ä¸€ä¸ªé©±åŠ¨ç±»çš„å¯¹è±¡ã€‚</p> <h3 id="spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-common-logging"><a href="#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-common-logging" class="header-anchor">#</a> SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ Common-Logging</h3> <p>common-loggingï¼ˆä¹Ÿç§° Jakarta Commons Loggingï¼Œç¼©å†™ JCLï¼‰æ˜¯å¸¸ç”¨çš„æ—¥å¿—é—¨é¢å·¥å…·åŒ…ã€‚</p> <p>common-logging çš„æ ¸å¿ƒç±»æ˜¯å…¥å£æ˜¯ <code>LogFactory</code>ï¼Œ<code>LogFatory</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒè´Ÿè´£åŠ è½½å…·ä½“çš„æ—¥å¿—å®ç°ã€‚</p> <p>å…¶å…¥å£æ–¹æ³•æ˜¯ <code>LogFactory.getLog</code> æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Log</span> <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LogConfigurationException</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Log</span> <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LogConfigurationException</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»ä»¥ä¸Šæºç å¯çŸ¥ï¼Œ<code>getLog</code> é‡‡ç”¨äº†å·¥å‚è®¾è®¡æ¨¡å¼ï¼Œæ˜¯å…ˆè°ƒç”¨ <code>getFactory</code> æ–¹æ³•è·å–å…·ä½“æ—¥å¿—åº“çš„å·¥å‚ç±»ï¼Œç„¶åæ ¹æ®ç±»åç§°æˆ–ç±»å‹åˆ›å»ºæ—¥å¿—å®ä¾‹ã€‚</p> <p><code>LogFatory.getFactory</code> æ–¹æ³•è´Ÿè´£é€‰å‡ºåŒ¹é…çš„æ—¥å¿—å·¥å‚ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LogFactory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LogConfigurationException</span> <span class="token punctuation">{</span>
	<span class="token comment">// çœç•¥...</span>

	<span class="token comment">// åŠ è½½ commons-logging.properties é…ç½®æ–‡ä»¶</span>
	<span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token function">getConfigurationFile</span><span class="token punctuation">(</span>contextClassLoader<span class="token punctuation">,</span> <span class="token constant">FACTORY_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// çœç•¥...</span>

    <span class="token comment">// å†³å®šåˆ›å»ºå“ªä¸ª LogFactory å®ä¾‹</span>
	<span class="token comment">// ï¼ˆ1ï¼‰å°è¯•è¯»å–å…¨å±€å±æ€§ org.apache.commons.logging.LogFactory</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] Looking for system property [&quot;</span> <span class="token operator">+</span> <span class="token constant">FACTORY_PROPERTY</span> <span class="token operator">+</span>
					  <span class="token string">&quot;] to define the LogFactory subclass to use...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæŒ‡å®šäº† org.apache.commons.logging.LogFactory å±æ€§ï¼Œå°è¯•å®ä¾‹åŒ–å…·ä½“å®ç°ç±»</span>
		<span class="token class-name">String</span> factoryClass <span class="token operator">=</span> <span class="token function">getSystemProperty</span><span class="token punctuation">(</span><span class="token constant">FACTORY_PROPERTY</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>factoryClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] Creating an instance of LogFactory class '&quot;</span> <span class="token operator">+</span> factoryClass <span class="token operator">+</span>
							  <span class="token string">&quot;' as specified by system property &quot;</span> <span class="token operator">+</span> <span class="token constant">FACTORY_PROPERTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			factory <span class="token operator">=</span> <span class="token function">newFactory</span><span class="token punctuation">(</span>factoryClass<span class="token punctuation">,</span> baseClassLoader<span class="token punctuation">,</span> contextClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] No system property [&quot;</span> <span class="token operator">+</span> <span class="token constant">FACTORY_PROPERTY</span> <span class="token operator">+</span> <span class="token string">&quot;] defined.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">// å¼‚å¸¸å¤„ç†</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">// å¼‚å¸¸å¤„ç†</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// ï¼ˆ2ï¼‰åˆ©ç”¨ Java SPI æœºåˆ¶ï¼Œå°è¯•åœ¨ classpatch çš„ META-INF/services ç›®å½•ä¸‹å¯»æ‰¾ org.apache.commons.logging.LogFactory å®ç°ç±»</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] Looking for a resource file of name [&quot;</span> <span class="token operator">+</span> <span class="token constant">SERVICE_ID</span> <span class="token operator">+</span>
						  <span class="token string">&quot;] to define the LogFactory subclass to use...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>contextClassLoader<span class="token punctuation">,</span> <span class="token constant">SERVICE_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span><span class="token punctuation">(</span> is <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// This code is needed by EBCDIC and other strange systems.</span>
				<span class="token comment">// It's a fix for bugs reported in xerces</span>
				<span class="token class-name">BufferedReader</span> rd<span class="token punctuation">;</span>
				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token class-name">String</span> factoryClassName <span class="token operator">=</span> rd<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				rd<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>factoryClassName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>factoryClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP]  Creating an instance of LogFactory class &quot;</span> <span class="token operator">+</span>
									  factoryClassName <span class="token operator">+</span>
									  <span class="token string">&quot; as specified by file '&quot;</span> <span class="token operator">+</span> <span class="token constant">SERVICE_ID</span> <span class="token operator">+</span>
									  <span class="token string">&quot;' which was present in the path of the context classloader.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					factory <span class="token operator">=</span> <span class="token function">newFactory</span><span class="token punctuation">(</span>factoryClassName<span class="token punctuation">,</span> baseClassLoader<span class="token punctuation">,</span> contextClassLoader <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// is == null</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] No resource file with name '&quot;</span> <span class="token operator">+</span> <span class="token constant">SERVICE_ID</span> <span class="token operator">+</span> <span class="token string">&quot;' found.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// note: if the specified LogFactory class wasn't compatible with LogFactory</span>
			<span class="token comment">// for some reason, a ClassCastException will be caught here, and attempts will</span>
			<span class="token comment">// continue to find a compatible class.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">logDiagnostic</span><span class="token punctuation">(</span>
					<span class="token string">&quot;[LOOKUP] A security exception occurred while trying to create an&quot;</span> <span class="token operator">+</span>
					<span class="token string">&quot; instance of the custom factory class&quot;</span> <span class="token operator">+</span>
					<span class="token string">&quot;: [&quot;</span> <span class="token operator">+</span> <span class="token function">trim</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
					<span class="token string">&quot;]. Trying alternative implementations...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// ignore</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ï¼ˆ3ï¼‰å°è¯•ä» classpath ç›®å½•ä¸‹çš„ commons-logging.properties æ–‡ä»¶ä¸­æŸ¥æ‰¾ org.apache.commons.logging.LogFactory å±æ€§</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">logDiagnostic</span><span class="token punctuation">(</span>
					<span class="token string">&quot;[LOOKUP] Looking in properties file for entry with key '&quot;</span> <span class="token operator">+</span> <span class="token constant">FACTORY_PROPERTY</span> <span class="token operator">+</span>
					<span class="token string">&quot;' to define the LogFactory subclass to use...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">String</span> factoryClass <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token constant">FACTORY_PROPERTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>factoryClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">logDiagnostic</span><span class="token punctuation">(</span>
						<span class="token string">&quot;[LOOKUP] Properties file specifies LogFactory subclass '&quot;</span> <span class="token operator">+</span> factoryClass <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				factory <span class="token operator">=</span> <span class="token function">newFactory</span><span class="token punctuation">(</span>factoryClass<span class="token punctuation">,</span> baseClassLoader<span class="token punctuation">,</span> contextClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// TODO: think about whether we need to handle exceptions from newFactory</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] Properties file has no entry specifying LogFactory subclass.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">logDiagnostic</span><span class="token punctuation">(</span><span class="token string">&quot;[LOOKUP] No properties file available to determine&quot;</span> <span class="token operator">+</span> <span class="token string">&quot; LogFactory subclass from..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ï¼ˆ4ï¼‰ä»¥ä¸Šæƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œå®ä¾‹åŒ–é»˜è®¤å®ç°ç±» org.apache.commons.logging.impl.LogFactoryImpl</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDiagnosticsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">logDiagnostic</span><span class="token punctuation">(</span>
				<span class="token string">&quot;[LOOKUP] Loading the default LogFactory implementation '&quot;</span> <span class="token operator">+</span> <span class="token constant">FACTORY_DEFAULT</span> <span class="token operator">+</span>
				<span class="token string">&quot;' via the same classloader that loaded this LogFactory&quot;</span> <span class="token operator">+</span>
				<span class="token string">&quot; class (ie not looking in the context classloader).&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		factory <span class="token operator">=</span> <span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token constant">FACTORY_DEFAULT</span><span class="token punctuation">,</span> thisClassLoader<span class="token punctuation">,</span> contextClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/**
		 * Always cache using context class loader.
		 */</span>
		<span class="token function">cacheFactory</span><span class="token punctuation">(</span>contextClassLoader<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Enumeration</span> names <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">propertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>names<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> names<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">String</span> value <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
				factory<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> factory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä» getFactory æ–¹æ³•çš„æºç å¯ä»¥çœ‹å‡ºï¼Œå…¶æ ¸å¿ƒé€»è¾‘åˆ†ä¸º 4 æ­¥ï¼š</p> <ol><li>é¦–å…ˆï¼Œå°è¯•æŸ¥æ‰¾å…¨å±€å±æ€§ <code>org.apache.commons.logging.LogFactory</code>ï¼Œå¦‚æœæŒ‡å®šäº†å…·ä½“ç±»ï¼Œå°è¯•åˆ›å»ºå®ä¾‹ã€‚</li> <li>åˆ©ç”¨ Java SPI æœºåˆ¶ï¼Œå°è¯•åœ¨ classpatch çš„ <code>META-INF/services</code> ç›®å½•ä¸‹å¯»æ‰¾ <code>org.apache.commons.logging.LogFactory</code> çš„å®ç°ç±»ã€‚</li> <li>å°è¯•ä» classpath ç›®å½•ä¸‹çš„ <code>commons-logging.properties</code> æ–‡ä»¶ä¸­æŸ¥æ‰¾ <code>org.apache.commons.logging.LogFactory</code> å±æ€§ï¼Œå¦‚æœæŒ‡å®šäº†å…·ä½“ç±»ï¼Œå°è¯•åˆ›å»ºå®ä¾‹ã€‚</li> <li>ä»¥ä¸Šæƒ…å†µå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™å®ä¾‹åŒ–é»˜è®¤å®ç°ç±»ï¼Œå³ <code>org.apache.commons.logging.impl.LogFactoryImpl</code>ã€‚</li></ol> <h3 id="spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-spring-boot"><a href="#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-spring-boot" class="header-anchor">#</a> SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ Spring Boot</h3> <p>Spring Boot æ˜¯åŸºäº Spring æ„å»ºçš„æ¡†æ¶ï¼Œå…¶è®¾è®¡ç›®çš„åœ¨äºç®€åŒ– Spring åº”ç”¨çš„é…ç½®ã€è¿è¡Œã€‚åœ¨ Spring Boot ä¸­ï¼Œå¤§é‡è¿ç”¨äº†è‡ªåŠ¨è£…é…æ¥å°½å¯èƒ½å‡å°‘é…ç½®ã€‚</p> <p>ä¸‹é¢æ˜¯ä¸€ä¸ª Spring Boot å…¥å£ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä»£ç éå¸¸ç®€æ´ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		<span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Hello %s!&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é‚£ä¹ˆï¼ŒSpring Boot æ˜¯å¦‚ä½•åšåˆ°å¯¥å¯¥å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥è¿è¡Œä¸€ä¸ª Spring Boot åº”ç”¨çš„å‘¢ã€‚æˆ‘ä»¬ä¸å¦¨å¸¦ç€ç–‘é—®ï¼Œä»æºç å…¥æ‰‹ï¼Œä¸€æ­¥æ­¥æ¢ç©¶å…¶åŸç†ã€‚</p> <h4 id="springbootapplication-æ³¨è§£"><a href="#springbootapplication-æ³¨è§£" class="header-anchor">#</a> <code>@SpringBootApplication</code> æ³¨è§£</h4> <p>é¦–å…ˆï¼ŒSpring Boot åº”ç”¨çš„å¯åŠ¨ç±»ä¸Šéƒ½ä¼šæ ‡è®°ä¸€ä¸ª <code>@SpringBootApplication</code> æ³¨è§£ã€‚<code>@SpringBootApplication</code> æ³¨è§£å®šä¹‰å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@SpringBootConfiguration</span>
<span class="token annotation punctuation">@EnableAutoConfiguration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>
    excludeFilters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>
    type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">,</span>
    classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">TypeExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>
    type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">,</span>
    classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">AutoConfigurationExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">SpringBootApplication</span> <span class="token punctuation">{</span>
		<span class="token comment">// ç•¥</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é™¤äº† <code>@Target</code>ã€ <code>@Retention</code>ã€<code>@Documented</code>ã€<code>@Inherited</code> è¿™å‡ ä¸ªå…ƒæ³¨è§£ï¼Œ <code>@SpringBootApplication</code> æ³¨è§£çš„å®šä¹‰ä¸­è¿˜æ ‡è®°äº† <code>@SpringBootConfiguration</code>ã€<code>@EnableAutoConfiguration</code>ã€<code>@ComponentScan</code> ä¸‰ä¸ªæ³¨è§£ã€‚</p> <h4 id="springbootconfiguration-æ³¨è§£"><a href="#springbootconfiguration-æ³¨è§£" class="header-anchor">#</a> <code>@SpringBootConfiguration</code> æ³¨è§£</h4> <p>ä»<code>@SpringBootConfiguration</code> æ³¨è§£çš„å®šä¹‰æ¥çœ‹ï¼Œ<code>@SpringBootConfiguration</code> æ³¨è§£æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª <code>@Configuration</code> æ³¨è§£ï¼Œè¿™æ„å‘³ç€è¢«<code>@SpringBootConfiguration</code> æ³¨è§£ä¿®é¥°çš„ç±»ä¼šè¢« Spring Boot è¯†åˆ«ä¸ºä¸€ä¸ªé…ç½®ç±»ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Configuration
public @interface SpringBootConfiguration {
    @AliasFor(
        annotation = Configuration.class
    )
    boolean proxyBeanMethods() default true;
}
</code></pre></div><h4 id="enableautoconfiguration-æ³¨è§£"><a href="#enableautoconfiguration-æ³¨è§£" class="header-anchor">#</a> <code>@EnableAutoConfiguration</code> æ³¨è§£</h4> <p><code>@EnableAutoConfiguration</code> æ³¨è§£å®šä¹‰å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@AutoConfigurationPackage</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">AutoConfigurationImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAutoConfiguration</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token constant">ENABLED_OVERRIDE_PROPERTY</span> <span class="token operator">=</span> <span class="token string">&quot;spring.boot.enableautoconfiguration&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">exclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">excludeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@EnableAutoConfiguration</code> æ³¨è§£åŒ…å«äº† <code>@AutoConfigurationPackage</code> ä¸ <code>@Import({AutoConfigurationImportSelector.class})</code> ä¸¤ä¸ªæ³¨è§£ã€‚</p> <h4 id="autoconfigurationpackage-æ³¨è§£"><a href="#autoconfigurationpackage-æ³¨è§£" class="header-anchor">#</a> <code>@AutoConfigurationPackage</code> æ³¨è§£</h4> <p><code>@AutoConfigurationPackage</code> ä¼šå°†è¢«ä¿®é¥°çš„ç±»ä½œä¸ºä¸»é…ç½®ç±»ï¼Œè¯¥ç±»æ‰€åœ¨çš„ package ä¼šè¢«è§†ä¸ºæ ¹è·¯å¾„ï¼ŒSpring Boot é»˜è®¤ä¼šè‡ªåŠ¨æ‰«ææ ¹è·¯å¾„ä¸‹çš„æ‰€æœ‰ Spring Beanï¼ˆè¢« <code>@Component</code> ä»¥åŠç»§æ‰¿ <code>@Component</code> çš„å„ä¸ªæ³¨è§£æ‰€ä¿®é¥°çš„ç±»ï¼‰ã€‚â€”â€”è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Spring Boot çš„å¯åŠ¨ç±»ä¸€èˆ¬è¦ç½®äºæ ¹è·¯å¾„çš„åŸå› ã€‚è¿™ä¸ªåŠŸèƒ½ç­‰åŒäºåœ¨ Spring xml é…ç½®ä¸­é€šè¿‡ <code>context:component-scan</code> æ¥æŒ‡å®šæ‰«æè·¯å¾„ã€‚<code>@Import</code> æ³¨è§£çš„ä½œç”¨æ˜¯å‘ Spring å®¹å™¨ä¸­ç›´æ¥æ³¨å…¥æŒ‡å®šç»„ä»¶ã€‚<code>@AutoConfigurationPackage</code> æ³¨è§£ä¸­æ³¨æ˜äº† <code>@Import({Registrar.class})</code>ã€‚<code>Registrar</code> ç±»ç”¨äºä¿å­˜ Spring Boot çš„å…¥å£ç±»ã€æ ¹è·¯å¾„ç­‰ä¿¡æ¯ã€‚</p> <h4 id="springfactoriesloader-loadfactorynames-æ–¹æ³•"><a href="#springfactoriesloader-loadfactorynames-æ–¹æ³•" class="header-anchor">#</a> <code>SpringFactoriesLoader.loadFactoryNames</code> æ–¹æ³•</h4> <p><code>@Import(AutoConfigurationImportSelector.class)</code> è¡¨ç¤ºç›´æ¥æ³¨å…¥ <code>AutoConfigurationImportSelector</code>ã€‚<code>AutoConfigurationImportSelector</code> æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³• <code>getCandidateConfigurations</code> ç”¨äºè·å–å€™é€‰é…ç½®ã€‚è¯¥æ–¹æ³•è°ƒç”¨äº† <code>SpringFactoriesLoader.loadFactoryNames</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å³ä¸º Spring Boot SPI çš„å…³é”®ï¼Œå®ƒè´Ÿè´£åŠ è½½æ‰€æœ‰ <code>META-INF/spring.factories</code> æ–‡ä»¶ï¼ŒåŠ è½½çš„è¿‡ç¨‹ç”± <code>SpringFactoriesLoader</code> è´Ÿè´£ã€‚</p> <p>Spring Boot çš„ <code>META-INF/spring.factories</code> æ–‡ä»¶æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª properties æ–‡ä»¶ï¼Œæ•°æ®å†…å®¹å°±æ˜¯ä¸€ä¸ªä¸ªé”®å€¼å¯¹ã€‚</p> <p><code>SpringFactoriesLoader.loadFactoryNames</code> æ–¹æ³•çš„å…³é”®æºç ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// spring.factories æ–‡ä»¶çš„æ ¼å¼ä¸ºï¼škey=value1,value2,value3</span>
<span class="token comment">// éå†æ‰€æœ‰ META-INF/spring.factories æ–‡ä»¶</span>
<span class="token comment">// è§£ææ–‡ä»¶ï¼Œè·å¾— key=factoryClass çš„ç±»åç§°</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadFactoryNames</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factoryType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">String</span> factoryTypeName <span class="token operator">=</span> factoryType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">loadSpringFactories</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>factoryTypeName<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadSpringFactories</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å°è¯•è·å–ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›</span>
	<span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–èµ„æºæ–‡ä»¶è·¯å¾„</span>
		<span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> urls <span class="token operator">=</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
				classLoader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token constant">FACTORIES_RESOURCE_LOCATION</span><span class="token punctuation">)</span> <span class="token operator">:</span>
				<span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span><span class="token constant">FACTORIES_RESOURCE_LOCATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†æ‰€æœ‰è·¯å¾„</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">URL</span> url <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">UrlResource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlResource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£ææ–‡ä»¶ï¼Œå¾—åˆ°å¯¹åº”çš„ä¸€ç»„ Properties</span>
			<span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token class-name">PropertiesLoaderUtils</span><span class="token punctuation">.</span><span class="token function">loadProperties</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// éå†è§£æå‡ºçš„ propertiesï¼Œç»„è£…æ•°æ®</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> factoryTypeName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> factoryImplementationName <span class="token operator">:</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">commaDelimitedListToStringArray</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>factoryTypeName<span class="token punctuation">,</span> factoryImplementationName<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to load factories from location [&quot;</span> <span class="token operator">+</span>
				<span class="token constant">FACTORIES_RESOURCE_LOCATION</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½’çº³ä¸Šé¢çš„æ–¹æ³•ï¼Œä¸»è¦ä½œäº†è¿™äº›äº‹ï¼š</p> <p>åŠ è½½æ‰€æœ‰ <code>META-INF/spring.factories</code> æ–‡ä»¶ï¼ŒåŠ è½½è¿‡ç¨‹æœ‰ <code>SpringFactoriesLoader</code> è´Ÿè´£ã€‚</p> <ul><li>åœ¨ CLASSPATH ä¸­æœå¯»æ‰€æœ‰ <code>META-INF/spring.factories</code> é…ç½®æ–‡ä»¶</li> <li>ç„¶åï¼Œè§£æ <code>spring.factories</code> æ–‡ä»¶ï¼Œè·å–æŒ‡å®šè‡ªåŠ¨è£…é…ç±»çš„å…¨é™å®šå</li></ul> <h4 id="spring-boot-çš„-autoconfiguration-ç±»"><a href="#spring-boot-çš„-autoconfiguration-ç±»" class="header-anchor">#</a> Spring Boot çš„ <code>AutoConfiguration</code> ç±»</h4> <p>Spring Boot æœ‰å„ç§ starter åŒ…ï¼Œå¯ä»¥æ ¹æ®å®é™…é¡¹ç›®éœ€è¦ï¼ŒæŒ‰éœ€å–æã€‚åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œåªè¦å°† starter åŒ…å¼•å…¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å¾ˆå°‘çš„é…ç½®ï¼Œç”šè‡³ä»€ä¹ˆéƒ½ä¸é…ç½®ï¼Œå³å¯è·å–ç›¸å…³çš„èƒ½åŠ›ã€‚é€šè¿‡å‰é¢çš„ Spring Boot SPI æµç¨‹ï¼Œåªå®Œæˆäº†è‡ªåŠ¨è£…é…å·¥ä½œçš„ä¸€åŠï¼Œå‰©ä¸‹çš„å·¥ä½œå¦‚ä½•å¤„ç†å‘¢ ï¼Ÿ</p> <p>ä»¥ spring-boot-starter-web çš„ jar åŒ…ä¸ºä¾‹ï¼ŒæŸ¥çœ‹å…¶ maven pomï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¾èµ–äº spring-boot-starterï¼Œæ‰€æœ‰ Spring Boot å®˜æ–¹ starter åŒ…éƒ½ä¼šä¾èµ–äºè¿™ä¸ª jar åŒ…ã€‚è€Œ spring-boot-starter åˆä¾èµ–äº spring-boot-autoconfigureï¼ŒSpring Boot çš„è‡ªåŠ¨è£…é…ç§˜å¯†ï¼Œå°±åœ¨äºè¿™ä¸ª jar åŒ…ã€‚</p> <p>ä» spring-boot-autoconfigure åŒ…çš„ç»“æ„æ¥çœ‹ï¼Œå®ƒæœ‰ä¸€ä¸ª <code>META-INF/spring.factories</code> ï¼Œæ˜¾ç„¶åˆ©ç”¨äº† Spring Boot SPIï¼Œæ¥è‡ªåŠ¨è£…é…å…¶ä¸­çš„é…ç½®ç±»ã€‚</p> <p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220505004100.png" alt=""></p> <p>ä¸‹å›¾æ˜¯ spring-boot-autoconfigure çš„ <code>META-INF/spring.factories</code> æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­æ³¨å†Œäº†ä¸€é•¿ä¸²ä¼šè¢«è‡ªåŠ¨åŠ è½½çš„ <code>AutoConfiguration</code> ç±»ã€‚</p> <p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220505005130.png" alt=""></p> <p>ä»¥ <code>RedisAutoConfiguration</code> ä¸ºä¾‹ï¼Œè¿™ä¸ªé…ç½®ç±»ä¸­ï¼Œä¼šæ ¹æ® <code>@ConditionalXXX</code> ä¸­çš„æ¡ä»¶å»å†³å®šæ˜¯å¦å®ä¾‹åŒ–å¯¹åº”çš„ Beanï¼Œå®ä¾‹åŒ– Bean æ‰€ä¾èµ–çš„é‡è¦å‚æ•°åˆ™é€šè¿‡ <code>RedisProperties</code> ä¼ å…¥ã€‚</p> <p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220505005548.png" alt=""></p> <p><code>RedisProperties</code> ä¸­ç»´æŠ¤äº† Redis è¿æ¥æ‰€éœ€è¦çš„å…³é”®å±æ€§ï¼Œåªè¦åœ¨ yml æˆ– properties é…ç½®æ–‡ä»¶ä¸­ï¼ŒæŒ‡å®š spring.redis å¼€å¤´çš„å±æ€§ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨è£…è½½åˆ° <code>RedisProperties</code> å®ä¾‹ä¸­ã€‚</p> <p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220505005836.png" alt=""></p> <p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œå·²ç»ä¸€æ­¥æ­¥è§£è¯»å‡º Spring Boot è‡ªåŠ¨è£…è½½çš„åŸç†ã€‚</p> <h2 id="spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-dubbo"><a href="#spi-åº”ç”¨æ¡ˆä¾‹ä¹‹-dubbo" class="header-anchor">#</a> SPI åº”ç”¨æ¡ˆä¾‹ä¹‹ Dubbo</h2> <p>Dubbo å¹¶æœªä½¿ç”¨ Java SPIï¼Œè€Œæ˜¯è‡ªå·±å°è£…äº†ä¸€å¥—æ–°çš„ SPI æœºåˆ¶ã€‚Dubbo SPI æ‰€éœ€çš„é…ç½®æ–‡ä»¶éœ€æ”¾ç½®åœ¨ <code>META-INF/dubbo</code> è·¯å¾„ä¸‹ï¼Œé…ç½®å†…å®¹å½¢å¼å¦‚ä¸‹ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>optimusPrime = org.apache.spi.OptimusPrime
bumblebee = org.apache.spi.Bumblebee
</code></pre></div><p>ä¸ Java SPI å®ç°ç±»é…ç½®ä¸åŒï¼ŒDubbo SPI æ˜¯<strong>é€šè¿‡é”®å€¼å¯¹çš„æ–¹å¼è¿›è¡Œé…ç½®</strong>ï¼Œè¿™æ ·å¯ä»¥<strong>æŒ‰éœ€åŠ è½½</strong>æŒ‡å®šçš„å®ç°ç±»ã€‚Dubbo SPI é™¤äº†æ”¯æŒæŒ‰éœ€åŠ è½½æ¥å£å®ç°ç±»ï¼Œè¿˜å¢åŠ äº† IOC å’Œ AOP ç­‰ç‰¹æ€§ã€‚</p> <h4 id="extensionloader-å…¥å£"><a href="#extensionloader-å…¥å£" class="header-anchor">#</a> <code>ExtensionLoader</code> å…¥å£</h4> <p>Dubbo SPI çš„ç›¸å…³é€»è¾‘è¢«å°è£…åœ¨äº† <code>ExtensionLoader</code> ç±»ä¸­ï¼Œé€šè¿‡ <code>ExtensionLoader</code>ï¼Œå¯ä»¥åŠ è½½æŒ‡å®šçš„å®ç°ç±»ã€‚</p> <p><code>ExtensionLoader</code> çš„ <code>getExtension</code> æ–¹æ³•æ˜¯å…¶å…¥å£æ–¹æ³•ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Extension name == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–é»˜è®¤çš„æ‹“å±•å®ç°ç±»</span>
        <span class="token keyword">return</span> <span class="token function">getDefaultExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Holderï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨äºæŒæœ‰ç›®æ ‡å¯¹è±¡</span>
    <span class="token class-name">Holder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> holder <span class="token operator">=</span> cachedInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cachedInstances<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Holder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        holder <span class="token operator">=</span> cachedInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> instance <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŒé‡æ£€æŸ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åˆ›å»ºæ‹“å±•å®ä¾‹</span>
                instance <span class="token operator">=</span> <span class="token function">createExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è®¾ç½®å®ä¾‹åˆ° holder ä¸­</span>
                holder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ï¼šé¦–å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­åˆ™è°ƒç”¨ <code>createExtension</code> æ–¹æ³•åˆ›å»ºæ‹“å±•å¯¹è±¡ã€‚é‚£ä¹ˆï¼Œ<code>createExtension</code> æ˜¯å¦‚ä½•åˆ›å»ºæ‹“å±•å¯¹è±¡çš„å‘¢ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æ‰€æœ‰çš„æ‹“å±•ç±»ï¼Œå¯å¾—åˆ°â€œé…ç½®é¡¹åç§°â€åˆ°â€œé…ç½®ç±»â€çš„æ˜ å°„å…³ç³»è¡¨</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token function">getExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">findException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">T</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token constant">EXTENSION_INSTANCES</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é€šè¿‡åå°„åˆ›å»ºå®ä¾‹</span>
            <span class="token constant">EXTENSION_INSTANCES</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token constant">EXTENSION_INSTANCES</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å‘å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–</span>
        <span class="token function">injectExtension</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wrapperClasses <span class="token operator">=</span> cachedWrapperClasses<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapperClasses <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wrapperClasses<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¾ªç¯åˆ›å»º Wrapper å®ä¾‹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> wrapperClass <span class="token operator">:</span> wrapperClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å°†å½“å‰ instance ä½œä¸ºå‚æ•°ä¼ ç»™ Wrapper çš„æ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡åå°„åˆ›å»º Wrapper å®ä¾‹ã€‚</span>
                <span class="token comment">// ç„¶åå‘ Wrapper å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–ï¼Œæœ€åå°† Wrapper å®ä¾‹å†æ¬¡èµ‹å€¼ç»™ instance å˜é‡</span>
                instance <span class="token operator">=</span> <span class="token function">injectExtension</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> wrapperClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createExtension</code> æ–¹æ³•çš„çš„å·¥ä½œæ­¥éª¤å¯ä»¥å½’çº³ä¸ºï¼š</p> <ol><li>é€šè¿‡ <code>getExtensionClasses</code> è·å–æ‰€æœ‰çš„æ‹“å±•ç±»</li> <li>é€šè¿‡åå°„åˆ›å»ºæ‹“å±•å¯¹è±¡</li> <li>å‘æ‹“å±•å¯¹è±¡ä¸­æ³¨å…¥ä¾èµ–</li> <li>å°†æ‹“å±•å¯¹è±¡åŒ…è£¹åœ¨ç›¸åº”çš„ <code>Wrapper</code> å¯¹è±¡ä¸­</li></ol> <p>ä»¥ä¸Šæ­¥éª¤ä¸­ï¼Œç¬¬ä¸€ä¸ªæ­¥éª¤æ˜¯åŠ è½½æ‹“å±•ç±»çš„å…³é”®ï¼Œç¬¬ä¸‰å’Œç¬¬å››ä¸ªæ­¥éª¤æ˜¯ Dubbo IOC ä¸ AOP çš„å…·ä½“å®ç°ã€‚</p> <h4 id="è·å–æ‰€æœ‰çš„æ‹“å±•ç±»"><a href="#è·å–æ‰€æœ‰çš„æ‹“å±•ç±»" class="header-anchor">#</a> è·å–æ‰€æœ‰çš„æ‹“å±•ç±»</h4> <p>Dubbo åœ¨é€šè¿‡åç§°è·å–æ‹“å±•ç±»ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æ ¹æ®é…ç½®æ–‡ä»¶è§£æå‡ºæ‹“å±•é¡¹åç§°åˆ°æ‹“å±•ç±»çš„æ˜ å°„å…³ç³»è¡¨ï¼ˆMap&lt;åç§°, æ‹“å±•ç±»&gt;ï¼‰ï¼Œä¹‹åå†æ ¹æ®æ‹“å±•é¡¹åç§°ä»æ˜ å°„å…³ç³»è¡¨ä¸­å–å‡ºç›¸åº”çš„æ‹“å±•ç±»å³å¯ã€‚ç›¸å…³è¿‡ç¨‹çš„ä»£ç åˆ†æå¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»ç¼“å­˜ä¸­è·å–å·²åŠ è½½çš„æ‹“å±•ç±»</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> classes <span class="token operator">=</span> cachedClasses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŒé‡æ£€æŸ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>classes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cachedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            classes <span class="token operator">=</span> cachedClasses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>classes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åŠ è½½æ‹“å±•ç±»</span>
                classes <span class="token operator">=</span> <span class="token function">loadExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cachedClasses<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> classes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œä¹Ÿæ˜¯å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œè‹¥ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™é€šè¿‡ <code>synchronized</code> åŠ é”ã€‚åŠ é”åå†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼Œå¹¶åˆ¤ç©ºã€‚æ­¤æ—¶å¦‚æœ classes ä»ä¸º nullï¼Œåˆ™é€šè¿‡ <code>loadExtensionClasses</code> åŠ è½½æ‹“å±•ç±»ã€‚ä¸‹é¢åˆ†æ <code>loadExtensionClasses</code> æ–¹æ³•çš„é€»è¾‘ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å– SPI æ³¨è§£ï¼Œè¿™é‡Œçš„ type å˜é‡æ˜¯åœ¨è°ƒç”¨ getExtensionLoader æ–¹æ³•æ—¶ä¼ å…¥çš„</span>
    <span class="token keyword">final</span> <span class="token class-name">SPI</span> defaultAnnotation <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token constant">SPI</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> defaultAnnotation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¯¹ SPI æ³¨è§£å†…å®¹è¿›è¡Œåˆ‡åˆ†</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> <span class="token constant">NAME_SEPARATOR</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ£€æµ‹ SPI æ³¨è§£å†…å®¹æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™æŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>names<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;more than 1 default extension name on extension...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// è®¾ç½®é»˜è®¤åç§°ï¼Œå‚è€ƒ getDefaultExtension æ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>names<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cachedDefaultName <span class="token operator">=</span> names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŠ è½½æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„é…ç½®æ–‡ä»¶</span>
    <span class="token function">loadDirectory</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> <span class="token constant">DUBBO_INTERNAL_DIRECTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">loadDirectory</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> <span class="token constant">DUBBO_DIRECTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">loadDirectory</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> <span class="token constant">SERVICES_DIRECTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> extensionClasses<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>loadExtensionClasses</code> æ–¹æ³•æ€»å…±åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€æ˜¯å¯¹ SPI æ³¨è§£è¿›è¡Œè§£æï¼ŒäºŒæ˜¯è°ƒç”¨ <code>loadDirectory</code> æ–¹æ³•åŠ è½½æŒ‡å®šæ–‡ä»¶å¤¹é…ç½®æ–‡ä»¶ã€‚SPI æ³¨è§£è§£æè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ— éœ€å¤šè¯´ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>loadDirectory</code> åšäº†å“ªäº›äº‹æƒ…ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadDirectory</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionClasses<span class="token punctuation">,</span> <span class="token class-name">String</span> dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fileName = æ–‡ä»¶å¤¹è·¯å¾„ + type å…¨é™å®šå</span>
    <span class="token class-name">String</span> fileName <span class="token operator">=</span> dir <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">&gt;</span></span> urls<span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">findClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¹æ®æ–‡ä»¶ååŠ è½½æ‰€æœ‰çš„åŒåæ–‡ä»¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            urls <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            urls <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urls <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL</span> resourceURL <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// åŠ è½½èµ„æº</span>
                <span class="token function">loadResource</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span> resourceURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>loadDirectory æ–¹æ³•å…ˆé€šè¿‡ classLoader è·å–æ‰€æœ‰èµ„æºé“¾æ¥ï¼Œç„¶åå†é€šè¿‡ loadResource æ–¹æ³•åŠ è½½èµ„æºã€‚æˆ‘ä»¬ç»§ç»­è·Ÿä¸‹å»ï¼Œçœ‹ä¸€ä¸‹ loadResource æ–¹æ³•çš„å®ç°ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadResource</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionClasses<span class="token punctuation">,</span>
	<span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL</span> resourceURL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>resourceURL<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> line<span class="token punctuation">;</span>
            <span class="token comment">// æŒ‰è¡Œè¯»å–é…ç½®å†…å®¹</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å®šä½ # å­—ç¬¦</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> ci <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ci <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æˆªå– # ä¹‹å‰çš„å­—ç¬¦ä¸²ï¼Œ# ä¹‹åçš„å†…å®¹ä¸ºæ³¨é‡Šï¼Œéœ€è¦å¿½ç•¥</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                line <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> i <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// ä»¥ç­‰äºå· = ä¸ºç•Œï¼Œæˆªå–é”®ä¸å€¼</span>
                            name <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            line <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// åŠ è½½ç±»ï¼Œå¹¶é€šè¿‡ loadClass æ–¹æ³•å¯¹ç±»è¿›è¡Œç¼“å­˜</span>
                            <span class="token function">loadClass</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> resourceURL<span class="token punctuation">,</span>
                                      <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">IllegalStateException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load extension class...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception when load extension class...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>loadResource æ–¹æ³•ç”¨äºè¯»å–å’Œè§£æé…ç½®æ–‡ä»¶ï¼Œå¹¶é€šè¿‡åå°„åŠ è½½ç±»ï¼Œæœ€åè°ƒç”¨ loadClass æ–¹æ³•è¿›è¡Œå…¶ä»–æ“ä½œã€‚loadClass æ–¹æ³•ç”¨äºä¸»è¦ç”¨äºæ“ä½œç¼“å­˜ï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionClasses<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL</span> resourceURL<span class="token punctuation">,</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ£€æµ‹ç›®æ ‡ç±»ä¸Šæ˜¯å¦æœ‰ Adaptive æ³¨è§£</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Adaptive</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedAdaptiveClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½® cachedAdaptiveClassç¼“å­˜</span>
            cachedAdaptiveClass <span class="token operator">=</span> clazz<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedAdaptiveClass<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token comment">// æ£€æµ‹ clazz æ˜¯å¦æ˜¯ Wrapper ç±»å‹</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWrapperClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wrappers <span class="token operator">=</span> cachedWrapperClasses<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrappers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cachedWrapperClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wrappers <span class="token operator">=</span> cachedWrapperClasses<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å­˜å‚¨ clazz åˆ° cachedWrapperClasses ç¼“å­˜ä¸­</span>
        wrappers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç¨‹åºè¿›å…¥æ­¤åˆ†æ”¯ï¼Œè¡¨æ˜ clazz æ˜¯ä¸€ä¸ªæ™®é€šçš„æ‹“å±•ç±»</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ£€æµ‹ clazz æ˜¯å¦æœ‰é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>
        clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœ name ä¸ºç©ºï¼Œåˆ™å°è¯•ä» Extension æ³¨è§£ä¸­è·å– nameï¼Œæˆ–ä½¿ç”¨å°å†™çš„ç±»åä½œä¸º name</span>
            name <span class="token operator">=</span> <span class="token function">findAnnotationName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åˆ‡åˆ† name</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> <span class="token constant">NAME_SEPARATOR</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>names <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> names<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Activate</span> activate <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Activate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœç±»ä¸Šæœ‰ Activate æ³¨è§£ï¼Œåˆ™ä½¿ç”¨ names æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºé”®ï¼Œ</span>
                <span class="token comment">// å­˜å‚¨ name åˆ° Activate æ³¨è§£å¯¹è±¡çš„æ˜ å°„å…³ç³»</span>
                cachedActivates<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> activate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> n <span class="token operator">:</span> names<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedNames<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å­˜å‚¨ Class åˆ°åç§°çš„æ˜ å°„å…³ç³»</span>
                    cachedNames<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> extensionClasses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å­˜å‚¨åç§°åˆ° Class çš„æ˜ å°„å…³ç³»</span>
                    extensionClasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚ä¸Šï¼Œ<code>loadClass</code> æ–¹æ³•æ“ä½œäº†ä¸åŒçš„ç¼“å­˜ï¼Œæ¯”å¦‚ <code>cachedAdaptiveClass</code>ã€<code>cachedWrapperClasses</code> å’Œ <code>cachedNames</code> ç­‰ç­‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰å…¶ä»–ä»€ä¹ˆé€»è¾‘äº†ã€‚</p> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <ul><li><a href="https://zhuanlan.zhihu.com/p/28909673" target="_blank" rel="noopener noreferrer">Java SPI æ€æƒ³æ¢³ç†<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://dubbo.apache.org/zh/docs/v2.7/dev/source/dubbo-spi/#m-zhdocsv27devsourcedubbo-spi" target="_blank" rel="noopener noreferrer">Dubbo SPI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.jianshu.com/p/0d196ad23915" target="_blank" rel="noopener noreferrer">springboot ä¸­ SPI æœºåˆ¶<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cdmana.com/2021/09/20210912140742519L.html" target="_blank" rel="noopener noreferrer">SpringBoot çš„è‡ªåŠ¨è£…é…åŸç†ã€è‡ªå®šä¹‰ starter ä¸ spi æœºåˆ¶ï¼Œä¸€ç½‘æ‰“å°½<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/dunwu/javacore/edit/master/docs/01.Java/01.JavaSE/02.é«˜çº§ç‰¹æ€§/05.JavaSPI.md" target="_blank" rel="noopener noreferrer">ğŸ“ å¸®åŠ©æ”¹å–„æ­¤é¡µé¢ï¼</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/javacore/tags/?tag=Java" title="æ ‡ç­¾">#Java</a><a href="/javacore/tags/?tag=JavaSE" title="æ ‡ç­¾">#JavaSE</a><a href="/javacore/tags/?tag=SPI" title="æ ‡ç­¾">#SPI</a><a href="/javacore/tags/?tag=Dubbo" title="æ ‡ç­¾">#Dubbo</a><a href="/javacore/tags/?tag=Spring%20Boot" title="æ ‡ç­¾">#Spring Boot</a><a href="/javacore/tags/?tag=common-logging" title="æ ‡ç­¾">#common-logging</a><a href="/javacore/tags/?tag=JDBC" title="æ ‡ç­¾">#JDBC</a></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2024/09/13, 06:43:21</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/javacore/pages/ad1cce/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JDK8 å…¥é—¨æŒ‡å—</div></a> <a href="/javacore/pages/d71f2c/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Java ç¼–ç¨‹è§„èŒƒ</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/javacore/pages/ad1cce/" class="prev">JDK8 å…¥é—¨æŒ‡å—</a></span> <span class="next"><a href="/javacore/pages/d71f2c/">Java ç¼–ç¨‹è§„èŒƒ</a>â†’
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/javacore/archives/" class="iconfont icon-bi">æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/javacore/pages/69d2f8/"><div>
            JavaSE
            <!----></div></a> <span class="date">05-06</span></dt></dl><dl><dd>02</dd> <dt><a href="/javacore/pages/2950ba/"><div>
            Java åŸºç¡€è¯­æ³•ç‰¹æ€§
            <!----></div></a> <span class="date">01-25</span></dt></dl><dl><dd>03</dd> <dt><a href="/javacore/pages/a249ff/"><div>
            Java ç¼–ç å’ŒåŠ å¯†
            <!----></div></a> <span class="date">05-24</span></dt></dl> <dl><dd></dd> <dt><a href="/javacore/archives/" class="more">æ›´å¤šæ–‡ç« &gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:forbreak@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/dunwu" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2019-2024
    <span>é’æ‚Ÿï¼ˆdunwuï¼‰ | CC-BY-SA-4.0</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">Ã—</span> <div>
    <div class="wwads-cn wwads-vertical windowRB" data-id="261" style="max-width:160px;
    min-width: auto;min-height:auto;"></div>
    <style>
      .windowRB{ padding: 0;}
      .windowRB .wwads-img{margin-top: 10px;}
      .windowRB .wwads-content{margin: 0 10px 40px 10px;}
      .custom-html-window-rb .close-but{
        display: none;
      }
    </style>
  </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/javacore/assets/js/app.44fc03ae.js" defer></script><script src="/javacore/assets/js/2.aded268b.js" defer></script><script src="/javacore/assets/js/24.e47f9024.js" defer></script>
  </body>
</html>
