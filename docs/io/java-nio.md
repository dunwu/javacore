# Java NIO

> **ğŸ“¦ æœ¬æ–‡ä»¥åŠç¤ºä¾‹æºç å·²å½’æ¡£åœ¨ [javacore](https://github.com/dunwu/javacore/)**
>
> å…³é”®è¯ï¼š`Channel`ã€`Buffer`ã€`Selector`ã€`éé˜»å¡`ã€`å¤šè·¯å¤ç”¨`

<!-- TOC depthFrom:2 depthTo:3 -->

- [ä¸€ã€NIO ç®€ä»‹](#ä¸€nio-ç®€ä»‹)
  - [NIO å’Œ BIO çš„åŒºåˆ«](#nio-å’Œ-bio-çš„åŒºåˆ«)
  - [NIO çš„åŸºæœ¬æµç¨‹](#nio-çš„åŸºæœ¬æµç¨‹)
  - [NIO æ ¸å¿ƒç»„ä»¶](#nio-æ ¸å¿ƒç»„ä»¶)
- [äºŒã€Channel(é€šé“)](#äºŒchannelé€šé“)
- [ä¸‰ã€Buffer(ç¼“å†²åŒº)](#ä¸‰bufferç¼“å†²åŒº)
  - [ç¼“å†²åŒºçŠ¶æ€å˜é‡](#ç¼“å†²åŒºçŠ¶æ€å˜é‡)
  - [æ–‡ä»¶ NIO ç¤ºä¾‹](#æ–‡ä»¶-nio-ç¤ºä¾‹)
- [å››ã€Selector(é€‰æ‹©å™¨)](#å››selectoré€‰æ‹©å™¨)
  - [åˆ›å»ºé€‰æ‹©å™¨](#åˆ›å»ºé€‰æ‹©å™¨)
  - [å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š](#å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š)
  - [ç›‘å¬äº‹ä»¶](#ç›‘å¬äº‹ä»¶)
  - [è·å–åˆ°è¾¾çš„äº‹ä»¶](#è·å–åˆ°è¾¾çš„äº‹ä»¶)
  - [äº‹ä»¶å¾ªç¯](#äº‹ä»¶å¾ªç¯)
  - [å¥—æ¥å­— NIO ç¤ºä¾‹](#å¥—æ¥å­—-nio-ç¤ºä¾‹)
  - [å†…å­˜æ˜ å°„æ–‡ä»¶](#å†…å­˜æ˜ å°„æ–‡ä»¶)
- [äº”ã€NIO vs. BIO](#äº”nio-vs-bio)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

<!-- /TOC -->

## ä¸€ã€NIO ç®€ä»‹

NIO æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„ I/O æ¨¡å‹ï¼Œåœ¨ Java 1.4 ä¸­å¼•å…¥äº† NIO æ¡†æ¶ï¼Œå¯¹åº” `java.nio` åŒ…ï¼Œæä¾›äº† `Channel` ã€`Selector`ã€`Buffer` ç­‰æŠ½è±¡ã€‚

NIO ä¸­çš„ N å¯ä»¥ç†è§£ä¸º Non-blockingï¼Œä¸å•çº¯æ˜¯ Newã€‚å®ƒæ”¯æŒé¢å‘ç¼“å†²çš„ï¼ŒåŸºäºé€šé“çš„ I/O æ“ä½œæ–¹æ³•ã€‚ NIO æä¾›äº†ä¸ä¼ ç»Ÿ BIO æ¨¡å‹ä¸­çš„ `Socket` å’Œ `ServerSocket` ç›¸å¯¹åº”çš„ `SocketChannel` å’Œ `ServerSocketChannel` ä¸¤ç§ä¸åŒçš„å¥—æ¥å­—é€šé“å®ç°,ä¸¤ç§é€šé“éƒ½æ”¯æŒé˜»å¡å’Œéé˜»å¡ä¸¤ç§æ¨¡å¼ã€‚é˜»å¡æ¨¡å¼ä½¿ç”¨å°±åƒä¼ ç»Ÿä¸­çš„æ”¯æŒä¸€æ ·ï¼Œæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ€§èƒ½å’Œå¯é æ€§éƒ½ä¸å¥½ï¼›éé˜»å¡æ¨¡å¼æ­£å¥½ä¸ä¹‹ç›¸åã€‚å¯¹äºä½è´Ÿè½½ã€ä½å¹¶å‘çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥é˜»å¡ I/O æ¥æå‡å¼€å‘é€Ÿç‡å’Œæ›´å¥½çš„ç»´æŠ¤æ€§ï¼›å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘çš„ï¼ˆç½‘ç»œï¼‰åº”ç”¨ï¼Œåº”ä½¿ç”¨ NIO çš„éé˜»å¡æ¨¡å¼æ¥å¼€å‘ã€‚

### NIO å’Œ BIO çš„åŒºåˆ«

#### Non-blocking IO(éé˜»å¡)

**BIO æ˜¯é˜»å¡çš„ï¼ŒNIO æ˜¯éé˜»å¡çš„**ã€‚

BIO çš„å„ç§æµæ˜¯é˜»å¡çš„ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `read()` æˆ– `write()` æ—¶ï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€äº›æ•°æ®è¢«è¯»å–ï¼Œæˆ–æ•°æ®å®Œå…¨å†™å…¥ã€‚åœ¨æ­¤æœŸé—´ï¼Œè¯¥çº¿ç¨‹ä¸èƒ½å†å¹²å…¶ä»–ä»»ä½•äº‹ã€‚

NIO ä½¿æˆ‘ä»¬å¯ä»¥è¿›è¡Œéé˜»å¡ IO æ“ä½œã€‚æ¯”å¦‚è¯´ï¼Œå•çº¿ç¨‹ä¸­ä»é€šé“è¯»å–æ•°æ®åˆ° bufferï¼ŒåŒæ—¶å¯ä»¥ç»§ç»­åšåˆ«çš„äº‹æƒ…ï¼Œå½“æ•°æ®è¯»å–åˆ° buffer ä¸­åï¼Œçº¿ç¨‹å†ç»§ç»­å¤„ç†æ•°æ®ã€‚å†™æ•°æ®ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å¦å¤–ï¼Œéé˜»å¡å†™ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™å…¥ä¸€äº›æ•°æ®åˆ°æŸé€šé“ï¼Œä½†ä¸éœ€è¦ç­‰å¾…å®ƒå®Œå…¨å†™å…¥ï¼Œè¿™ä¸ªçº¿ç¨‹åŒæ—¶å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚

#### Buffer(ç¼“å†²åŒº)

**BIO é¢å‘æµ(Stream oriented)ï¼Œè€Œ NIO é¢å‘ç¼“å†²åŒº(Buffer oriented)**ã€‚

Buffer æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåŒ…å«ä¸€äº›è¦å†™å…¥æˆ–è€…è¦è¯»å‡ºçš„æ•°æ®ã€‚åœ¨ NIO ç±»åº“ä¸­åŠ å…¥ Buffer å¯¹è±¡ï¼Œä½“ç°äº† NIO ä¸ BIO çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚åœ¨é¢å‘æµçš„ BIO ä¸­å¯ä»¥å°†æ•°æ®ç›´æ¥å†™å…¥æˆ–è€…å°†æ•°æ®ç›´æ¥è¯»åˆ° Stream å¯¹è±¡ä¸­ã€‚è™½ç„¶ Stream ä¸­ä¹Ÿæœ‰ Buffer å¼€å¤´çš„æ‰©å±•ç±»ï¼Œä½†åªæ˜¯æµçš„åŒ…è£…ç±»ï¼Œè¿˜æ˜¯ä»æµè¯»åˆ°ç¼“å†²åŒºï¼Œè€Œ NIO å´æ˜¯ç›´æ¥è¯»åˆ° Buffer ä¸­è¿›è¡Œæ“ä½œã€‚

åœ¨ NIO åä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”¨ç¼“å†²åŒºå¤„ç†çš„ã€‚åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå®ƒæ˜¯ç›´æ¥è¯»ç¼“å†²åŒºä¸­çš„æ•°æ®; åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œå†™å…¥åˆ°ç¼“å†²åŒºä¸­ã€‚ä»»ä½•æ—¶å€™è®¿é—® NIO ä¸­çš„æ•°æ®ï¼Œéƒ½æ˜¯é€šè¿‡ç¼“å†²åŒºè¿›è¡Œæ“ä½œã€‚

æœ€å¸¸ç”¨çš„ç¼“å†²åŒºæ˜¯ ByteBuffer,ä¸€ä¸ª ByteBuffer æä¾›äº†ä¸€ç»„åŠŸèƒ½ç”¨äºæ“ä½œ byte æ•°ç»„ã€‚é™¤äº† ByteBuffer,è¿˜æœ‰å…¶ä»–çš„ä¸€äº›ç¼“å†²åŒºï¼Œäº‹å®ä¸Šï¼Œæ¯ä¸€ç§ Java åŸºæœ¬ç±»å‹ï¼ˆé™¤äº† Boolean ç±»å‹ï¼‰éƒ½å¯¹åº”æœ‰ä¸€ç§ç¼“å†²åŒºã€‚

#### Channel (é€šé“)

NIO é€šè¿‡ Channelï¼ˆé€šé“ï¼‰ è¿›è¡Œè¯»å†™ã€‚

é€šé“æ˜¯åŒå‘çš„ï¼Œå¯è¯»ä¹Ÿå¯å†™ï¼Œè€Œæµçš„è¯»å†™æ˜¯å•å‘çš„ã€‚æ— è®ºè¯»å†™ï¼Œé€šé“åªèƒ½å’Œ Buffer äº¤äº’ã€‚å› ä¸º Bufferï¼Œé€šé“å¯ä»¥å¼‚æ­¥åœ°è¯»å†™ã€‚

#### Selector (é€‰æ‹©å™¨)

NIO æœ‰é€‰æ‹©å™¨ï¼Œè€Œ IO æ²¡æœ‰ã€‚

é€‰æ‹©å™¨ç”¨äºä½¿ç”¨å•ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªé€šé“ã€‚å› æ­¤ï¼Œå®ƒéœ€è¦è¾ƒå°‘çš„çº¿ç¨‹æ¥å¤„ç†è¿™äº›é€šé“ã€‚çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢å¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´æ˜¯æ˜‚è´µçš„ã€‚ å› æ­¤ï¼Œä¸ºäº†æé«˜ç³»ç»Ÿæ•ˆç‡é€‰æ‹©å™¨æ˜¯æœ‰ç”¨çš„ã€‚

### NIO çš„åŸºæœ¬æµç¨‹

é€šå¸¸æ¥è¯´ NIO ä¸­çš„æ‰€æœ‰ IO éƒ½æ˜¯ä» Channelï¼ˆé€šé“ï¼‰ å¼€å§‹çš„ã€‚

- ä»é€šé“è¿›è¡Œæ•°æ®è¯»å– ï¼šåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œç„¶åè¯·æ±‚é€šé“è¯»å–æ•°æ®ã€‚
- ä»é€šé“è¿›è¡Œæ•°æ®å†™å…¥ ï¼šåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œå¡«å……æ•°æ®ï¼Œå¹¶è¦æ±‚é€šé“å†™å…¥æ•°æ®ã€‚

### NIO æ ¸å¿ƒç»„ä»¶

NIO åŒ…å«ä¸‹é¢å‡ ä¸ªæ ¸å¿ƒçš„ç»„ä»¶ï¼š

- **Channel(é€šé“)**
- **Buffer(ç¼“å†²åŒº)**
- **Selector(é€‰æ‹©å™¨)**

## äºŒã€Channel(é€šé“)

é€šé“ï¼ˆ`Channel`ï¼‰æ˜¯å¯¹ BIO ä¸­çš„æµçš„æ¨¡æ‹Ÿï¼Œå¯ä»¥é€šè¿‡å®ƒè¯»å†™æ•°æ®ã€‚

Channelï¼Œç±»ä¼¼åœ¨ Linux ä¹‹ç±»æ“ä½œç³»ç»Ÿä¸Šçœ‹åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ˜¯ NIO ä¸­è¢«ç”¨æ¥æ”¯æŒæ‰¹é‡å¼ IO æ“ä½œçš„ä¸€ç§æŠ½è±¡ã€‚

File æˆ–è€… Socketï¼Œé€šå¸¸è¢«è®¤ä¸ºæ˜¯æ¯”è¾ƒé«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œè€Œ Channel åˆ™æ˜¯æ›´åŠ æ“ä½œç³»ç»Ÿåº•å±‚çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ä¹Ÿä½¿å¾— NIO å¾—ä»¥å……åˆ†åˆ©ç”¨ç°ä»£æ“ä½œç³»ç»Ÿåº•å±‚æœºåˆ¶ï¼Œè·å¾—ç‰¹å®šåœºæ™¯çš„æ€§èƒ½ä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼ŒDMAï¼ˆDirect Memory Accessï¼‰ç­‰ã€‚ä¸åŒå±‚æ¬¡çš„æŠ½è±¡æ˜¯ç›¸äº’å…³è”çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Socket è·å– Channelï¼Œåä¹‹äº¦ç„¶ã€‚

é€šé“ä¸æµçš„ä¸åŒä¹‹å¤„åœ¨äºï¼š

- **æµæ˜¯å•å‘çš„** - ä¸€ä¸ªæµåªèƒ½å•çº¯çš„è´Ÿè´£è¯»æˆ–å†™ã€‚
- **é€šé“æ˜¯åŒå‘çš„** - ä¸€ä¸ªé€šé“å¯ä»¥åŒæ—¶ç”¨äºè¯»å†™ã€‚

é€šé“åŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š

- `FileChannel`ï¼šä»æ–‡ä»¶ä¸­è¯»å†™æ•°æ®ï¼›
- `DatagramChannel`ï¼šé€šè¿‡ UDP è¯»å†™ç½‘ç»œä¸­æ•°æ®ï¼›
- `SocketChannel`ï¼šé€šè¿‡ TCP è¯»å†™ç½‘ç»œä¸­æ•°æ®ï¼›
- `ServerSocketChannel`ï¼šå¯ä»¥ç›‘å¬æ–°è¿›æ¥çš„ TCP è¿æ¥ï¼Œå¯¹æ¯ä¸€ä¸ªæ–°è¿›æ¥çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ª SocketChannelã€‚

## ä¸‰ã€Buffer(ç¼“å†²åŒº)

NIO ä¸ä¼ ç»Ÿ I/O ä¸åŒï¼Œå®ƒæ˜¯åŸºäºå—ï¼ˆBlockï¼‰çš„ï¼Œå®ƒä»¥å—ä¸ºåŸºæœ¬å•ä½å¤„ç†æ•°æ®ã€‚`Buffer` æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜å—ï¼Œæ˜¯ NIO è¯»å†™æ•°æ®çš„ç¼“å†²ã€‚`Buffer` å¯ä»¥å°†æ–‡ä»¶ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜å†åšåç»­å¤„ç†ï¼Œè€Œä¼ ç»Ÿçš„æ–¹å¼æ˜¯è¾¹è¯»æ–‡ä»¶è¾¹å¤„ç†æ•°æ®ã€‚

**å‘ `Channel` è¯»å†™çš„æ•°æ®éƒ½å¿…é¡»å…ˆç½®äºç¼“å†²åŒºä¸­**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šç›´æ¥å¯¹é€šé“è¿›è¡Œè¯»å†™æ•°æ®ï¼Œè€Œæ˜¯è¦å…ˆç»è¿‡ç¼“å†²åŒºã€‚ç¼“å†²åŒºå®è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚ç¼“å†²åŒºæä¾›äº†å¯¹æ•°æ®çš„ç»“æ„åŒ–è®¿é—®ï¼Œè€Œä¸”è¿˜å¯ä»¥è·Ÿè¸ªç³»ç»Ÿçš„è¯»/å†™è¿›ç¨‹ã€‚

BIO å’Œ NIO å·²ç»å¾ˆå¥½åœ°é›†æˆäº†ï¼Œ`java.io.*` å·²ç»ä»¥ NIO ä¸ºåŸºç¡€é‡æ–°å®ç°äº†ï¼Œæ‰€ä»¥ç°åœ¨å®ƒå¯ä»¥åˆ©ç”¨ NIO çš„ä¸€äº›ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œ`java.io.*` åŒ…ä¸­çš„ä¸€äº›ç±»åŒ…å«ä»¥å—çš„å½¢å¼è¯»å†™æ•°æ®çš„æ–¹æ³•ï¼Œè¿™ä½¿å¾—å³ä½¿åœ¨é¢å‘æµçš„ç³»ç»Ÿä¸­ï¼Œå¤„ç†é€Ÿåº¦ä¹Ÿä¼šæ›´å¿«ã€‚

ç¼“å†²åŒºåŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š

- `ByteBuffer`
- `CharBuffer`
- `ShortBuffer`
- `IntBuffer`
- `LongBuffer`
- `FloatBuffer`
- `DoubleBuffer`

### ç¼“å†²åŒºçŠ¶æ€å˜é‡

- `capacity`ï¼šæœ€å¤§å®¹é‡ï¼›
- `position`ï¼šå½“å‰å·²ç»è¯»å†™çš„å­—èŠ‚æ•°ï¼›
- `limit`ï¼šè¿˜å¯ä»¥è¯»å†™çš„å­—èŠ‚æ•°ã€‚
- `mark`ï¼šè®°å½•ä¸Šä¸€æ¬¡ postion çš„ä½ç½®ï¼Œé»˜è®¤æ˜¯ 0ï¼Œç®—æ˜¯ä¸€ä¸ªä¾¿åˆ©æ€§çš„è€ƒè™‘ï¼Œå¾€å¾€ä¸æ˜¯å¿…é¡»
  çš„ã€‚

ç¼“å†²åŒºçŠ¶æ€å˜é‡çš„æ”¹å˜è¿‡ç¨‹ä¸¾ä¾‹ï¼š

1.  æ–°å»ºä¸€ä¸ªå¤§å°ä¸º 8 ä¸ªå­—èŠ‚çš„ç¼“å†²åŒºï¼Œæ­¤æ—¶ position ä¸º 0ï¼Œè€Œ limit = capacity = 8ã€‚capacity å˜é‡ä¸ä¼šæ”¹å˜ï¼Œä¸‹é¢çš„è®¨è®ºä¼šå¿½ç•¥å®ƒã€‚
2.  ä»è¾“å…¥é€šé“ä¸­è¯»å– 5 ä¸ªå­—èŠ‚æ•°æ®å†™å…¥ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ position ç§»åŠ¨è®¾ç½®ä¸º 5ï¼Œlimit ä¿æŒä¸å˜ã€‚
3.  åœ¨å°†ç¼“å†²åŒºçš„æ•°æ®å†™åˆ°è¾“å‡ºé€šé“ä¹‹å‰ï¼Œéœ€è¦å…ˆè°ƒç”¨ flip() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°† limit è®¾ç½®ä¸ºå½“å‰ positionï¼Œå¹¶å°† position è®¾ç½®ä¸º 0ã€‚
4.  ä»ç¼“å†²åŒºä¸­å– 4 ä¸ªå­—èŠ‚åˆ°è¾“å‡ºç¼“å†²ä¸­ï¼Œæ­¤æ—¶ position è®¾ä¸º 4ã€‚
5.  æœ€åéœ€è¦è°ƒç”¨ clear() æ–¹æ³•æ¥æ¸…ç©ºç¼“å†²åŒºï¼Œæ­¤æ—¶ position å’Œ limit éƒ½è¢«è®¾ç½®ä¸ºæœ€åˆä½ç½®ã€‚

### æ–‡ä»¶ NIO ç¤ºä¾‹

ä»¥ä¸‹å±•ç¤ºäº†ä½¿ç”¨ NIO å¿«é€Ÿå¤åˆ¶æ–‡ä»¶çš„å®ä¾‹ï¼š

```java
public static void fastCopy(String src, String dist) throws IOException {

    /* è·å¾—æºæ–‡ä»¶çš„è¾“å…¥å­—èŠ‚æµ */
    FileInputStream fin = new FileInputStream(src);

    /* è·å–è¾“å…¥å­—èŠ‚æµçš„æ–‡ä»¶é€šé“ */
    FileChannel fcin = fin.getChannel();

    /* è·å–ç›®æ ‡æ–‡ä»¶çš„è¾“å‡ºå­—èŠ‚æµ */
    FileOutputStream fout = new FileOutputStream(dist);

    /* è·å–è¾“å‡ºå­—èŠ‚æµçš„é€šé“ */
    FileChannel fcout = fout.getChannel();

    /* ä¸ºç¼“å†²åŒºåˆ†é… 1024 ä¸ªå­—èŠ‚ */
    ByteBuffer buffer = ByteBuffer.allocateDirect(1024);

    while (true) {

        /* ä»è¾“å…¥é€šé“ä¸­è¯»å–æ•°æ®åˆ°ç¼“å†²åŒºä¸­ */
        int r = fcin.read(buffer);

        /* read() è¿”å› -1 è¡¨ç¤º EOF */
        if (r == -1) {
            break;
        }

        /* åˆ‡æ¢è¯»å†™ */
        buffer.flip();

        /* æŠŠç¼“å†²åŒºçš„å†…å®¹å†™å…¥è¾“å‡ºæ–‡ä»¶ä¸­ */
        fcout.write(buffer);

        /* æ¸…ç©ºç¼“å†²åŒº */
        buffer.clear();
    }
}
```

### DirectBuffer

NIO è¿˜æä¾›äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜çš„ç±» `DirectBuffer`ã€‚æ™®é€šçš„ `Buffer` åˆ†é…çš„æ˜¯ JVM å †å†…å­˜ï¼Œè€Œ `DirectBuffer` æ˜¯ç›´æ¥åˆ†é…ç‰©ç†å†…å­˜ã€‚

æ•°æ®è¦è¾“å‡ºåˆ°å¤–éƒ¨è®¾å¤‡ï¼Œå¿…é¡»å…ˆä»ç”¨æˆ·ç©ºé—´å¤åˆ¶åˆ°å†…æ ¸ç©ºé—´ï¼Œå†å¤åˆ¶åˆ°è¾“å‡ºè®¾å¤‡ï¼Œè€Œ `DirectBuffer` åˆ™æ˜¯ç›´æ¥å°†æ­¥éª¤ç®€åŒ–ä¸ºä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°å¤–éƒ¨è®¾å¤‡ï¼Œå‡å°‘äº†æ•°æ®æ‹·è´ã€‚

è¿™é‡Œæ‹“å±•ä¸€ç‚¹ï¼Œç”±äº `DirectBuffer` ç”³è¯·çš„æ˜¯é JVM çš„ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·å¾ˆé«˜ã€‚`DirectBuffer` ç”³è¯·çš„å†…å­˜å¹¶ä¸æ˜¯ç›´æ¥ç”± JVM è´Ÿè´£åƒåœ¾å›æ”¶ï¼Œä½†åœ¨ `DirectBuffer` åŒ…è£…ç±»è¢«å›æ”¶æ—¶ï¼Œä¼šé€šè¿‡ Java å¼•ç”¨æœºåˆ¶æ¥é‡Šæ”¾è¯¥å†…å­˜å—ã€‚

## å››ã€Selector(é€‰æ‹©å™¨)

NIO å¸¸å¸¸è¢«å«åšéé˜»å¡ IOï¼Œä¸»è¦æ˜¯å› ä¸º NIO åœ¨ç½‘ç»œé€šä¿¡ä¸­çš„éé˜»å¡ç‰¹æ€§è¢«å¹¿æ³›ä½¿ç”¨ã€‚

`Selector` æ˜¯ Java NIO ç¼–ç¨‹çš„åŸºç¡€ã€‚ç”¨äºæ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ª NIO `Channel` çš„çŠ¶æ€æ˜¯å¦å¤„äºå¯è¯»ã€å¯å†™ã€‚

**NIO å®ç°äº† IO å¤šè·¯å¤ç”¨ä¸­çš„ Reactor æ¨¡å‹**ï¼š

- ä¸€ä¸ªçº¿ç¨‹ï¼ˆ`Thread`ï¼‰ä½¿ç”¨ä¸€ä¸ª**é€‰æ‹©å™¨ `Selector` é€šè¿‡è½®è¯¢çš„æ–¹å¼å»ç›‘å¬å¤šä¸ªé€šé“ `Channel` ä¸Šçš„äº‹ä»¶ï¼ˆ`accpet`ã€`read`ï¼‰**ï¼Œå¦‚æœæŸä¸ª `Channel` ä¸Šé¢å‘ç”Ÿç›‘å¬äº‹ä»¶ï¼Œè¿™ä¸ª `Channel` å°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œç„¶åè¿›è¡Œ I/O æ“ä½œã€‚
- é€šè¿‡**é…ç½®ç›‘å¬çš„é€šé“ `Channel` ä¸ºéé˜»å¡**ï¼Œé‚£ä¹ˆå½“ `Channel` ä¸Šçš„ IO äº‹ä»¶è¿˜æœªåˆ°è¾¾æ—¶ï¼Œå°±ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ä¸€ç›´ç­‰å¾…ï¼Œè€Œæ˜¯ç»§ç»­è½®è¯¢å…¶å®ƒ `Channel`ï¼Œæ‰¾åˆ° IO äº‹ä»¶å·²ç»åˆ°è¾¾çš„ `Channel` æ‰§è¡Œã€‚

- å› ä¸ºåˆ›å»ºå’Œåˆ‡æ¢çº¿ç¨‹çš„å¼€é”€å¾ˆå¤§ï¼Œå› æ­¤ä½¿ç”¨**ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªäº‹ä»¶**è€Œä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªäº‹ä»¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰ `SocketChannel` æ‰èƒ½é…ç½®ä¸ºéé˜»å¡ï¼Œè€Œ `FileChannel` ä¸èƒ½ï¼Œå› ä¸º `FileChannel` é…ç½®éé˜»å¡ä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚

> ç›®å‰æ“ä½œç³»ç»Ÿçš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶éƒ½ä½¿ç”¨äº† epollï¼Œç›¸æ¯”ä¼ ç»Ÿçš„ select æœºåˆ¶ï¼Œepoll æ²¡æœ‰æœ€å¤§è¿æ¥å¥æŸ„ 1024 çš„é™åˆ¶ã€‚æ‰€ä»¥ Selector åœ¨ç†è®ºä¸Šå¯ä»¥è½®è¯¢æˆåƒä¸Šä¸‡çš„å®¢æˆ·ç«¯ã€‚

### åˆ›å»ºé€‰æ‹©å™¨

```java
Selector selector = Selector.open();
```

### å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š

```java
ServerSocketChannel ssChannel = ServerSocketChannel.open();
ssChannel.configureBlocking(false);
ssChannel.register(selector, SelectionKey.OP_ACCEPT);
```

é€šé“å¿…é¡»é…ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¦åˆ™ä½¿ç”¨é€‰æ‹©å™¨å°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†ï¼Œå› ä¸ºå¦‚æœé€šé“åœ¨æŸä¸ªäº‹ä»¶ä¸Šè¢«é˜»å¡ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±ä¸èƒ½å“åº”å…¶å®ƒäº‹ä»¶ï¼Œå¿…é¡»ç­‰å¾…è¿™ä¸ªäº‹ä»¶å¤„ç†å®Œæ¯•æ‰èƒ½å»å¤„ç†å…¶å®ƒäº‹ä»¶ï¼Œæ˜¾ç„¶è¿™å’Œé€‰æ‹©å™¨çš„ä½œç”¨èƒŒé“è€Œé©°ã€‚

åœ¨å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šæ—¶ï¼Œè¿˜éœ€è¦æŒ‡å®šè¦æ³¨å†Œçš„å…·ä½“äº‹ä»¶ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼š

- `SelectionKey.OP_CONNECT`
- `SelectionKey.OP_ACCEPT`
- `SelectionKey.OP_READ`
- `SelectionKey.OP_WRITE`

å®ƒä»¬åœ¨ SelectionKey çš„å®šä¹‰å¦‚ä¸‹ï¼š

```java
public static final int OP_READ = 1 << 0;
public static final int OP_WRITE = 1 << 2;
public static final int OP_CONNECT = 1 << 3;
public static final int OP_ACCEPT = 1 << 4;
```

å¯ä»¥çœ‹å‡ºæ¯ä¸ªäº‹ä»¶å¯ä»¥è¢«å½“æˆä¸€ä¸ªä½åŸŸï¼Œä»è€Œç»„æˆäº‹ä»¶é›†æ•´æ•°ã€‚ä¾‹å¦‚ï¼š

```java
int interestSet = SelectionKey.OP_READ | SelectionKey.OP_WRITE;
```

### ç›‘å¬äº‹ä»¶

```java
int num = selector.select();
```

ä½¿ç”¨ `select()` æ¥ç›‘å¬åˆ°è¾¾çš„äº‹ä»¶ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰è‡³å°‘ä¸€ä¸ªäº‹ä»¶åˆ°è¾¾ã€‚

### è·å–åˆ°è¾¾çš„äº‹ä»¶

```java
Set<SelectionKey> keys = selector.selectedKeys();
Iterator<SelectionKey> keyIterator = keys.iterator();
while (keyIterator.hasNext()) {
    SelectionKey key = keyIterator.next();
    if (key.isAcceptable()) {
        // ...
    } else if (key.isReadable()) {
        // ...
    }
    keyIterator.remove();
}
```

### äº‹ä»¶å¾ªç¯

å› ä¸ºä¸€æ¬¡ select() è°ƒç”¨ä¸èƒ½å¤„ç†å®Œæ‰€æœ‰çš„äº‹ä»¶ï¼Œå¹¶ä¸”æœåŠ¡å™¨ç«¯æœ‰å¯èƒ½éœ€è¦ä¸€ç›´ç›‘å¬äº‹ä»¶ï¼Œå› æ­¤æœåŠ¡å™¨ç«¯å¤„ç†äº‹ä»¶çš„ä»£ç ä¸€èˆ¬ä¼šæ”¾åœ¨ä¸€ä¸ªæ­»å¾ªç¯å†…ã€‚

```java
while (true) {
    int num = selector.select();
    Set<SelectionKey> keys = selector.selectedKeys();
    Iterator<SelectionKey> keyIterator = keys.iterator();
    while (keyIterator.hasNext()) {
        SelectionKey key = keyIterator.next();
        if (key.isAcceptable()) {
            // ...
        } else if (key.isReadable()) {
            // ...
        }
        keyIterator.remove();
    }
}
```

### å¥—æ¥å­— NIO ç¤ºä¾‹

```java
public class NIOServer {

    public static void main(String[] args) throws IOException {

        Selector selector = Selector.open();

        ServerSocketChannel ssChannel = ServerSocketChannel.open();
        ssChannel.configureBlocking(false);
        ssChannel.register(selector, SelectionKey.OP_ACCEPT);

        ServerSocket serverSocket = ssChannel.socket();
        InetSocketAddress address = new InetSocketAddress("127.0.0.1", 8888);
        serverSocket.bind(address);

        while (true) {

            selector.select();
            Set<SelectionKey> keys = selector.selectedKeys();
            Iterator<SelectionKey> keyIterator = keys.iterator();

            while (keyIterator.hasNext()) {

                SelectionKey key = keyIterator.next();

                if (key.isAcceptable()) {

                    ServerSocketChannel ssChannel1 = (ServerSocketChannel) key.channel();

                    // æœåŠ¡å™¨ä¼šä¸ºæ¯ä¸ªæ–°è¿æ¥åˆ›å»ºä¸€ä¸ª SocketChannel
                    SocketChannel sChannel = ssChannel1.accept();
                    sChannel.configureBlocking(false);

                    // è¿™ä¸ªæ–°è¿æ¥ä¸»è¦ç”¨äºä»å®¢æˆ·ç«¯è¯»å–æ•°æ®
                    sChannel.register(selector, SelectionKey.OP_READ);

                } else if (key.isReadable()) {

                    SocketChannel sChannel = (SocketChannel) key.channel();
                    System.out.println(readDataFromSocketChannel(sChannel));
                    sChannel.close();
                }

                keyIterator.remove();
            }
        }
    }

    private static String readDataFromSocketChannel(SocketChannel sChannel) throws IOException {

        ByteBuffer buffer = ByteBuffer.allocate(1024);
        StringBuilder data = new StringBuilder();

        while (true) {

            buffer.clear();
            int n = sChannel.read(buffer);
            if (n == -1) {
                break;
            }
            buffer.flip();
            int limit = buffer.limit();
            char[] dst = new char[limit];
            for (int i = 0; i < limit; i++) {
                dst[i] = (char) buffer.get(i);
            }
            data.append(dst);
            buffer.clear();
        }
        return data.toString();
    }
}
```

```java
public class NIOClient {

    public static void main(String[] args) throws IOException {
        Socket socket = new Socket("127.0.0.1", 8888);
        OutputStream out = socket.getOutputStream();
        String s = "hello world";
        out.write(s.getBytes());
        out.close();
    }
}
```

### å†…å­˜æ˜ å°„æ–‡ä»¶

å†…å­˜æ˜ å°„æ–‡ä»¶ I/O æ˜¯ä¸€ç§è¯»å’Œå†™æ–‡ä»¶æ•°æ®çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ¯”å¸¸è§„çš„åŸºäºæµæˆ–è€…åŸºäºé€šé“çš„ I/O å¿«å¾—å¤šã€‚

å‘å†…å­˜æ˜ å°„æ–‡ä»¶å†™å…¥å¯èƒ½æ˜¯å±é™©çš„ï¼Œåªæ˜¯æ”¹å˜æ•°ç»„çš„å•ä¸ªå…ƒç´ è¿™æ ·çš„ç®€å•æ“ä½œï¼Œå°±å¯èƒ½ä¼šç›´æ¥ä¿®æ”¹ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚ä¿®æ”¹æ•°æ®ä¸å°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜æ˜¯æ²¡æœ‰åˆ†å¼€çš„ã€‚

ä¸‹é¢ä»£ç è¡Œå°†æ–‡ä»¶çš„å‰ 1024 ä¸ªå­—èŠ‚æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œmap() æ–¹æ³•è¿”å›ä¸€ä¸ª MappedByteBufferï¼Œå®ƒæ˜¯ ByteBuffer çš„å­ç±»ã€‚å› æ­¤ï¼Œå¯ä»¥åƒä½¿ç”¨å…¶ä»–ä»»ä½• ByteBuffer ä¸€æ ·ä½¿ç”¨æ–°æ˜ å°„çš„ç¼“å†²åŒºï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨éœ€è¦æ—¶è´Ÿè´£æ‰§è¡Œæ˜ å°„ã€‚

```java
MappedByteBuffer mbb = fc.map(FileChannel.MapMode.READ_WRITE, 0, 1024);
```

## äº”ã€NIO vs. BIO

BIO ä¸ NIO æœ€é‡è¦çš„åŒºåˆ«æ˜¯æ•°æ®æ‰“åŒ…å’Œä¼ è¾“çš„æ–¹å¼ï¼š**BIO ä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€Œ NIO ä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®**ã€‚

- **é¢å‘æµçš„ BIO ä¸€æ¬¡å¤„ç†ä¸€ä¸ªå­—èŠ‚æ•°æ®**ï¼šä¸€ä¸ªè¾“å…¥æµäº§ç”Ÿä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œä¸€ä¸ªè¾“å‡ºæµæ¶ˆè´¹ä¸€ä¸ªå­—èŠ‚æ•°æ®ã€‚ä¸ºæµå¼æ•°æ®åˆ›å»ºè¿‡æ»¤å™¨éå¸¸å®¹æ˜“ï¼Œé“¾æ¥å‡ ä¸ªè¿‡æ»¤å™¨ï¼Œä»¥ä¾¿æ¯ä¸ªè¿‡æ»¤å™¨åªè´Ÿè´£å¤æ‚å¤„ç†æœºåˆ¶çš„ä¸€éƒ¨åˆ†ã€‚ä¸åˆ©çš„ä¸€é¢æ˜¯ï¼Œé¢å‘æµçš„ I/O é€šå¸¸ç›¸å½“æ…¢ã€‚
- **é¢å‘å—çš„ NIO ä¸€æ¬¡å¤„ç†ä¸€ä¸ªæ•°æ®å—**ï¼ŒæŒ‰å—å¤„ç†æ•°æ®æ¯”æŒ‰æµå¤„ç†æ•°æ®è¦å¿«å¾—å¤šã€‚ä½†æ˜¯é¢å‘å—çš„ NIO ç¼ºå°‘ä¸€äº›é¢å‘æµçš„ BIO æ‰€å…·æœ‰çš„ä¼˜é›…æ€§å’Œç®€å•æ€§ã€‚

BIO æ¨¡å¼ï¼š

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20200630212345.png)

NIO æ¨¡å¼ï¼š

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20200630212248.png)

## å‚è€ƒèµ„æ–™

- [BIO,NIO,AIO æ€»ç»“](https://github.com/Snailclimb/JavaGuide/blob/master/docs/java/BIO-NIO-AIO.md)
- [Java NIO æµ…æ](https://zhuanlan.zhihu.com/p/23488863)
- [JavaNIO Tutorial](http://tutorials.jenkov.com/java-nio/index.html)
- [IBM: NIO å…¥é—¨](https://www.ibm.com/developerworks/cn/education/java/j-nio/j-nio.html)
