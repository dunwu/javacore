# JVM å®æˆ˜

> **ğŸ“¦ æœ¬æ–‡ä»¥åŠç¤ºä¾‹æºç å·²å½’æ¡£åœ¨ [javacore](https://github.com/dunwu/javacore/)**

[TOC]

## ä¸€ã€JVM è°ƒä¼˜æ¦‚è¿°

å¯¹äº JVM è°ƒä¼˜æ¥è¯´ï¼Œéœ€è¦å…ˆæ˜ç¡®è°ƒä¼˜çš„ç›®æ ‡ã€‚
ä»æ€§èƒ½çš„è§’åº¦çœ‹ï¼Œé€šå¸¸å…³æ³¨ä¸‰ä¸ªæŒ‡æ ‡ï¼š

- `ååé‡ï¼ˆthroughputï¼‰` - æŒ‡ä¸è€ƒè™‘ GC å¼•èµ·çš„åœé¡¿æ—¶é—´æˆ–å†…å­˜æ¶ˆè€—ï¼Œåƒåœ¾æ”¶é›†å™¨èƒ½æ”¯æ’‘åº”ç”¨è¾¾åˆ°çš„æœ€é«˜æ€§èƒ½æŒ‡æ ‡ã€‚
- `å»¶è¿Ÿï¼ˆlatencyï¼‰` - å…¶åº¦é‡æ ‡å‡†æ˜¯ç¼©çŸ­ç”±äºåƒåœ¾å•Šæ”¶é›†å¼•èµ·çš„åœé¡¿æ—¶é—´æˆ–è€…å®Œå…¨æ¶ˆé™¤å› åƒåœ¾æ”¶é›†æ‰€å¼•èµ·çš„åœé¡¿ï¼Œé¿å…åº”ç”¨è¿è¡Œæ—¶å‘ç”ŸæŠ–åŠ¨ã€‚
- `å†…å­˜å ç”¨ï¼ˆfootprintï¼‰` - åƒåœ¾æ”¶é›†å™¨æµç•…è¿è¡Œæ‰€éœ€è¦çš„å†…å­˜æ•°é‡ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹è°ƒä¼˜ä¼šä¾§é‡äºå…¶ä¸­ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªæ–¹é¢çš„ç›®æ ‡ï¼Œå¾ˆå°‘æœ‰æƒ…å†µå¯ä»¥å…¼é¡¾ä¸‰ä¸ªä¸åŒçš„è§’åº¦ã€‚

### è°ƒä¼˜åŸåˆ™

#### GC ä¼˜åŒ–ç›®æ ‡

GC ä¼˜åŒ–çš„ä¸¤ä¸ªç›®æ ‡ï¼š

- **å°†è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡æ•°é‡é™åˆ°æœ€ä½**
- **å‡å°‘ Full GC çš„æ‰§è¡Œæ—¶é—´**

GC ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™æ˜¯ï¼šå°†ä¸åŒçš„ GC å‚æ•°åº”ç”¨åˆ°ä¸¤ä¸ªåŠä»¥ä¸Šçš„æœåŠ¡å™¨ä¸Šç„¶åæ¯”è¾ƒå®ƒä»¬çš„æ€§èƒ½ï¼Œç„¶åå°†é‚£äº›è¢«è¯æ˜å¯ä»¥æé«˜æ€§èƒ½æˆ–å‡å°‘ GC æ‰§è¡Œæ—¶é—´çš„å‚æ•°åº”ç”¨äºæœ€ç»ˆçš„å·¥ä½œæœåŠ¡å™¨ä¸Šã€‚

#### å°†è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡æ•°é‡é™åˆ°æœ€ä½

é™¤äº†å¯ä»¥åœ¨ JDK7 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„ G1 æ”¶é›†å™¨ä»¥å¤–ï¼Œå…¶ä»–åˆ†ä»£ GC éƒ½æ˜¯ç”± Oracle JVM æä¾›çš„ã€‚å…³äºåˆ†ä»£ GCï¼Œå°±æ˜¯å¯¹è±¡åœ¨ Eden åŒºè¢«åˆ›å»ºï¼Œéšåè¢«è½¬ç§»åˆ° Survivor åŒºï¼Œåœ¨æ­¤ä¹‹åå‰©ä½™çš„å¯¹è±¡ä¼šè¢«è½¬å…¥è€å¹´ä»£ã€‚ä¹Ÿæœ‰ä¸€äº›å¯¹è±¡ç”±äºå ç”¨å†…å­˜è¿‡å¤§ï¼Œåœ¨ Eden åŒºè¢«åˆ›å»ºåä¼šç›´æ¥è¢«ä¼ å…¥è€å¹´ä»£ã€‚è€å¹´ä»£ GC ç›¸å¯¹æ¥è¯´ä¼šæ¯”æ–°ç”Ÿä»£ GC æ›´è€—æ—¶ï¼Œå› æ­¤ï¼Œå‡å°‘è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡æ•°é‡å¯ä»¥æ˜¾è‘—é™ä½ Full GC çš„é¢‘ç‡ã€‚ä½ å¯èƒ½ä¼šä»¥ä¸ºå‡å°‘è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡æ•°é‡æ„å‘³ç€æŠŠå®ƒä»¬ç•™åœ¨æ–°ç”Ÿä»£ï¼Œäº‹å®æ­£å¥½ç›¸åï¼Œæ–°ç”Ÿä»£å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ã€‚

#### é™ä½ Full GC çš„æ—¶é—´

Full GC çš„æ‰§è¡Œæ—¶é—´æ¯” Minor GC è¦é•¿å¾ˆå¤šï¼Œå› æ­¤ï¼Œå¦‚æœåœ¨ Full GC ä¸ŠèŠ±è´¹è¿‡å¤šçš„æ—¶é—´ï¼ˆè¶…è¿‡ 1sï¼‰ï¼Œå°†å¯èƒ½å‡ºç°è¶…æ—¶é”™è¯¯ã€‚

- å¦‚æœ**é€šè¿‡å‡å°è€å¹´ä»£å†…å­˜æ¥å‡å°‘ Full GC æ—¶é—´**ï¼Œå¯èƒ½ä¼šå¼•èµ· `OutOfMemoryError` æˆ–è€…å¯¼è‡´ Full GC çš„é¢‘ç‡å‡é«˜ã€‚
- å¦å¤–ï¼Œå¦‚æœ**é€šè¿‡å¢åŠ è€å¹´ä»£å†…å­˜æ¥é™ä½ Full GC çš„é¢‘ç‡**ï¼ŒFull GC çš„æ—¶é—´å¯èƒ½å› æ­¤å¢åŠ ã€‚

å› æ­¤ï¼Œä½ **éœ€è¦æŠŠè€å¹´ä»£çš„å¤§å°è®¾ç½®æˆä¸€ä¸ªâ€œåˆé€‚â€çš„å€¼**ã€‚

**GC ä¼˜åŒ–éœ€è¦è€ƒè™‘çš„ JVM å‚æ•°**

| **ç±»å‹**       | **å‚æ•°**            | **æè¿°**                      |
| -------------- | ------------------- | ----------------------------- |
| å †å†…å­˜å¤§å°     | `-Xms`              | å¯åŠ¨ JVM æ—¶å †å†…å­˜çš„å¤§å°       |
|                | `-Xmx`              | å †å†…å­˜æœ€å¤§é™åˆ¶                |
| æ–°ç”Ÿä»£ç©ºé—´å¤§å° | `-XX:NewRatio`      | æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„å†…å­˜æ¯”        |
|                | `-XX:NewSize`       | æ–°ç”Ÿä»£å†…å­˜å¤§å°                |
|                | `-XX:SurvivorRatio` | Eden åŒºå’Œ Survivor åŒºçš„å†…å­˜æ¯” |

GC ä¼˜åŒ–æ—¶æœ€å¸¸ç”¨çš„å‚æ•°æ˜¯`-Xms`,`-Xmx`å’Œ`-XX:NewRatio`ã€‚`-Xms`å’Œ`-Xmx`å‚æ•°é€šå¸¸æ˜¯å¿…é¡»çš„ï¼Œæ‰€ä»¥`NewRatio`çš„å€¼å°†å¯¹ GC æ€§èƒ½äº§ç”Ÿé‡è¦çš„å½±å“ã€‚

æœ‰äº›äººå¯èƒ½ä¼šé—®**å¦‚ä½•è®¾ç½®æ°¸ä¹…ä»£å†…å­˜å¤§å°**ï¼Œä½ å¯ä»¥ç”¨`-XX:PermSize`å’Œ`-XX:MaxPermSize`å‚æ•°æ¥è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯è¦è®°ä½ï¼Œåªæœ‰å½“å‡ºç°`OutOfMemoryError`é”™è¯¯æ—¶ä½ æ‰éœ€è¦å»è®¾ç½®æ°¸ä¹…ä»£å†…å­˜ã€‚

### GC ä¼˜åŒ–çš„è¿‡ç¨‹

GC ä¼˜åŒ–çš„è¿‡ç¨‹å’Œå¤§å¤šæ•°å¸¸è§çš„æå‡æ€§èƒ½çš„è¿‡ç¨‹ç›¸ä¼¼ï¼Œä¸‹é¢æ˜¯ç¬”è€…ä½¿ç”¨çš„æµç¨‹ï¼š

#### 1.ç›‘æ§ GC çŠ¶æ€

ä½ éœ€è¦ç›‘æ§ GC ä»è€Œæ£€æŸ¥ç³»ç»Ÿä¸­è¿è¡Œçš„ GC çš„å„ç§çŠ¶æ€ã€‚

#### 2.åˆ†æç›‘æ§ç»“æœåå†³å®šæ˜¯å¦éœ€è¦ä¼˜åŒ– GC

åœ¨æ£€æŸ¥ GC çŠ¶æ€åï¼Œä½ éœ€è¦åˆ†æç›‘æ§ç»“æ„å¹¶å†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œ GC ä¼˜åŒ–ã€‚å¦‚æœåˆ†æç»“æœæ˜¾ç¤ºè¿è¡Œ GC çš„æ—¶é—´åªæœ‰ 0.1-0.3 ç§’ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦æŠŠæ—¶é—´æµªè´¹åœ¨ GC ä¼˜åŒ–ä¸Šï¼Œä½†å¦‚æœè¿è¡Œ GC çš„æ—¶é—´è¾¾åˆ° 1-3 ç§’ï¼Œç”šè‡³å¤§äº 10 ç§’ï¼Œé‚£ä¹ˆ GC ä¼˜åŒ–å°†æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ å·²ç»åˆ†é…äº†å¤§çº¦ 10GB å†…å­˜ç»™ Javaï¼Œå¹¶ä¸”è¿™äº›å†…å­˜æ— æ³•çœä¸‹ï¼Œé‚£ä¹ˆå°±æ— æ³•è¿›è¡Œ GC ä¼˜åŒ–äº†ã€‚åœ¨è¿›è¡Œ GC ä¼˜åŒ–ä¹‹å‰ï¼Œä½ éœ€è¦è€ƒè™‘ä¸ºä»€ä¹ˆä½ éœ€è¦åˆ†é…è¿™ä¹ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä½ åˆ†é…äº† 1GB æˆ– 2GB å¤§å°çš„å†…å­˜å¹¶ä¸”å‡ºç°äº†`OutOfMemoryError`ï¼Œé‚£ä½ å°±åº”è¯¥æ‰§è¡Œ**å †å¿«ç…§ï¼ˆheap dumpï¼‰**æ¥æ¶ˆé™¤å¯¼è‡´å¼‚å¸¸çš„åŸå› ã€‚

> ğŸ”” æ³¨æ„ï¼š

> **å †å¿«ç…§ï¼ˆheap dumpï¼‰**æ˜¯ä¸€ä¸ªç”¨æ¥æ£€æŸ¥ Java å†…å­˜ä¸­çš„å¯¹è±¡å’Œæ•°æ®çš„å†…å­˜æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å¯ä»¥é€šè¿‡æ‰§è¡Œ JDK ä¸­çš„`jmap`å‘½ä»¤æ¥åˆ›å»ºã€‚åœ¨åˆ›å»ºæ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰ Java ç¨‹åºéƒ½å°†æš‚åœï¼Œå› æ­¤ï¼Œä¸è¦åœ¨ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºè¯¥æ–‡ä»¶ã€‚

> ä½ å¯ä»¥åœ¨äº’è”ç½‘ä¸Šæœç´¢ heap dump çš„è¯¦ç»†è¯´æ˜ã€‚

#### 3.è®¾ç½® GC ç±»å‹/å†…å­˜å¤§å°

å¦‚æœä½ å†³å®šè¦è¿›è¡Œ GC ä¼˜åŒ–ï¼Œé‚£ä¹ˆä½ éœ€è¦é€‰æ‹©ä¸€ä¸ª GC ç±»å‹å¹¶ä¸”ä¸ºå®ƒè®¾ç½®å†…å­˜å¤§å°ã€‚æ­¤æ—¶å¦‚æœä½ æœ‰å¤šä¸ªæœåŠ¡å™¨ï¼Œè¯·å¦‚ä¸Šæ–‡æåˆ°çš„é‚£æ ·ï¼Œåœ¨æ¯å°æœºå™¨ä¸Šè®¾ç½®ä¸åŒçš„ GC å‚æ•°å¹¶åˆ†æå®ƒä»¬çš„åŒºåˆ«ã€‚

#### 4.åˆ†æç»“æœ

åœ¨è®¾ç½®å®Œ GC å‚æ•°åå°±å¯ä»¥å¼€å§‹æ”¶é›†æ•°æ®ï¼Œè¯·åœ¨æ”¶é›†è‡³å°‘ 24 å°æ—¶åå†è¿›è¡Œç»“æœåˆ†æã€‚å¦‚æœä½ è¶³å¤Ÿå¹¸è¿ï¼Œä½ å¯èƒ½ä¼šæ‰¾åˆ°ç³»ç»Ÿçš„æœ€ä½³ GC å‚æ•°ã€‚å¦‚è‹¥ä¸ç„¶ï¼Œä½ è¿˜éœ€è¦åˆ†æè¾“å‡ºæ—¥å¿—å¹¶æ£€æŸ¥åˆ†é…çš„å†…å­˜ï¼Œç„¶åéœ€è¦é€šè¿‡ä¸æ–­è°ƒæ•´ GC ç±»å‹/å†…å­˜å¤§å°æ¥æ‰¾åˆ°ç³»ç»Ÿçš„æœ€ä½³å‚æ•°ã€‚

#### 5.å¦‚æœç»“æœä»¤äººæ»¡æ„ï¼Œå°†å‚æ•°åº”ç”¨åˆ°æ‰€æœ‰æœåŠ¡å™¨ä¸Šå¹¶ç»“æŸ GC ä¼˜åŒ–

å¦‚æœ GC ä¼˜åŒ–çš„ç»“æœä»¤äººæ»¡æ„ï¼Œå°±å¯ä»¥å°†å‚æ•°åº”ç”¨åˆ°æ‰€æœ‰æœåŠ¡å™¨ä¸Šï¼Œå¹¶åœæ­¢ GC ä¼˜åŒ–ã€‚

åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸Šè¿°æ¯ä¸€æ­¥æ‰€åšçš„å…·ä½“å·¥ä½œã€‚

## äºŒã€å…¸å‹é…ç½®

### å †å¤§å°è®¾ç½®

**å¹´è½»ä»£çš„è®¾ç½®å¾ˆå…³é”®ã€‚**

JVM ä¸­æœ€å¤§å †å¤§å°æœ‰ä¸‰æ–¹é¢é™åˆ¶ï¼š

1. ç›¸å…³æ“ä½œç³»ç»Ÿçš„æ•°æ®æ¨¡å‹ï¼ˆ32-bt è¿˜æ˜¯ 64-bitï¼‰é™åˆ¶ï¼›
2. ç³»ç»Ÿçš„å¯ç”¨è™šæ‹Ÿå†…å­˜é™åˆ¶ï¼›
3. ç³»ç»Ÿçš„å¯ç”¨ç‰©ç†å†…å­˜é™åˆ¶ã€‚

```
æ•´ä¸ªå †å¤§å° = å¹´è½»ä»£å¤§å° + å¹´è€ä»£å¤§å° + æŒä¹…ä»£å¤§å°
```

- æŒä¹…ä»£ä¸€èˆ¬å›ºå®šå¤§å°ä¸º `64m`ã€‚ä½¿ç”¨ `-XX:PermSize` è®¾ç½®ã€‚
- å®˜æ–¹æ¨èå¹´è½»ä»£å æ•´ä¸ªå †çš„ 3/8ã€‚ä½¿ç”¨ `-Xmn` è®¾ç½®ã€‚

### å›æ”¶å™¨é€‰æ‹©

JVM ç»™äº†ä¸‰ç§é€‰æ‹©ï¼šä¸²è¡Œæ”¶é›†å™¨ã€å¹¶è¡Œæ”¶é›†å™¨ã€å¹¶å‘æ”¶é›†å™¨ã€‚

## ä¸‰ã€åˆ†æ GC æ—¥å¿—

### è·å– GC æ—¥å¿—

è·å– GC æ—¥å¿—æœ‰ä¸¤ç§æ–¹å¼ï¼š

- ä½¿ç”¨å‘½ä»¤åŠ¨æ€æŸ¥çœ‹
- åœ¨å®¹å™¨ä¸­è®¾ç½®ç›¸å…³å‚æ•°æ‰“å° GC æ—¥å¿—

`jstat -gc` ç»Ÿè®¡åƒåœ¾å›æ”¶å †çš„è¡Œä¸ºï¼š

```java
jstat -gc 1262
 S0C    S1C     S0U     S1U   EC       EU        OC         OU        PC       PU         YGC    YGCT    FGC    FGCT     GCT
26112.0 24064.0 6562.5  0.0   564224.0 76274.5   434176.0   388518.3  524288.0 42724.7    320    6.417   1      0.398    6.815
```

ä¹Ÿå¯ä»¥è®¾ç½®é—´éš”å›ºå®šæ—¶é—´æ¥æ‰“å°ï¼š

```shell
jstat -gc 1262 2000 20
```

è¿™ä¸ªå‘½ä»¤æ„æ€å°±æ˜¯æ¯éš” 2000ms è¾“å‡º 1262 çš„ gc æƒ…å†µï¼Œä¸€å…±è¾“å‡º 20 æ¬¡

Tomcat è®¾ç½®ç¤ºä¾‹ï¼š

```shell
JAVA_OPTS="-server -Xms2000m -Xmx2000m -Xmn800m -XX:PermSize=64m -XX:MaxPermSize=256m -XX:SurvivorRatio=4
-verbose:gc -Xloggc:$CATALINA_HOME/logs/gc.log
-Djava.awt.headless=true
-XX:+PrintGCTimeStamps -XX:+PrintGCDetails
-Dsun.rmi.dgc.server.gcInterval=600000 -Dsun.rmi.dgc.client.gcInterval=600000
-XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=15"
```

- `-Xms2000m -Xmx2000m -Xmn800m -XX:PermSize=64m -XX:MaxPermSize=256m`
  Xmsï¼Œå³ä¸º jvm å¯åŠ¨æ—¶å¾— JVM åˆå§‹å †å¤§å°,Xmx ä¸º jvm çš„æœ€å¤§å †å¤§å°ï¼Œxmn ä¸ºæ–°ç”Ÿä»£çš„å¤§å°ï¼Œpermsize ä¸ºæ°¸ä¹…ä»£çš„åˆå§‹å¤§å°ï¼ŒMaxPermSize ä¸ºæ°¸ä¹…ä»£çš„æœ€å¤§ç©ºé—´ã€‚
- `-XX:SurvivorRatio=4`
  SurvivorRatio ä¸ºæ–°ç”Ÿä»£ç©ºé—´ä¸­çš„ Eden åŒºå’Œæ•‘åŠ©ç©ºé—´ Survivor åŒºçš„å¤§å°æ¯”å€¼ï¼Œé»˜è®¤æ˜¯ 8ï¼Œåˆ™ä¸¤ä¸ª Survivor åŒºä¸ä¸€ä¸ª Eden åŒºçš„æ¯”å€¼ä¸º 2:8,ä¸€ä¸ª Survivor åŒºå æ•´ä¸ªå¹´è½»ä»£çš„ 1/10ã€‚è°ƒå°è¿™ä¸ªå‚æ•°å°†å¢å¤§ survivor åŒºï¼Œè®©å¯¹è±¡å°½é‡åœ¨ survitor åŒºå‘†é•¿ä¸€ç‚¹ï¼Œå‡å°‘è¿›å…¥å¹´è€ä»£çš„å¯¹è±¡ã€‚å»æ‰æ•‘åŠ©ç©ºé—´çš„æƒ³æ³•æ˜¯è®©å¤§éƒ¨åˆ†ä¸èƒ½é©¬ä¸Šå›æ”¶çš„æ•°æ®å°½å¿«è¿›å…¥å¹´è€ä»£ï¼ŒåŠ å¿«å¹´è€ä»£çš„å›æ”¶é¢‘ç‡ï¼Œå‡å°‘å¹´è€ä»£æš´æ¶¨çš„å¯èƒ½æ€§ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡å°†-XX:SurvivorRatio è®¾ç½®æˆæ¯”è¾ƒå¤§çš„å€¼ï¼ˆæ¯”å¦‚ 65536)æ¥åšåˆ°ã€‚
- `-verbose:gc -Xloggc:$CATALINA_HOME/logs/gc.log`
  å°†è™šæ‹Ÿæœºæ¯æ¬¡åƒåœ¾å›æ”¶çš„ä¿¡æ¯å†™åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶åç”± file æŒ‡å®šï¼Œæ–‡ä»¶æ ¼å¼æ˜¯å¹³æ–‡ä»¶ï¼Œå†…å®¹å’Œ-verbose:gc è¾“å‡ºå†…å®¹ç›¸åŒã€‚
- `-Djava.awt.headless=true` Headless æ¨¡å¼æ˜¯ç³»ç»Ÿçš„ä¸€ç§é…ç½®æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿç¼ºå°‘äº†æ˜¾ç¤ºè®¾å¤‡ã€é”®ç›˜æˆ–é¼ æ ‡ã€‚
- `-XX:+PrintGCTimeStamps -XX:+PrintGCDetails`
  è®¾ç½® gc æ—¥å¿—çš„æ ¼å¼
- `-Dsun.rmi.dgc.server.gcInterval=600000 -Dsun.rmi.dgc.client.gcInterval=600000`
  æŒ‡å®š rmi è°ƒç”¨æ—¶ gc çš„æ—¶é—´é—´éš”
- `-XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=15` é‡‡ç”¨å¹¶å‘ gc æ–¹å¼ï¼Œç»è¿‡ 15 æ¬¡ minor gc åè¿›å…¥å¹´è€ä»£

### å¦‚ä½•åˆ†æ GC æ—¥å¿—

Young GC å›æ”¶æ—¥å¿—:

```java
2016-07-05T10:43:18.093+0800: 25.395: [GC [PSYoungGen: 274931K->10738K(274944K)] 371093K->147186K(450048K), 0.0668480 secs] [Times: user=0.17 sys=0.08, real=0.07 secs]
```

Full GC å›æ”¶æ—¥å¿—:

```java
2016-07-05T10:43:18.160+0800: 25.462: [Full GC [PSYoungGen: 10738K->0K(274944K)] [ParOldGen: 136447K->140379K(302592K)] 147186K->140379K(577536K) [PSPermGen: 85411K->85376K(171008K)], 0.6763541 secs] [Times: user=1.75 sys=0.02, real=0.68 secs]
```

é€šè¿‡ä¸Šé¢æ—¥å¿—åˆ†æå¾—å‡ºï¼ŒPSYoungGenã€ParOldGenã€PSPermGen å±äº Parallel æ”¶é›†å™¨ã€‚å…¶ä¸­ PSYoungGen è¡¨ç¤º gc å›æ”¶å‰åå¹´è½»ä»£çš„å†…å­˜å˜åŒ–ï¼›ParOldGen è¡¨ç¤º gc å›æ”¶å‰åè€å¹´ä»£çš„å†…å­˜å˜åŒ–ï¼›PSPermGen è¡¨ç¤º gc å›æ”¶å‰åæ°¸ä¹…åŒºçš„å†…å­˜å˜åŒ–ã€‚young gc ä¸»è¦æ˜¯é’ˆå¯¹å¹´è½»ä»£è¿›è¡Œå†…å­˜å›æ”¶æ¯”è¾ƒé¢‘ç¹ï¼Œè€—æ—¶çŸ­ï¼›full gc ä¼šå¯¹æ•´ä¸ªå †å†…å­˜è¿›è¡Œå›åŸï¼Œè€—æ—¶é•¿ï¼Œå› æ­¤ä¸€èˆ¬å°½é‡å‡å°‘ full gc çš„æ¬¡æ•°

é€šè¿‡ä¸¤å¼ å›¾éå¸¸æ˜æ˜¾çœ‹å‡º gc æ—¥å¿—æ„æˆï¼š

![img](http://ityouknow.com/assets/images/2017/jvm/Young%20GC.png)

![img](http://ityouknow.com/assets/images/2017/jvm/Full%20GC.png)

#### CPU è¿‡é«˜

å®šä½æ­¥éª¤ï¼š

ï¼ˆ1ï¼‰æ‰§è¡Œ top -c å‘½ä»¤ï¼Œæ‰¾åˆ° cpu æœ€é«˜çš„è¿›ç¨‹çš„ id

ï¼ˆ2ï¼‰jstack PID å¯¼å‡º Java åº”ç”¨ç¨‹åºçš„çº¿ç¨‹å †æ ˆä¿¡æ¯ã€‚

ç¤ºä¾‹ï¼š

```java
jstack 6795

"Low Memory Detector" daemon prio=10 tid=0x081465f8 nid=0x7 runnable [0x00000000..0x00000000]
        "CompilerThread0" daemon prio=10 tid=0x08143c58 nid=0x6 waiting on condition [0x00000000..0xfb5fd798]
        "Signal Dispatcher" daemon prio=10 tid=0x08142f08 nid=0x5 waiting on condition [0x00000000..0x00000000]
        "Finalizer" daemon prio=10 tid=0x08137ca0 nid=0x4 in Object.wait() [0xfbeed000..0xfbeeddb8]

        at java.lang.Object.wait(Native Method)

        - waiting on <0xef600848> (a java.lang.ref.ReferenceQueue$Lock)

        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:116)

        - locked <0xef600848> (a java.lang.ref.ReferenceQueue$Lock)

        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:132)

        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)

        "Reference Handler" daemon prio=10 tid=0x081370f0 nid=0x3 in Object.wait() [0xfbf4a000..0xfbf4aa38]

        at java.lang.Object.wait(Native Method)

        - waiting on <0xef600758> (a java.lang.ref.Reference$Lock)

        at java.lang.Object.wait(Object.java:474)

        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)

        - locked <0xef600758> (a java.lang.ref.Reference$Lock)

        "VM Thread" prio=10 tid=0x08134878 nid=0x2 runnable

        "VM Periodic Task Thread" prio=10 tid=0x08147768 nid=0x8 waiting on condition
```

åœ¨æ‰“å°çš„å †æ ˆæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œtid å’Œ nid çš„å«ä¹‰ï¼š

```
nid : å¯¹åº”çš„ Linux æ“ä½œç³»ç»Ÿä¸‹çš„ tid çº¿ç¨‹å·ï¼Œä¹Ÿå°±æ˜¯å‰é¢è½¬åŒ–çš„ 16 è¿›åˆ¶æ•°å­—
tid: è¿™ä¸ªåº”è¯¥æ˜¯ jvm çš„ jmm å†…å­˜è§„èŒƒä¸­çš„å”¯ä¸€åœ°å€å®šä½
```

åœ¨ CPU è¿‡é«˜çš„æƒ…å†µä¸‹ï¼ŒæŸ¥æ‰¾å“åº”çš„çº¿ç¨‹ï¼Œä¸€èˆ¬å®šä½éƒ½æ˜¯ç”¨ nid æ¥å®šä½çš„ã€‚è€Œå¦‚æœå‘ç”Ÿæ­»é”ä¹‹ç±»çš„é—®é¢˜ï¼Œä¸€èˆ¬ç”¨ tid æ¥å®šä½ã€‚

ï¼ˆ3ï¼‰å®šä½ CPU é«˜çš„çº¿ç¨‹æ‰“å°å…¶ nid

æŸ¥çœ‹çº¿ç¨‹ä¸‹å…·ä½“è¿›ç¨‹ä¿¡æ¯çš„å‘½ä»¤å¦‚ä¸‹ï¼š

top -H -p 6735

```java
top - 14:20:09 up 611 days,  2:56,  1 user,  load average: 13.19, 7.76, 7.82
Threads: 6991 total,  17 running, 6974 sleeping,   0 stopped,   0 zombie
%Cpu(s): 90.4 us,  2.1 sy,  0.0 ni,  7.0 id,  0.0 wa,  0.0 hi,  0.4 si,  0.0 st
KiB Mem:  32783044 total, 32505008 used,   278036 free,   120304 buffers
KiB Swap:        0 total,        0 used,        0 free. 4497428 cached Mem

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 6800 root      20   0 27.299g 0.021t   7172 S 54.7 70.1 187:55.61 java
 6803 root      20   0 27.299g 0.021t   7172 S 54.4 70.1 187:52.59 java
 6798 root      20   0 27.299g 0.021t   7172 S 53.7 70.1 187:55.08 java
 6801 root      20   0 27.299g 0.021t   7172 S 53.7 70.1 187:55.25 java
 6797 root      20   0 27.299g 0.021t   7172 S 53.1 70.1 187:52.78 java
 6804 root      20   0 27.299g 0.021t   7172 S 53.1 70.1 187:55.76 java
 6802 root      20   0 27.299g 0.021t   7172 S 52.1 70.1 187:54.79 java
 6799 root      20   0 27.299g 0.021t   7172 S 51.8 70.1 187:53.36 java
 6807 root      20   0 27.299g 0.021t   7172 S 13.6 70.1  48:58.60 java
11014 root      20   0 27.299g 0.021t   7172 R  8.4 70.1   8:00.32 java
10642 root      20   0 27.299g 0.021t   7172 R  6.5 70.1   6:32.06 java
 6808 root      20   0 27.299g 0.021t   7172 S  6.1 70.1 159:08.40 java
11315 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   5:54.10 java
12545 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   6:55.48 java
23353 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   2:20.55 java
24868 root      20   0 27.299g 0.021t   7172 S  3.9 70.1   2:12.46 java
 9146 root      20   0 27.299g 0.021t   7172 S  3.6 70.1   7:42.72 java
```

ç”±æ­¤å¯ä»¥çœ‹å‡ºå ç”¨ CPU è¾ƒé«˜çš„çº¿ç¨‹ï¼Œä½†æ˜¯è¿™äº›è¿˜ä¸é«˜ï¼Œæ— æ³•ç›´æ¥å®šä½åˆ°å…·ä½“çš„ç±»ã€‚nid æ˜¯ 16 è¿›åˆ¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è·å–çº¿ç¨‹çš„ 16 è¿›åˆ¶ IDï¼š

```
printf "%x\n" 6800
```

```
è¾“å‡ºç»“æœ:45cd
```

ç„¶åæ ¹æ®è¾“å‡ºç»“æœåˆ° jstack æ‰“å°çš„å †æ ˆæ—¥å¿—ä¸­æŸ¥å®šä½ï¼š

```java
"catalina-exec-5692" daemon prio=10 tid=0x00007f3b05013800 nid=0x45cd waiting on condition [0x00007f3ae08e3000]
   java.lang.Thread.State: TIMED_WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  <0x00000006a7800598> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2082)
        at java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:467)
        at org.apache.tomcat.util.threads.TaskQueue.poll(TaskQueue.java:86)
        at org.apache.tomcat.util.threads.TaskQueue.poll(TaskQueue.java:32)
        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
        at java.lang.Thread.run(Thread.java:745)
```

## é™„å½• - å¸¸ç”¨ HotSpot VM å‚æ•°

##

> è¯¦ç»†å‚æ•°è¯´æ˜è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[JavaHotSpot VM Options](http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html)ï¼Œè¿™é‡Œä»…åˆ—ä¸¾å¸¸ç”¨å‚æ•°ã€‚

### JVM å†…å­˜é…ç½®

| é…ç½®                | æè¿°                                                                                                               |
| ------------------- | ------------------------------------------------------------------------------------------------------------------ |
| `-Xss`              | è™šæ‹Ÿæœºæ ˆå¤§å°ã€‚                                                                                                     |
| `-Xms`              | å †ç©ºé—´åˆå§‹å€¼ã€‚                                                                                                     |
| `-Xmx`              | å †ç©ºé—´æœ€å¤§å€¼ã€‚                                                                                                     |
| `-Xmn`              | æ–°ç”Ÿä»£ç©ºé—´å¤§å°ã€‚                                                                                                   |
| `-XX:NewSize`       | æ–°ç”Ÿä»£ç©ºé—´åˆå§‹å€¼ã€‚                                                                                                 |
| `-XX:MaxNewSize`    | æ–°ç”Ÿä»£ç©ºé—´æœ€å¤§å€¼ã€‚                                                                                                 |
| `-XX:NewRatio`      | æ–°ç”Ÿä»£ä¸å¹´è€ä»£çš„æ¯”ä¾‹ã€‚é»˜è®¤ä¸º 2ï¼Œæ„å‘³ç€è€å¹´ä»£æ˜¯æ–°ç”Ÿä»£çš„ 2 å€ã€‚                                                      |
| `-XX:SurvivorRatio` | æ–°ç”Ÿä»£ä¸­è°ƒæ•´ eden åŒºä¸ survivor åŒºçš„æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º 8ã€‚å³ `eden` åŒºä¸º 80% çš„å¤§å°ï¼Œä¸¤ä¸ª `survivor` åˆ†åˆ«ä¸º 10% çš„å¤§å°ã€‚ |
| `-XX:PermSize`      | æ°¸ä¹…ä»£ç©ºé—´çš„åˆå§‹å€¼ã€‚                                                                                               |
| `-XX:MaxPermSize`   | æ°¸ä¹…ä»£ç©ºé—´çš„æœ€å¤§å€¼ã€‚                                                                                               |

### GC ç±»å‹é…ç½®

| é…ç½®                        | æè¿°                                                 |
| --------------------------- | ---------------------------------------------------- |
| `-XX:+UseSerialGC`          | ä½¿ç”¨ Serial + Serial Old åƒåœ¾å›æ”¶å™¨ç»„åˆ              |
| `-XX:+UseParallelGC`        | ä½¿ç”¨ Parallel Scavenge + Parallel Old åƒåœ¾å›æ”¶å™¨ç»„åˆ |
| ~~`-XX:+UseParallelOldGC`~~ | ~~ä½¿ç”¨ Parallel Old åƒåœ¾å›æ”¶å™¨ï¼ˆJDK5 åå·²æ— ç”¨ï¼‰~~    |
| `-XX:+UseParNewGC`          | ä½¿ç”¨ ParNew + Serial Old åƒåœ¾å›æ”¶å™¨                  |
| `-XX:+UseConcMarkSweepGC`   | ä½¿ç”¨ CMS + ParNew + Serial Old åƒåœ¾å›æ”¶å™¨ç»„åˆ        |
| `-XX:+UseG1GC`              | ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨                                   |
| `-XX:ParallelCMSThreads`    | å¹¶å‘æ ‡è®°æ‰«æåƒåœ¾å›æ”¶å™¨ = ä¸ºä½¿ç”¨çš„çº¿ç¨‹æ•°é‡            |

### åƒåœ¾å›æ”¶å™¨é€šç”¨å‚æ•°

| é…ç½®                     | æè¿°                                                                                                  |
| ------------------------ | ----------------------------------------------------------------------------------------------------- |
| `PretenureSizeThreshold` | æ™‹å‡å¹´è€ä»£çš„å¯¹è±¡å¤§å°ã€‚é»˜è®¤ä¸º 0ã€‚æ¯”å¦‚è®¾ä¸º 10Mï¼Œåˆ™è¶…è¿‡ 10M çš„å¯¹è±¡å°†ä¸åœ¨ eden åŒºåˆ†é…ï¼Œè€Œç›´æ¥è¿›å…¥å¹´è€ä»£ã€‚ |
| `MaxTenuringThreshold`   | æ™‹å‡è€å¹´ä»£çš„æœ€å¤§å¹´é¾„ã€‚é»˜è®¤ä¸º 15ã€‚æ¯”å¦‚è®¾ä¸º 10ï¼Œåˆ™å¯¹è±¡åœ¨ 10 æ¬¡æ™®é€š GC åå°†ä¼šè¢«æ”¾å…¥å¹´è€ä»£ã€‚              |
| `DisableExplicitGC`      | ç¦ç”¨ `System.gc()`                                                                                    |

### JMX

å¼€å¯ JMX åï¼Œå¯ä»¥ä½¿ç”¨ `jconsole` æˆ– `jvisualvm` è¿›è¡Œç›‘æ§ Java ç¨‹åºçš„åŸºæœ¬ä¿¡æ¯å’Œè¿è¡Œæƒ…å†µã€‚

```java
-Dcom.sun.management.jmxremote=true
-Dcom.sun.management.jmxremote.ssl=false
-Dcom.sun.management.jmxremote.authenticate=false
-Djava.rmi.server.hostname=127.0.0.1
-Dcom.sun.management.jmxremote.port=18888
```

`-Djava.rmi.server.hostname` æŒ‡å®š Java ç¨‹åºè¿è¡Œçš„æœåŠ¡å™¨ï¼Œ`-Dcom.sun.management.jmxremote.port` æŒ‡å®šæœåŠ¡ç›‘å¬ç«¯å£ã€‚

### è¿œç¨‹ DEBUG

å¦‚æœå¼€å¯ Java åº”ç”¨çš„è¿œç¨‹ Debug åŠŸèƒ½ï¼Œéœ€è¦æŒ‡å®šå¦‚ä¸‹å‚æ•°ï¼š

```java
-Xdebug
-Xnoagent
-Djava.compiler=NONE
-Xrunjdwp:transport=dt_socket,address=28888,server=y,suspend=n
```

address å³ä¸ºè¿œç¨‹ debug çš„ç›‘å¬ç«¯å£ã€‚

### HeapDump

```java
-XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError
```

### è¾…åŠ©é…ç½®

| é…ç½®                              | æè¿°                     |
| --------------------------------- | ------------------------ |
| `-XX:+PrintGCDetails`             | æ‰“å° GC æ—¥å¿—             |
| `-Xloggc:<filename>`              | æŒ‡å®š GC æ—¥å¿—æ–‡ä»¶å       |
| `-XX:+HeapDumpOnOutOfMemoryError` | å†…å­˜æº¢å‡ºæ—¶è¾“å‡ºå †å¿«ç…§æ–‡ä»¶ |

## å‚è€ƒèµ„æ–™

- [ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹](https://item.jd.com/11252778.html)
- [ä»è¡¨åˆ°é‡Œå­¦ä¹  JVM å®ç°](https://www.douban.com/doulist/2545443/)
- [JVMï¼ˆ4ï¼‰ï¼šJvm è°ƒä¼˜-å‘½ä»¤ç¯‡](http://www.importnew.com/23761.html)
- [Java ç³»åˆ—ç¬”è®°(4) - JVM ç›‘æ§ä¸è°ƒä¼˜](https://www.cnblogs.com/zhguang/p/Java-JVM-GC.html)
- [Java æœåŠ¡ GC å‚æ•°è°ƒä¼˜æ¡ˆä¾‹](https://segmentfault.com/a/1190000005174819)
- [JVM è°ƒä¼˜æ€»ç»“ï¼ˆ5ï¼‰ï¼šå…¸å‹é…ç½®](http://www.importnew.com/19264.html)
- [å¦‚ä½•åˆç†çš„è§„åˆ’ä¸€æ¬¡ jvm æ€§èƒ½è°ƒä¼˜](https://juejin.im/post/59f02f406fb9a0451869f01c)
- [jvm ç³»åˆ—(ä¹):å¦‚ä½•ä¼˜åŒ– Java GCã€Œè¯‘ã€](http://www.ityouknow.com/jvm/2017/09/21/How-to-optimize-Java-GC.html)
- https://my.oschina.net/feichexia/blog/196575
