# Java å†…å­˜åŒºåŸŸ

> **ğŸ“¦ æœ¬æ–‡ä»¥åŠç¤ºä¾‹æºç å·²å½’æ¡£åœ¨ [javacore](https://dunwu.github.io/javacore/#/)**

<!-- TOC depthFrom:2 depthTo:3 -->

- [ä¸€ã€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ](#ä¸€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ)
  - [ç¨‹åºè®¡æ•°å™¨](#ç¨‹åºè®¡æ•°å™¨)
  - [Java è™šæ‹Ÿæœºæ ˆ](#java-è™šæ‹Ÿæœºæ ˆ)
  - [æœ¬åœ°æ–¹æ³•æ ˆ](#æœ¬åœ°æ–¹æ³•æ ˆ)
  - [Java å †](#java-å †)
  - [æ–¹æ³•åŒº](#æ–¹æ³•åŒº)
  - [è¿è¡Œæ—¶å¸¸é‡æ± ](#è¿è¡Œæ—¶å¸¸é‡æ± )
  - [ç›´æ¥å†…å­˜](#ç›´æ¥å†…å­˜)
  - [Java å†…å­˜åŒºåŸŸå¯¹æ¯”](#java-å†…å­˜åŒºåŸŸå¯¹æ¯”)
- [äºŒã€OutOfMemoryError](#äºŒoutofmemoryerror)
  - [Java å †æº¢å‡º](#java-å †æº¢å‡º)
  - [è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º](#è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º)
  - [æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º](#æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º)
  - [ç›´æ¥å†…å­˜æº¢å‡º](#ç›´æ¥å†…å­˜æº¢å‡º)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

<!-- /TOC -->

## ä¸€ã€è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ

JVM åœ¨æ‰§è¡Œ Java ç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªä¸åŒçš„æ•°æ®åŒºåŸŸã€‚è¿™äº›åŒºåŸŸéƒ½æœ‰å„è‡ªçš„ç”¨é€”ï¼Œä»¥åŠåˆ›å»ºå’Œé”€æ¯çš„æ—¶é—´ï¼Œæœ‰çš„åŒºåŸŸéšç€è™šæ‹Ÿæœºè¿›ç¨‹çš„å¯åŠ¨è€Œå­˜åœ¨ï¼Œæœ‰äº›åŒºåŸŸåˆ™ä¾èµ–ç”¨æˆ·çº¿ç¨‹çš„å¯åŠ¨å’Œç»“æŸè€Œå»ºç«‹å’Œé”€æ¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://dunwu.test.upcdn.net/cs/java/javacore/jvm/jvm-memory-runtime-data-area.png!zp)

### ç¨‹åºè®¡æ•°å™¨

**`ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰`** æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒå¯ä»¥çœ‹åšæ˜¯**å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨**ã€‚

ä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹é—´çš„è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸º â€œçº¿ç¨‹ç§æœ‰â€ çš„å†…å­˜ã€‚

- å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Java æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼›
- å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯ Native æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™ä¸ºç©ºï¼ˆUndefinedï¼‰ã€‚

> ğŸ”” æ³¨æ„ï¼šæ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ JVM ä¸­æ²¡æœ‰è§„å®šä»»ä½• `OutOfMemoryError` æƒ…å†µçš„åŒºåŸŸã€‚

### Java è™šæ‹Ÿæœºæ ˆ

**`Java è™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰`** ä¹Ÿ**æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒ**ã€‚

æ¯ä¸ª Java æ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ç”¨äºå­˜å‚¨ **å±€éƒ¨å˜é‡è¡¨**ã€**æ“ä½œæ•°æ ˆ**ã€**å¸¸é‡æ± å¼•ç”¨** ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•ä»è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚

![img](http://dunwu.test.upcdn.net/cs/java/javacore/jvm/jvm-stack.png!w640)

> ğŸ”” æ³¨æ„ï¼š
>
> è¯¥åŒºåŸŸå¯èƒ½æŠ›å‡ºä»¥ä¸‹å¼‚å¸¸ï¼š
>
> - å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦è¶…è¿‡æœ€å¤§å€¼ï¼Œå°±ä¼šæŠ›å‡º `StackOverflowError` å¼‚å¸¸ï¼›
> - å¦‚æœè™šæ‹Ÿæœºæ ˆè¿›è¡ŒåŠ¨æ€æ‰©å±•æ—¶ï¼Œæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿå†…å­˜ï¼Œå°±ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚
>
> ğŸ’¡ æç¤ºï¼š
>
> å¯ä»¥é€šè¿‡ `-Xss` è¿™ä¸ªè™šæ‹Ÿæœºå‚æ•°æ¥æŒ‡å®šä¸€ä¸ªç¨‹åºçš„ Java è™šæ‹Ÿæœºæ ˆå†…å­˜å¤§å°ï¼š
>
> ```java
> java -Xss=512M HackTheJava
> ```

### æœ¬åœ°æ–¹æ³•æ ˆ

**`æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰`** ä¸è™šæ‹Ÿæœºæ ˆçš„ä½œç”¨ç›¸ä¼¼ã€‚

äºŒè€…çš„åŒºåˆ«åœ¨äºï¼š**è™šæ‹Ÿæœºæ ˆä¸º Java æ–¹æ³•æœåŠ¡ï¼›æœ¬åœ°æ–¹æ³•æ ˆä¸º Native æ–¹æ³•æœåŠ¡**ã€‚

![img](http://dunwu.test.upcdn.net/cs/java/javacore/jvm/jvm-native-method-stack.gif!w640)

> ğŸ”” æ³¨æ„ï¼šæœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šæŠ›å‡º `StackOverflowError` å¼‚å¸¸å’Œ `OutOfMemoryError` å¼‚å¸¸ã€‚

### Java å †

**`Java å †ï¼ˆJava Heapï¼‰` çš„ä½œç”¨å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ†é…å†…å­˜**ã€‚

Java å †æ˜¯åƒåœ¾æ”¶é›†çš„ä¸»è¦åŒºåŸŸï¼ˆå› æ­¤ä¹Ÿè¢«å«åš"GC å †"ï¼‰ã€‚ç°ä»£çš„åƒåœ¾æ”¶é›†å™¨åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨**åˆ†ä»£æ”¶é›†ç®—æ³•**ï¼Œè¯¥ç®—æ³•çš„æ€æƒ³æ˜¯é’ˆå¯¹ä¸åŒçš„å¯¹è±¡é‡‡å–ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚

å› æ­¤è™šæ‹ŸæœºæŠŠ Java å †åˆ†æˆä»¥ä¸‹ä¸‰å—ï¼š

- **`æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰`**
  - `Eden`
  - `From Survivor`
  - `To Survivor`
- **`è€å¹´ä»£ï¼ˆOld Generationï¼‰`**
- **`æ°¸ä¹…ä»£ï¼ˆPermanent Generationï¼‰`**

å½“ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå®ƒé¦–å…ˆè¿›å…¥æ–°ç”Ÿä»£ï¼Œä¹‹åæœ‰å¯èƒ½è¢«è½¬ç§»åˆ°è€å¹´ä»£ä¸­ã€‚æ–°ç”Ÿä»£å­˜æ”¾ç€å¤§é‡çš„ç”Ÿå‘½å¾ˆçŸ­çš„å¯¹è±¡ï¼Œå› æ­¤æ–°ç”Ÿä»£åœ¨ä¸‰ä¸ªåŒºåŸŸä¸­åƒåœ¾å›æ”¶çš„é¢‘ç‡æœ€é«˜ã€‚

![img](http://dunwu.test.upcdn.net/cs/java/javacore/jvm/jvm-heap.gif!w640)

> ğŸ”” æ³¨æ„ï¼šJava å †ä¸éœ€è¦è¿ç»­å†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€æ‰©å±•å…¶å†…å­˜ï¼Œæ‰©å±•å¤±è´¥ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚
>
> ğŸ’¡ æç¤ºï¼šå¯ä»¥é€šè¿‡ `-Xms` å’Œ `-Xmx` ä¸¤ä¸ªè™šæ‹Ÿæœºå‚æ•°æ¥æŒ‡å®šä¸€ä¸ªç¨‹åºçš„ Java å †å†…å­˜å¤§å°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®åˆå§‹å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°è®¾ç½®æœ€å¤§å€¼ã€‚
>
> ```java
> java -Xms=1M -Xmx=2M HackTheJava
> ```

### æ–¹æ³•åŒº

**`æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰` ç”¨äºå­˜æ”¾å·²è¢«åŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®**ã€‚

å¯¹è¿™å—åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶çš„ä¸»è¦ç›®æ ‡æ˜¯å¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹ç±»çš„å¸è½½ï¼Œä½†æ˜¯ä¸€èˆ¬æ¯”è¾ƒéš¾å®ç°ã€‚

> ğŸ”” æ³¨æ„ï¼šå’Œ Java å †ä¸€æ ·ä¸éœ€è¦è¿ç»­çš„å†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€æ‰©å±•ï¼ŒåŠ¨æ€æ‰©å±•å¤±è´¥ä¸€æ ·ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚
>
> ğŸ’¡ æç¤ºï¼šJDK 1.7 ä¹‹å‰ï¼ŒHotSpot è™šæ‹ŸæœºæŠŠå®ƒå½“æˆæ°¸ä¹…ä»£æ¥è¿›è¡Œåƒåœ¾å›æ”¶ï¼ŒJDK 1.8 ä¹‹åï¼Œå–æ¶ˆäº†æ°¸ä¹…ä»£ï¼Œç”¨ **`metaspaceï¼ˆå…ƒæ•°æ®ï¼‰`**åŒºæ›¿ä»£ã€‚

### è¿è¡Œæ—¶å¸¸é‡æ± 

**`è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰` æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†**ï¼ŒClass æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰ï¼Œ**ç”¨äºå­˜æ”¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨**ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šåœ¨ç±»åŠ è½½åè¢«æ”¾å…¥è¿™ä¸ªåŒºåŸŸã€‚

é™¤äº†åœ¨ç¼–è¯‘æœŸç”Ÿæˆçš„å¸¸é‡ï¼Œè¿˜å…è®¸åŠ¨æ€ç”Ÿæˆï¼Œä¾‹å¦‚ `String` ç±»çš„ `intern()`ã€‚è¿™éƒ¨åˆ†å¸¸é‡ä¹Ÿä¼šè¢«æ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ã€‚

> ğŸ”” æ³¨æ„ï¼šå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚

### ç›´æ¥å†…å­˜

ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ JVM è§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚

åœ¨ JDK 1.4 ä¸­æ–°åŠ å…¥äº† NIO ç±»ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨ Java å †é‡Œçš„ `DirectByteBuffer` å¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨ Java å †å’Œ Native å †ä¸­æ¥å›å¤åˆ¶æ•°æ®ã€‚

> ğŸ”” æ³¨æ„ï¼šç›´æ¥å†…å­˜è¿™éƒ¨åˆ†ä¹Ÿè¢«é¢‘ç¹çš„ä½¿ç”¨ï¼Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´ `OutOfMemoryError` å¼‚å¸¸ã€‚
>
> ğŸ’¡ æç¤ºï¼šç›´æ¥å†…å­˜å®¹é‡å¯é€šè¿‡ `-XX:MaxDirectMemorySize` æŒ‡å®šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸ Java å †æœ€å¤§å€¼ï¼ˆ`-Xmx` æŒ‡å®šï¼‰ä¸€æ ·ã€‚

### Java å†…å­˜åŒºåŸŸå¯¹æ¯”

| å†…å­˜åŒºåŸŸ      | å†…å­˜ä½œç”¨èŒƒå›´   | å¼‚å¸¸                                       |
| ------------- | -------------- | ------------------------------------------ |
| ç¨‹åºè®¡æ•°å™¨    | çº¿ç¨‹ç§æœ‰       | æ—                                          |
| Java è™šæ‹Ÿæœºæ ˆ | çº¿ç¨‹ç§æœ‰       | `StackOverflowError` å’Œ `OutOfMemoryError` |
| æœ¬åœ°æ–¹æ³•æ ˆ    | çº¿ç¨‹ç§æœ‰       | `StackOverflowError` å’Œ `OutOfMemoryError` |
| Java å †       | çº¿ç¨‹å…±äº«       | `OutOfMemoryError`                         |
| æ–¹æ³•åŒº        | çº¿ç¨‹å…±äº«       | `OutOfMemoryError`                         |
| è¿è¡Œæ—¶å¸¸é‡æ±   | çº¿ç¨‹å…±äº«       | `OutOfMemoryError`                         |
| ç›´æ¥å†…å­˜      | éè¿è¡Œæ—¶æ•°æ®åŒº | `OutOfMemoryError`                         |

## äºŒã€OutOfMemoryError

åœ¨ JVM è§„èŒƒä¸­ï¼Œ**é™¤äº†ç¨‹åºè®¡æ•°å™¨åŒºåŸŸå¤–ï¼Œå…¶ä»–è¿è¡Œæ—¶åŒºåŸŸéƒ½å¯èƒ½å‘ç”Ÿ `OutOfMemoryError` å¼‚å¸¸ï¼ˆç®€ç§° OOMï¼‰**ã€‚

ä¸‹é¢é€ä¸€ä»‹ç» OOM å‘ç”Ÿåœºæ™¯ã€‚

### Java å †æº¢å‡º

Java å †ç”¨äºå­˜å‚¨å¯¹è±¡å®ä¾‹ã€‚åªè¦ä¸æ–­åœ°åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”ä¿è¯ GC Roots åˆ°å¯¹è±¡ä¹‹é—´æœ‰å¯è¾¾è·¯å¾„æ¥é¿å…åƒåœ¾æ”¶é›†å™¨å›æ”¶è¿™äº›å¯¹è±¡ï¼Œé‚£ä¹ˆå½“å †ç©ºé—´åˆ°è¾¾æœ€å¤§å®¹é‡é™åˆ¶åå°±ä¼šäº§ç”Ÿ OOMã€‚

å½“å‡ºç° OOMï¼Œä¸€èˆ¬æ˜¯å…ˆé€šè¿‡å†…å­˜åˆ†æå·¥å…·ï¼ˆå¦‚ï¼šEclipse Memory Analyzerï¼‰å¯¹ dump æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œå³å…ˆåˆ¤æ–­æ˜¯ **`å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰`** è¿˜æ˜¯ **`å†…å­˜æº¢å‡ºï¼ˆMemory Overflowï¼‰`**ã€‚

- å¦‚æœæ˜¯å†…å­˜æ³„æ¼ï¼Œå¯ä»¥è¿›ä¸€æ­¥æŸ¥çœ‹æ³„æ¼å¯¹è±¡åˆ° GC Roots çš„å¯¹è±¡å¼•ç”¨é“¾ã€‚è¿™æ ·å°±èƒ½æ‰¾åˆ°æ³„æ¼å¯¹è±¡æ˜¯æ€æ ·ä¸ GC Roots å…³è”å¹¶å¯¼è‡´ GC æ— æ³•å›æ”¶å®ƒä»¬çš„ã€‚æŒæ¡äº†è¿™äº›åŸå› ï¼Œå°±å¯ä»¥è¾ƒå‡†ç¡®çš„å®šä½å‡ºå¼•èµ·å†…å­˜æ³„æ¼çš„ä»£ç ã€‚
- å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå³å†…å­˜ä¸­çš„å¯¹è±¡ç¡®å®éƒ½å¿…é¡»å­˜æ´»ç€ï¼Œåˆ™åº”å½“æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ`-Xmx` å’Œ `-Xms`ï¼‰ï¼Œä¸æœºå™¨ç‰©ç†å†…å­˜è¿›è¡Œå¯¹æ¯”ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥è°ƒå¤§ã€‚å¹¶ä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œå°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚

> å¯ä»¥ä½¿ç”¨ `-XX:+HeapDumpOnOutOfMemoryError` å‚æ•°æ¥è®©è™šæ‹Ÿæœºå‡ºç° OOM çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç”Ÿæˆ dump æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­è®°å½•äº†å½“å‰ Java å †çš„å¿«ç…§ä¿¡æ¯ã€‚

ç¤ºä¾‹ï¼š

```java
public class HeapOOM1 {

    public static void main(String[] args) {
        List<OomObject> list = new ArrayList<>();
        while (true) {
            list.add(new OomObject());
        }
    }

    static class OomObject {}

}
```

æ‰§è¡Œ `java -verbose:gc -Xms10M -Xmx10M -XX:+HeapDumpOnOutOfMemoryError io.github.dunwu.javacore.jvm.memory.HeapOutOfMemoryDemo`

### è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º

å¯¹äº HotSpot è™šæ‹Ÿæœºæ¥è¯´ï¼Œæ ˆå®¹é‡åªç”± `-Xss` å‚æ•°æ¥å†³å®šã€‚

- å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œå°†æŠ›å‡º `StackOverflowError` å¼‚å¸¸ã€‚
- å¦‚æœè™šæ‹Ÿæœºåœ¨æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚

ä»å®æˆ˜æ¥è¯´ï¼Œæ ˆæº¢å‡ºçš„å¸¸è§åŸå› ï¼š

- é€’å½’å‡½æ•°è°ƒç”¨å±‚æ•°å¤ªæ·±
- å¤§é‡å¾ªç¯æˆ–æ­»å¾ªç¯
- æ•°ç»„ã€Listã€Map æ•°æ®è¿‡å¤§

ç¤ºä¾‹ï¼šé€’å½’å‡½æ•°è°ƒç”¨å±‚æ•°å¤ªæ·±å¯¼è‡´ `StackOverflowError`

```java
public class StackOverflowDemo {

    private int stackLength = 1;

    public void recursion() {
        stackLength++;
        recursion();
    }

    public static void main(String[] args) {
        StackOverflowDemo obj = new StackOverflowDemo();
        try {
            obj.recursion();
        } catch (Throwable e) {
            System.out.println("æ ˆæ·±åº¦ï¼š" + obj.stackLength);
            e.printStackTrace();
        }
    }

}
```

ç¤ºä¾‹ï¼šç±»æˆå‘˜å¾ªç¯ä¾èµ–ï¼Œå¯¼è‡´ `StackOverflowError`

```java
public class StackOverflowDemo2 {

	public static void main(String[] args) {
		A obj = new A();
		System.out.println(obj.toString());
	}

	static class A {

		private int value;

		private B instance;

		public A() {
			value = 0;
			instance = new B();
		}

		@Override
		public String toString() {
			return "<" + value + ", " + instance + ">";
		}

	}

	static class B {

		private int value;

		private A instance;

		public B() {
			value = 10;
			instance = new A();
		}

		@Override
		public String toString() {
			return "<" + value + ", " + instance + ">";
		}

	}

}
```

### æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º

æ–¹æ³•åŒºç”¨äºå­˜æ”¾ Class çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚ç±»åã€è®¿é—®ä¿®é¥°ç¬¦ã€å¸¸é‡æ± ã€å­—æ®µæè¿°ã€æ–¹æ³•æè¿°ç­‰ã€‚

ä¸€ä¸ªç±»è¦è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ï¼Œåˆ¤å®šæ¡ä»¶æ˜¯æ¯”è¾ƒè‹›åˆ»çš„ã€‚åœ¨ç»å¸¸åŠ¨æ€ç”Ÿæˆå¤§é‡ Class çš„åº”ç”¨ä¸­ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç±»çš„å›æ”¶çŠ¶å†µã€‚è¿™ç±»å¸¸è§é™¤äº† CGLib å­—èŠ‚ç å¢å¼ºå’ŒåŠ¨æ€è¯­éŸ³æ„å¤–ï¼Œå¸¸è§çš„è¿˜æœ‰ï¼šå¤§é‡ JSP æˆ–åŠ¨æ€äº§ç”Ÿ JSP æ–‡ä»¶çš„åº”ç”¨ï¼ˆJSP ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶éœ€è¦ç¼–è¯‘ä¸º Java ç±»ï¼‰ã€åŸºäº OSGi çš„åº”ç”¨ï¼ˆå³ä½¿æ˜¯åŒä¸€ä¸ªç±»æ–‡ä»¶ï¼Œè¢«ä¸åŒçš„åŠ è½½å™¨åŠ è½½ä¹Ÿä¼šè§†ä¸ºä¸åŒçš„ç±»ï¼‰ç­‰ã€‚

> åœ¨ JDK6 åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥é€šè¿‡ `-XX:PermSize` å’Œ `-XX:MaxPermSize` è®¾ç½®æ°¸ä¹…ä»£ç©ºé—´å¤§å°ï¼Œä»è€Œé™åˆ¶æ–¹æ³•åŒºå¤§å°ï¼Œå¹¶é—´æ¥é™åˆ¶å…¶ä¸­å¸¸é‡æ± çš„å®¹é‡ã€‚

ç¤ºä¾‹ï¼šæ–¹æ³•åŒºå‡ºç° `OutOfMemoryError`

```java
public class MethodAreaOutOfMemoryDemo {

    public static void main(String[] args) {
        while (true) {
            Enhancer enhancer = new Enhancer();
            enhancer.setSuperclass(Bean.class);
            enhancer.setUseCache(false);
            enhancer.setCallback(new MethodInterceptor() {
                @Override
                public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
                    return proxy.invokeSuper(obj, args);
                }
            });
            enhancer.create();
        }
    }

    static class Bean {}

}
```

å¯åŠ¨æ—¶æŒ‡å®šå¦‚ä¸‹ VM å‚æ•°ï¼š

- (JDK8 ä»¥å‰) - `-XX:PermSize=10m -XX:MaxPermSize=10m`
- (JDK8 åŠä»¥å) - `-XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m`

### ç›´æ¥å†…å­˜æº¢å‡º

ç”±ç›´æ¥å†…å­˜å¯¼è‡´çš„å†…å­˜æº¢å‡ºï¼Œä¸€ä¸ªæ˜æ˜¾çš„ç‰¹å¾æ˜¯åœ¨ Head Dump æ–‡ä»¶ä¸­ä¸ä¼šçœ‹è§æ˜æ˜¾çš„å¼‚å¸¸ï¼Œå¦‚æœå‘ç° OOM ä¹‹å Dump æ–‡ä»¶å¾ˆå°ï¼Œè€Œç¨‹åºä¸­åˆç›´æ¥æˆ–é—´æ¥ä½¿ç”¨äº† NIOï¼Œå°±å¯ä»¥è€ƒè™‘æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯è¿™æ–¹é¢çš„åŸå› ã€‚

ç¤ºä¾‹ï¼šç›´æ¥å†…å­˜ `OutOfMemoryError`

```java
public class DirectOutOfMemoryDemo {

    private static final int _1MB = 1024 * 1024;

    public static void main(String[] args) throws IllegalAccessException {
        Field unsafeField = Unsafe.class.getDeclaredFields()[0];
        unsafeField.setAccessible(true);
        Unsafe unsafe = (Unsafe) unsafeField.get(null);
        while (true) {
            unsafe.allocateMemory(_1MB);
        }
    }

}
```

å¯åŠ¨æ—¶ï¼ŒæŒ‡å®š VM å‚æ•° `-Xmx20M -XX:MaxDirectMemorySize=10M`

## å‚è€ƒèµ„æ–™

- [ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹](https://item.jd.com/11252778.html)
- [ä»è¡¨åˆ°é‡Œå­¦ä¹  JVM å®ç°](https://www.douban.com/doulist/2545443/)
