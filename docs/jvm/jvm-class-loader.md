# JVM ç±»åŠ è½½

> **ğŸ“¦ æœ¬æ–‡ä»¥åŠç¤ºä¾‹æºç å·²å½’æ¡£åœ¨ [javacore](https://github.com/dunwu/javacore/)**

![img](http://dunwu.test.upcdn.net/snap/20200617145849.png)

<!-- TOC depthFrom:2 depthTo:3 -->

- [ä¸€ã€ç±»åŠ è½½æœºåˆ¶](#ä¸€ç±»åŠ è½½æœºåˆ¶)
  - [ä»€ä¹ˆæ˜¯ç±»åŠ è½½](#ä»€ä¹ˆæ˜¯ç±»åŠ è½½)
- [äºŒã€ç±»çš„ç”Ÿå‘½å‘¨æœŸ](#äºŒç±»çš„ç”Ÿå‘½å‘¨æœŸ)
  - [ï¼ˆä¸€ï¼‰åŠ è½½](#ä¸€åŠ è½½)
  - [ï¼ˆäºŒï¼‰éªŒè¯](#äºŒéªŒè¯)
  - [ï¼ˆä¸‰ï¼‰å‡†å¤‡](#ä¸‰å‡†å¤‡)
  - [ï¼ˆå››ï¼‰è§£æ](#å››è§£æ)
  - [ï¼ˆäº”ï¼‰åˆå§‹åŒ–](#äº”åˆå§‹åŒ–)
- [ä¸‰ã€ClassLoader](#ä¸‰classloader)
  - [ç±»ä¸ç±»åŠ è½½å™¨](#ç±»ä¸ç±»åŠ è½½å™¨)
  - [ç±»åŠ è½½å™¨åˆ†ç±»](#ç±»åŠ è½½å™¨åˆ†ç±»)
  - [åŒäº²å§”æ´¾](#åŒäº²å§”æ´¾)
  - [ClassLoader å‚æ•°](#classloader-å‚æ•°)
- [å››ã€ç±»çš„åŠ è½½](#å››ç±»çš„åŠ è½½)
  - [ç±»åŠ è½½æ–¹å¼](#ç±»åŠ è½½æ–¹å¼)
  - [åŠ è½½ç±»é”™è¯¯](#åŠ è½½ç±»é”™è¯¯)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

<!-- /TOC -->

## ä¸€ã€ç±»åŠ è½½æœºåˆ¶

> ç±»æ˜¯åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€åŠ è½½çš„ã€‚

### ä»€ä¹ˆæ˜¯ç±»åŠ è½½

ç±»çš„åŠ è½½æŒ‡çš„æ˜¯å°†ç±»çš„.class æ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­ï¼Œå°†å…¶æ”¾åœ¨è¿è¡Œæ—¶æ•°æ®åŒºçš„æ–¹æ³•åŒºå†…ï¼Œç„¶ååœ¨å †åŒºåˆ›å»ºä¸€ä¸ª`java.lang.Class`å¯¹è±¡ï¼Œç”¨æ¥å°è£…ç±»åœ¨æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„ã€‚ç±»çš„åŠ è½½çš„æœ€ç»ˆäº§å“æ˜¯ä½äºå †åŒºä¸­çš„`Class`å¯¹è±¡ï¼Œ`Class`å¯¹è±¡å°è£…äº†ç±»åœ¨æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”å‘ Java ç¨‹åºå‘˜æä¾›äº†è®¿é—®æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„çš„æ¥å£ã€‚

ç±»åŠ è½½å™¨å¹¶ä¸éœ€è¦ç­‰åˆ°æŸä¸ªç±»è¢«â€œé¦–æ¬¡ä¸»åŠ¨ä½¿ç”¨â€æ—¶å†åŠ è½½å®ƒï¼ŒJVM è§„èŒƒå…è®¸ç±»åŠ è½½å™¨åœ¨é¢„æ–™æŸä¸ªç±»å°†è¦è¢«ä½¿ç”¨æ—¶å°±é¢„å…ˆåŠ è½½å®ƒï¼Œå¦‚æœåœ¨é¢„å…ˆåŠ è½½çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†.class æ–‡ä»¶ç¼ºå¤±æˆ–å­˜åœ¨é”™è¯¯ï¼Œç±»åŠ è½½å™¨å¿…é¡»åœ¨ç¨‹åºé¦–æ¬¡ä¸»åŠ¨ä½¿ç”¨è¯¥ç±»æ—¶æ‰æŠ¥å‘Šé”™è¯¯ï¼ˆLinkageError é”™è¯¯ï¼‰å¦‚æœè¿™ä¸ªç±»ä¸€ç›´æ²¡æœ‰è¢«ç¨‹åºä¸»åŠ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆç±»åŠ è½½å™¨å°±ä¸ä¼šæŠ¥å‘Šé”™è¯¯

## äºŒã€ç±»çš„ç”Ÿå‘½å‘¨æœŸ

![img](http://dunwu.test.upcdn.net/snap/20200617115110.png)

Java ç±»çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

- **åŠ è½½ï¼ˆLoadingï¼‰**
- **é“¾æ¥ï¼ˆLinkingï¼‰**
  - **éªŒè¯ï¼ˆVerificationï¼‰**
  - **å‡†å¤‡ï¼ˆPreparationï¼‰**
  - **è§£æï¼ˆResolutionï¼‰**
- **åˆå§‹åŒ–ï¼ˆInitializationï¼‰**
- **ä½¿ç”¨ï¼ˆUsingï¼‰**
- **å¸è½½ï¼ˆUnloadingï¼‰**

åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€åˆå§‹åŒ–å’Œå¸è½½è¿™ 5 ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹å¿…é¡»æŒ‰ç…§è¿™ç§é¡ºåºæŒ‰éƒ¨å°±ç­åœ°å¼€å§‹ã€‚è€Œ**è§£æè¿‡ç¨‹åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒ Java çš„åŠ¨æ€ç»‘å®š**ã€‚

ç±»åŠ è½½è¿‡ç¨‹æ˜¯æŒ‡åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–è¿™ 5 ä¸ªé˜¶æ®µã€‚

### ï¼ˆä¸€ï¼‰åŠ è½½

åŠ è½½æ˜¯ç±»åŠ è½½çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ³¨æ„ä¸è¦æ··æ·†ã€‚

åŠ è½½è¿‡ç¨‹å®Œæˆä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š

- é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚
- å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å­˜å‚¨ç»“æ„ã€‚
- åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„ `Class` å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚

å…¶ä¸­äºŒè¿›åˆ¶å­—èŠ‚æµå¯ä»¥ä»ä»¥ä¸‹æ–¹å¼ä¸­è·å–ï¼š

- ä» ZIP åŒ…è¯»å–ï¼Œè¿™å¾ˆå¸¸è§ï¼Œæœ€ç»ˆæˆä¸ºæ—¥å JARã€EARã€WAR æ ¼å¼çš„åŸºç¡€ã€‚
- ä»ç½‘ç»œä¸­è·å–ï¼Œè¿™ç§åœºæ™¯æœ€å…¸å‹çš„åº”ç”¨æ˜¯ Appletã€‚
- è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œè¿™ç§åœºæ™¯ä½¿ç”¨å¾—æœ€å¤šå¾—å°±æ˜¯åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œåœ¨ `java.lang.reflect.Proxy` ä¸­ï¼Œå°±æ˜¯ç”¨äº† `ProxyGenerator.generateProxyClass` çš„ä»£ç†ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚
- ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œå…¸å‹åœºæ™¯æ˜¯ JSP åº”ç”¨ï¼Œå³ç”± JSP æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ Class ç±»ã€‚
- ä»æ•°æ®åº“è¯»å–ï¼Œè¿™ç§åœºæ™¯ç›¸å¯¹å°‘è§ï¼Œä¾‹å¦‚æœ‰äº›ä¸­é—´ä»¶æœåŠ¡å™¨ï¼ˆå¦‚ SAP Netweaverï¼‰å¯ä»¥é€‰æ‹©æŠŠç¨‹åºå®‰è£…åˆ°æ•°æ®åº“ä¸­æ¥å®Œæˆç¨‹åºä»£ç åœ¨é›†ç¾¤é—´çš„åˆ†å‘ã€‚
  ...

### ï¼ˆäºŒï¼‰éªŒè¯

éªŒè¯æ˜¯é“¾æ¥é˜¶æ®µçš„ç¬¬ä¸€æ­¥ã€‚**éªŒè¯**çš„ç›®æ ‡æ˜¯**ç¡®ä¿ Class æ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚**ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚

éªŒè¯é˜¶æ®µå¤§è‡´ä¼šå®Œæˆ 4 ä¸ªé˜¶æ®µçš„æ£€éªŒåŠ¨ä½œï¼š

- **æ–‡ä»¶æ ¼å¼éªŒè¯** - éªŒè¯å­—èŠ‚æµæ˜¯å¦ç¬¦åˆ Class æ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œå¹¶ä¸”èƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ã€‚
- **å…ƒæ•°æ®éªŒè¯** - å¯¹å­—èŠ‚ç æè¿°çš„ä¿¡æ¯è¿›è¡Œè¯­ä¹‰åˆ†æï¼Œä»¥ä¿è¯å…¶æè¿°çš„ä¿¡æ¯ç¬¦åˆ Java è¯­è¨€è§„èŒƒçš„è¦æ±‚ã€‚
- **å­—èŠ‚ç éªŒè¯** - é€šè¿‡æ•°æ®æµå’Œæ§åˆ¶æµåˆ†æï¼Œç¡®ä¿ç¨‹åºè¯­ä¹‰æ˜¯åˆæ³•ã€ç¬¦åˆé€»è¾‘çš„ã€‚
- **ç¬¦å·å¼•ç”¨éªŒè¯** - å‘ç”Ÿåœ¨è™šæ‹Ÿæœºå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„æ—¶å€™ï¼Œå¯¹ç±»è‡ªèº«ä»¥å¤–ï¼ˆå¸¸é‡æ± ä¸­çš„å„ç§ç¬¦å·å¼•ç”¨ï¼‰çš„ä¿¡æ¯è¿›è¡ŒåŒ¹é…æ€§æ ¡éªŒã€‚

éªŒè¯é˜¶æ®µæ˜¯éå¸¸é‡è¦çš„ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ï¼Œå®ƒå¯¹ç¨‹åºè¿è¡ŒæœŸæ²¡æœ‰å½±å“ï¼Œå¦‚æœæ‰€å¼•ç”¨çš„ç±»ç»è¿‡åå¤éªŒè¯ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘é‡‡ç”¨ `-Xverifynone` å‚æ•°æ¥å…³é—­å¤§éƒ¨åˆ†çš„ç±»éªŒè¯æªæ–½ï¼Œä»¥ç¼©çŸ­è™šæ‹Ÿæœºç±»åŠ è½½çš„æ—¶é—´ã€‚

### ï¼ˆä¸‰ï¼‰å‡†å¤‡

**ç±»å˜é‡æ˜¯è¢« static ä¿®é¥°çš„å˜é‡ï¼Œå‡†å¤‡é˜¶æ®µä¸º static å˜é‡åœ¨æ–¹æ³•åŒºåˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ï¼Œä½¿ç”¨çš„æ˜¯æ–¹æ³•åŒºçš„å†…å­˜ã€‚**

å®ä¾‹å˜é‡ä¸ä¼šåœ¨è¿™é˜¶æ®µåˆ†é…å†…å­˜ï¼Œå®ƒå°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨ Java å †ä¸­ã€‚ï¼ˆå®ä¾‹åŒ–ä¸æ˜¯ç±»åŠ è½½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œç±»åŠ è½½å‘ç”Ÿåœ¨æ‰€æœ‰å®ä¾‹åŒ–æ“ä½œä¹‹å‰ï¼Œå¹¶ä¸”ç±»åŠ è½½åªè¿›è¡Œä¸€æ¬¡ï¼Œå®ä¾‹åŒ–å¯ä»¥è¿›è¡Œå¤šæ¬¡ï¼‰

åˆå§‹å€¼ä¸€èˆ¬ä¸º 0 å€¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç±»å˜é‡ value è¢«åˆå§‹åŒ–ä¸º 0 è€Œä¸æ˜¯ 123ã€‚

```java
public static int value = 123;
```

å¦‚æœç±»å˜é‡æ˜¯å¸¸é‡ï¼Œé‚£ä¹ˆä¼šæŒ‰ç…§è¡¨è¾¾å¼æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯èµ‹å€¼ä¸º 0ã€‚

```java
public static final int value = 123;
```

å‡†å¤‡é˜¶æ®µæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

- è¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆstaticï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€å—åˆ†é…åœ¨ Java å †ä¸­ã€‚
- è¿™é‡Œæ‰€è®¾ç½®çš„åˆå§‹å€¼é€šå¸¸æƒ…å†µä¸‹æ˜¯æ•°æ®ç±»å‹é»˜è®¤çš„é›¶å€¼ï¼ˆå¦‚ 0ã€0Lã€nullã€false ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯è¢«åœ¨ Java ä»£ç ä¸­è¢«æ˜¾å¼åœ°èµ‹äºˆçš„å€¼ã€‚

å‡è®¾ä¸€ä¸ªç±»å˜é‡çš„å®šä¹‰ä¸ºï¼š`public static int value = 3`ï¼›

é‚£ä¹ˆå˜é‡ value åœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼ä¸º 0ï¼Œè€Œä¸æ˜¯ 3ï¼Œå› ä¸ºè¿™æ—¶å€™å°šæœªå¼€å§‹æ‰§è¡Œä»»ä½• Java æ–¹æ³•ï¼Œè€ŒæŠŠ value èµ‹å€¼ä¸º 3 çš„`public static`æŒ‡ä»¤æ˜¯åœ¨ç¨‹åºç¼–è¯‘åï¼Œå­˜æ”¾äºç±»æ„é€ å™¨`ï¼ˆï¼‰`æ–¹æ³•ä¹‹ä¸­çš„ï¼Œæ‰€ä»¥æŠŠ value èµ‹å€¼ä¸º 3 çš„åŠ¨ä½œå°†åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šæ‰§è¡Œã€‚

> è¿™é‡Œè¿˜éœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š
>
> - å¯¹åŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ï¼Œå¯¹äºç±»å˜é‡ï¼ˆstaticï¼‰å’Œå…¨å±€å˜é‡ï¼Œå¦‚æœä¸æ˜¾å¼åœ°å¯¹å…¶èµ‹å€¼è€Œç›´æ¥ä½¿ç”¨ï¼Œåˆ™ç³»ç»Ÿä¼šä¸ºå…¶èµ‹äºˆé»˜è®¤çš„é›¶å€¼ï¼Œè€Œå¯¹äºå±€éƒ¨å˜é‡æ¥è¯´ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»æ˜¾å¼åœ°ä¸ºå…¶èµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¸é€šè¿‡ã€‚
> - å¯¹äºåŒæ—¶è¢« static å’Œ final ä¿®é¥°çš„å¸¸é‡ï¼Œå¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™å°±ä¸ºå…¶æ˜¾å¼åœ°èµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¸é€šè¿‡ï¼›è€Œåªè¢« final ä¿®é¥°çš„å¸¸é‡åˆ™æ—¢å¯ä»¥åœ¨å£°æ˜æ—¶æ˜¾å¼åœ°ä¸ºå…¶èµ‹å€¼ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»åˆå§‹åŒ–æ—¶æ˜¾å¼åœ°ä¸ºå…¶èµ‹å€¼ï¼Œæ€»ä¹‹ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»ä¸ºå…¶æ˜¾å¼åœ°èµ‹å€¼ï¼Œç³»ç»Ÿä¸ä¼šä¸ºå…¶èµ‹äºˆé»˜è®¤é›¶å€¼ã€‚
> - å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹ reference æ¥è¯´ï¼Œå¦‚æ•°ç»„å¼•ç”¨ã€å¯¹è±¡å¼•ç”¨ç­‰ï¼Œå¦‚æœæ²¡æœ‰å¯¹å…¶è¿›è¡Œæ˜¾å¼åœ°èµ‹å€¼è€Œç›´æ¥ä½¿ç”¨ï¼Œç³»ç»Ÿéƒ½ä¼šä¸ºå…¶èµ‹äºˆé»˜è®¤çš„é›¶å€¼ï¼Œå³ nullã€‚
> - å¦‚æœåœ¨æ•°ç»„åˆå§‹åŒ–æ—¶æ²¡æœ‰å¯¹æ•°ç»„ä¸­çš„å„å…ƒç´ èµ‹å€¼ï¼Œé‚£ä¹ˆå…¶ä¸­çš„å…ƒç´ å°†æ ¹æ®å¯¹åº”çš„æ•°æ®ç±»å‹è€Œè¢«èµ‹äºˆé»˜è®¤çš„é›¶å€¼ã€‚

- å¦‚æœç±»å­—æ®µçš„å­—æ®µå±æ€§è¡¨ä¸­å­˜åœ¨`ConstantValue`å±æ€§ï¼Œå³åŒæ—¶è¢« final å’Œ static ä¿®é¥°ï¼Œé‚£ä¹ˆåœ¨å‡†å¤‡é˜¶æ®µå˜é‡ value å°±ä¼šè¢«åˆå§‹åŒ–ä¸º ConstValue å±æ€§æ‰€æŒ‡å®šçš„å€¼ã€‚

å‡è®¾ä¸Šé¢çš„ç±»å˜é‡ value è¢«å®šä¹‰ä¸ºï¼š `public static final int value = 3`ï¼›

ç¼–è¯‘æ—¶ Javac å°†ä¼šä¸º value ç”Ÿæˆ ConstantValue å±æ€§ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šæ ¹æ®`ConstantValue`çš„è®¾ç½®å°† value èµ‹å€¼ä¸º 3ã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º static final å¸¸é‡åœ¨ç¼–è¯‘æœŸå°±å°†å…¶ç»“æœæ”¾å…¥äº†è°ƒç”¨å®ƒçš„ç±»çš„å¸¸é‡æ± ä¸­

### ï¼ˆå››ï¼‰è§£æ

è§£æé˜¶æ®µç›®æ ‡æ˜¯**å°†å¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹**ã€‚è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ã€æ–¹æ³•å¥æŸ„å’Œè°ƒç”¨ç‚¹é™å®šç¬¦ 7 ç±»ç¬¦å·å¼•ç”¨è¿›è¡Œã€‚

- **ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referencesï¼‰** - ç¬¦å·å¼•ç”¨ä»¥ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œåªè¦ä½¿ç”¨æ—¶èƒ½æ— æ­§ä¹‰åœ°å®šä½åˆ°ç›®æ ‡å³å¯ã€‚
- **ç›´æ¥å¼•ç”¨ï¼ˆDirect Referenceï¼‰** - ç›´æ¥å¼•ç”¨å¯ä»¥æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–æ˜¯ä¸€ä¸ªèƒ½é—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚

### ï¼ˆäº”ï¼‰åˆå§‹åŒ–

åˆå§‹åŒ–é˜¶æ®µæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­çš„å®šä¹‰çš„ Java ç¨‹åºä»£ç ã€‚åˆå§‹åŒ–ï¼Œ**ä¸ºç±»çš„é™æ€å˜é‡èµ‹äºˆæ­£ç¡®çš„åˆå§‹å€¼ï¼ŒJVM è´Ÿè´£å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹åŒ–**ã€‚

#### ç±»åˆå§‹åŒ–æ–¹å¼

- å£°æ˜ç±»å˜é‡æ—¶æŒ‡å®šåˆå§‹å€¼
- ä½¿ç”¨é™æ€ä»£ç å—ä¸ºç±»å˜é‡æŒ‡å®šåˆå§‹å€¼

> åœ¨å‡†å¤‡é˜¶æ®µï¼Œç±»å˜é‡å·²ç»èµ‹è¿‡ä¸€æ¬¡ç³»ç»Ÿè¦æ±‚çš„åˆå§‹å€¼ï¼Œè€Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæ ¹æ®ç¨‹åºå‘˜é€šè¿‡ç¨‹åºåˆ¶å®šçš„ä¸»è§‚è®¡åˆ’å»åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶å®ƒèµ„æºã€‚

#### ç±»åˆå§‹åŒ–æ­¥éª¤

1. å¦‚æœç±»è¿˜æ²¡æœ‰è¢«åŠ è½½å’Œé“¾æ¥ï¼Œå¼€å§‹åŠ è½½è¯¥ç±»
2. å¦‚æœè¯¥ç±»çš„ç›´æ¥çˆ¶ç±»è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–å…¶çˆ¶ç±»
3. å¦‚æœè¯¥ç±»æœ‰åˆå§‹åŒ–è¯­å¥ï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œè¿™äº›åˆå§‹åŒ–è¯­å¥

#### ç±»åˆå§‹åŒ–æ—¶æœº

åªæœ‰ä¸»åŠ¨å¼•ç”¨ç±»çš„æ—¶å€™æ‰ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ã€‚

**ï¼ˆ1ï¼‰ä¸»åŠ¨å¼•ç”¨**

ç±»çš„ä¸»åŠ¨å¼•ç”¨åŒ…æ‹¬ä»¥ä¸‹å…­ç§ï¼š

- **åˆ›å»ºç±»çš„å®ä¾‹** - ä¹Ÿå°±æ˜¯ `new` å¯¹è±¡
- **è®¿é—®é™æ€å˜é‡** - è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼
- **è®¿é—®é™æ€æ–¹æ³•**
- **åå°„** - å¦‚`Class.forName(â€œcom.shengsiyuan.Testâ€)`
- **åˆå§‹åŒ–å­ç±»** - åˆå§‹åŒ–æŸä¸ªç±»çš„å­ç±»ï¼Œåˆ™å…¶çˆ¶ç±»ä¹Ÿä¼šè¢«åˆå§‹åŒ–
- **å¯åŠ¨ç±»** - Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»ï¼ˆ`Java Test`ï¼‰ï¼Œç›´æ¥ä½¿ç”¨`java.exe`å‘½ä»¤æ¥è¿è¡ŒæŸä¸ªä¸»ç±»

**ï¼ˆ2ï¼‰è¢«åŠ¨å¼•ç”¨**

ä»¥ä¸Š 5 ç§åœºæ™¯ä¸­çš„è¡Œä¸ºç§°ä¸ºå¯¹ä¸€ä¸ªç±»è¿›è¡Œä¸»åŠ¨å¼•ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ‰€æœ‰å¼•ç”¨ç±»çš„æ–¹å¼éƒ½ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œç§°ä¸ºè¢«åŠ¨å¼•ç”¨ã€‚è¢«åŠ¨å¼•ç”¨çš„å¸¸è§ä¾‹å­åŒ…æ‹¬ï¼š

- **é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»åˆå§‹åŒ–**ã€‚

```java
System.out.println(SubClass.value); // value å­—æ®µåœ¨ SuperClass ä¸­å®šä¹‰
```

- **é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–**ã€‚è¯¥è¿‡ç¨‹ä¼šå¯¹æ•°ç»„ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œæ•°ç»„ç±»æ˜¯ä¸€ä¸ªç”±è™šæ‹Ÿæœºè‡ªåŠ¨ç”Ÿæˆçš„ã€ç›´æ¥ç»§æ‰¿è‡ª `Object` çš„å­ç±»ï¼Œå…¶ä¸­åŒ…å«äº†æ•°ç»„çš„å±æ€§å’Œæ–¹æ³•ã€‚

```java
SuperClass[] sca = new SuperClass[10];
```

- å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘**å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–**ã€‚

```java
System.out.println(ConstClass.HELLOWORLD);
```

#### ç±»åˆå§‹åŒ–ç»†èŠ‚

ç±»åˆå§‹åŒ– `<clinit>()` æ–¹æ³•çš„ç»†èŠ‚ï¼š

- æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—ï¼ˆstatic{} å—ï¼‰ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„ï¼Œç¼–è¯‘å™¨æ”¶é›†çš„é¡ºåºç”±è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºå†³å®šã€‚ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œé™æ€è¯­å¥å—åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨å®ƒä¹‹å‰çš„ç±»å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒä¹‹åçš„ç±»å˜é‡åªèƒ½èµ‹å€¼ï¼Œä¸èƒ½è®¿é—®ã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š

```java
public class Test {
    static {
        i = 0;                // ç»™å˜é‡èµ‹å€¼å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡
        System.out.print(i);  // è¿™å¥ç¼–è¯‘å™¨ä¼šæç¤ºâ€œéæ³•å‘å‰å¼•ç”¨â€
    }
    static int i = 1;
}
```

- ä¸ç±»çš„æ„é€ å‡½æ•°ï¼ˆæˆ–è€…è¯´å®ä¾‹æ„é€ å™¨ `<init>()`ï¼‰ä¸åŒï¼Œä¸éœ€è¦æ˜¾å¼çš„è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ã€‚è™šæ‹Ÿæœºä¼šè‡ªåŠ¨ä¿è¯åœ¨å­ç±»çš„ `<clinit>()` æ–¹æ³•è¿è¡Œä¹‹å‰ï¼Œçˆ¶ç±»çš„ `<clinit>()` æ–¹æ³•å·²ç»æ‰§è¡Œç»“æŸã€‚å› æ­¤è™šæ‹Ÿæœºä¸­ç¬¬ä¸€ä¸ªæ‰§è¡Œ `<clinit>()` æ–¹æ³•çš„ç±»è‚¯å®šä¸º `java.lang.Object`ã€‚
- ç”±äºçˆ¶ç±»çš„ `<clinit>()` æ–¹æ³•å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æ„å‘³ç€çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€è¯­å¥å—è¦ä¼˜äºå­ç±»çš„å˜é‡èµ‹å€¼æ“ä½œã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š

```java
static class Parent {
    public static int A = 1;
    static {
        A = 2;
    }
}

static class Sub extends Parent {
    public static int B = A;
}

public static void main(String[] args) {
     System.out.println(Sub.B);  // è¾“å‡ºç»“æœæ˜¯çˆ¶ç±»ä¸­çš„é™æ€å˜é‡ A çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 2ã€‚
}
```

- `<clinit>()` æ–¹æ³•å¯¹äºç±»æˆ–æ¥å£ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä¸€ä¸ªç±»ä¸­ä¸åŒ…å«é™æ€è¯­å¥å—ï¼Œä¹Ÿæ²¡æœ‰å¯¹ç±»å˜é‡çš„èµ‹å€¼æ“ä½œï¼Œç¼–è¯‘å™¨å¯ä»¥ä¸ä¸ºè¯¥ç±»ç”Ÿæˆ `<clinit>()` æ–¹æ³•ã€‚
- æ¥å£ä¸­ä¸å¯ä»¥ä½¿ç”¨é™æ€è¯­å¥å—ï¼Œä½†ä»ç„¶æœ‰ç±»å˜é‡åˆå§‹åŒ–çš„èµ‹å€¼æ“ä½œï¼Œå› æ­¤æ¥å£ä¸ç±»ä¸€æ ·éƒ½ä¼šç”Ÿæˆ `<clinit>()` æ–¹æ³•ã€‚ä½†æ¥å£ä¸ç±»ä¸åŒçš„æ˜¯ï¼Œæ‰§è¡Œæ¥å£çš„ `<clinit>()` æ–¹æ³•ä¸éœ€è¦å…ˆæ‰§è¡Œçˆ¶æ¥å£çš„ `<clinit>()` æ–¹æ³•ã€‚åªæœ‰å½“çˆ¶æ¥å£ä¸­å®šä¹‰çš„å˜é‡ä½¿ç”¨æ—¶ï¼Œçˆ¶æ¥å£æ‰ä¼šåˆå§‹åŒ–ã€‚å¦å¤–ï¼Œæ¥å£çš„å®ç°ç±»åœ¨åˆå§‹åŒ–æ—¶ä¹Ÿä¸€æ ·ä¸ä¼šæ‰§è¡Œæ¥å£çš„ `<clinit>()` æ–¹æ³•ã€‚
- è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„ `<clinit>()` æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¢«æ­£ç¡®çš„åŠ é”å’ŒåŒæ­¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸ªç±»çš„ `<clinit>()` æ–¹æ³•ï¼Œå…¶å®ƒçº¿ç¨‹éƒ½ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ´»åŠ¨çº¿ç¨‹æ‰§è¡Œ `<clinit>()` æ–¹æ³•å®Œæ¯•ã€‚å¦‚æœåœ¨ä¸€ä¸ªç±»çš„ `<clinit>()` æ–¹æ³•ä¸­æœ‰è€—æ—¶çš„æ“ä½œï¼Œå°±å¯èƒ½é€ æˆå¤šä¸ªçº¿ç¨‹é˜»å¡ï¼Œåœ¨å®é™…è¿‡ç¨‹ä¸­æ­¤ç§é˜»å¡å¾ˆéšè”½ã€‚

## ä¸‰ã€ClassLoader

`ClassLoader` å³ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£å°†ç±»åŠ è½½åˆ° JVMã€‚åœ¨ Java è™šæ‹Ÿæœºå¤–éƒ¨å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€è¦çš„ç±»ã€‚

JVM åŠ è½½ `class` æ–‡ä»¶åˆ°å†…å­˜æœ‰ä¸¤ç§æ–¹å¼ï¼š

- éšå¼åŠ è½½ - JVM è‡ªåŠ¨åŠ è½½éœ€è¦çš„ç±»åˆ°å†…å­˜ä¸­ã€‚
- æ˜¾ç¤ºåŠ è½½ - é€šè¿‡ä½¿ç”¨ `ClassLoader` æ¥åŠ è½½ä¸€ä¸ªç±»åˆ°å†…å­˜ä¸­ã€‚

### ç±»ä¸ç±»åŠ è½½å™¨

å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªç±»æ˜¯å¦ç›¸ç­‰ï¼šç±»æœ¬èº«ç›¸ç­‰ï¼Œå¹¶ä¸”ä½¿ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚è¿™æ˜¯å› ä¸º***æ¯ä¸€ä¸ª `ClassLoader` éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åç§°ç©ºé—´***ã€‚

è¿™é‡Œçš„ç›¸ç­‰ï¼ŒåŒ…æ‹¬ç±»çš„ `Class` å¯¹è±¡çš„ `equals()` æ–¹æ³•ã€`isAssignableFrom()` æ–¹æ³•ã€`isInstance()` æ–¹æ³•çš„è¿”å›ç»“æœä¸º trueï¼Œä¹ŸåŒ…æ‹¬ä½¿ç”¨ `instanceof` å…³é”®å­—åšå¯¹è±¡æ‰€å±å…³ç³»åˆ¤å®šç»“æœä¸º trueã€‚

### ç±»åŠ è½½å™¨åˆ†ç±»

![img](http://dunwu.test.upcdn.net/snap/20200617115936.png)

#### Bootstrap ClassLoader

`Bootstrap ClassLoader` ï¼Œå³å¯åŠ¨ç±»åŠ è½½å™¨ ï¼Œ**è´Ÿè´£åŠ è½½ JVM è‡ªèº«å·¥ä½œæ‰€éœ€è¦çš„ç±»**ã€‚

**`Bootstrap ClassLoader` ä¼šå°†å­˜æ”¾åœ¨ `<JAVA_HOME>\lib` ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢« `-Xbootclasspath` å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ï¼ˆä»…æŒ‰ç…§æ–‡ä»¶åè¯†åˆ«ï¼Œå¦‚ rt.jarï¼Œåå­—ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿æ”¾åœ¨ lib ç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ï¼‰ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­**ã€‚

`Bootstrap ClassLoader` æ˜¯ç”± C++ å®ç°çš„ï¼Œå®ƒå®Œå…¨ç”± JVM è‡ªå·±æ§åˆ¶çš„ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•è¢« Java ç¨‹åºç›´æ¥å¼•ç”¨ï¼Œç”¨æˆ·åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œç›´æ¥ä½¿ç”¨ `null` ä»£æ›¿å³å¯ã€‚

#### ExtClassLoader

`ExtClassLoader`ï¼Œå³æ‰©å±•ç±»åŠ è½½å™¨ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ç”± `ExtClassLoader(sun.misc.Launcher\$ExtClassLoader)`å®ç°çš„ã€‚

**`ExtClassLoader` è´Ÿè´£å°† `<JAVA_HOME>\lib\ext` æˆ–è€…è¢« `java.ext.dir` ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šè·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨**ã€‚

#### AppClassLoader

`AppClassLoader`ï¼Œå³åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ç”± `AppClassLoader(sun.misc.Launcher\$AppClassLoader)` å®ç°çš„ã€‚ç”±äºè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ `ClassLoader` ä¸­çš„ `getSystemClassLoader()` æ–¹æ³•çš„è¿”å›å€¼ï¼Œå› æ­¤ä¸€èˆ¬ç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚

**`AppClassLoader` è´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆå³ `classpath`ï¼‰ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“**ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚

#### è‡ªå®šä¹‰ç±»åŠ è½½å™¨

è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¯ä»¥åšåˆ°å¦‚ä¸‹å‡ ç‚¹ï¼š

- åœ¨æ‰§è¡Œéç½®ä¿¡ä»£ç ä¹‹å‰ï¼Œè‡ªåŠ¨éªŒè¯æ•°å­—ç­¾åã€‚
- åŠ¨æ€åœ°åˆ›å»ºç¬¦åˆç”¨æˆ·ç‰¹å®šéœ€è¦çš„å®šåˆ¶åŒ–æ„å»ºç±»ã€‚
- ä»ç‰¹å®šçš„åœºæ‰€å–å¾— java classï¼Œä¾‹å¦‚æ•°æ®åº“ä¸­å’Œç½‘ç»œä¸­ã€‚

å‡è®¾ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªåä¸º `FileSystemClassLoader` çš„ç±»åŠ è½½å™¨ï¼Œç»§æ‰¿è‡ª `java.lang.ClassLoader`ï¼Œç”¨äºåŠ è½½æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç±»ã€‚å®ƒé¦–å…ˆæ ¹æ®ç±»çš„å…¨ååœ¨æ–‡ä»¶ç³»ç»Ÿä¸ŠæŸ¥æ‰¾ç±»çš„å­—èŠ‚ä»£ç æ–‡ä»¶ï¼ˆ`.class` æ–‡ä»¶ï¼‰ï¼Œç„¶åè¯»å–è¯¥æ–‡ä»¶å†…å®¹ï¼Œæœ€åé€šè¿‡ `defineClass()` æ–¹æ³•æ¥æŠŠè¿™äº›å­—èŠ‚ä»£ç è½¬æ¢æˆ `java.lang.Class` ç±»çš„å®ä¾‹ã€‚

`java.lang.ClassLoader` ç±»çš„æ–¹æ³• `loadClass()` å®ç°äº†åŒäº²å§”æ´¾æ¨¡å‹çš„é€»è¾‘ï¼Œå› æ­¤è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬ä¸å»è¦†å†™å®ƒï¼Œè€Œæ˜¯é€šè¿‡è¦†å†™ `findClass()` æ–¹æ³•ã€‚

`ClassLoader` å¸¸ç”¨çš„åœºæ™¯ï¼š

- å®¹å™¨ - å…¸å‹åº”ç”¨ï¼šServlet å®¹å™¨ï¼ˆå¦‚ï¼šTomcatã€Jettyï¼‰ã€udf ï¼ˆMysqlã€Hiveï¼‰ç­‰ã€‚åŠ è½½è§£å‹ jar åŒ…æˆ– war åŒ…åï¼ŒåŠ è½½å…¶ Class åˆ°æŒ‡å®šçš„ç±»åŠ è½½å™¨ä¸­è¿è¡Œï¼ˆé€šå¸¸éœ€è¦è€ƒè™‘ç©ºé—´éš”ç¦»ï¼‰ã€‚
- çƒ­éƒ¨ç½²ã€çƒ­æ’æ‹” - åº”ç”¨å¯åŠ¨åï¼ŒåŠ¨æ€è·å¾—æŸä¸ªç±»ä¿¡æ¯ï¼Œç„¶ååŠ è½½åˆ° JVM ä¸­å·¥ä½œã€‚å¾ˆå¤šè‘—åçš„å®¹å™¨è½¯ä»¶ã€æ¡†æ¶ï¼ˆå¦‚ï¼šSpring ç­‰ï¼‰ï¼Œéƒ½ä½¿ç”¨ `ClassLoader` æ¥å®ç°è‡ªèº«çš„çƒ­éƒ¨ç½²ã€‚

ã€ç¤ºä¾‹ã€‘è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨

```java
public class FileSystemClassLoader extends ClassLoader {

    private String rootDir;

    public FileSystemClassLoader(String rootDir) {
        this.rootDir = rootDir;
    }

    protected Class<?> findClass(String name) throws ClassNotFoundException {
        byte[] classData = getClassData(name);
        if (classData == null) {
            throw new ClassNotFoundException();
        } else {
            return defineClass(name, classData, 0, classData.length);
        }
    }

    private byte[] getClassData(String className) {
        String path = classNameToPath(className);
        try {
            InputStream ins = new FileInputStream(path);
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            int bufferSize = 4096;
            byte[] buffer = new byte[bufferSize];
            int bytesNumRead;
            while ((bytesNumRead = ins.read(buffer)) != -1) {
                baos.write(buffer, 0, bytesNumRead);
            }
            return baos.toByteArray();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return null;
    }

    private String classNameToPath(String className) {
        return rootDir + File.separatorChar
                + className.replace('.', File.separatorChar) + ".class";
    }
}
```

### åŒäº²å§”æ´¾

ç†è§£åŒäº²å§”æ´¾ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚

ã€ç¤ºä¾‹ã€‘å¯»æ‰¾ç±»åŠ è½½ç¤ºä¾‹

```java
public static void main(String[] args) {
    ClassLoader loader = Thread.currentThread().getContextClassLoader();
    System.out.println(loader);
    System.out.println(loader.getParent());
    System.out.println(loader.getParent().getParent());
}
```

è¾“å‡ºï¼š

```
sun.misc.Launcher$AppClassLoader@18b4aac2
sun.misc.Launcher$ExtClassLoader@19e1023e
null
```

ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå¹¶æ²¡æœ‰è·å–åˆ° `ExtClassLoader` çš„çˆ¶ Loaderï¼ŒåŸå› æ˜¯ `Bootstrap Loader`ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰æ˜¯ç”¨ C è¯­è¨€å®ç°çš„ï¼Œæ‰¾ä¸åˆ°ä¸€ä¸ªç¡®å®šçš„è¿”å›çˆ¶ Loader çš„æ–¹å¼ï¼Œäºæ˜¯å°±è¿”å› nullã€‚

ä¸‹å›¾å±•ç¤ºçš„ç±»åŠ è½½å™¨ä¹‹é—´çš„å±‚æ¬¡å…³ç³»ï¼Œç§°ä¸ºç±»åŠ è½½å™¨çš„**åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParents Delegation Modelï¼‰**ã€‚**è¯¥æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„ Bootstrap ClassLoader å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨**ã€‚**è¿™é‡Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬é€šè¿‡ç»„åˆï¼ˆCompositionï¼‰å…³ç³»æ¥å®ç°ï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿ï¼ˆInheritanceï¼‰çš„å…³ç³»å®ç°**ã€‚

<div align="center">
<img src="http://dunwu.test.upcdn.net/cs/java/javacore/jvm/jmm-ç±»åŠ è½½-åŒäº²å§”æ´¾.png" width="500" />
</div>

**ï¼ˆ1ï¼‰å·¥ä½œè¿‡ç¨‹**

**ä¸€ä¸ªç±»åŠ è½½å™¨é¦–å…ˆå°†ç±»åŠ è½½è¯·æ±‚ä¼ é€åˆ°çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆç±»åŠ è½½è¯·æ±‚æ—¶æ‰å°è¯•åŠ è½½**ã€‚

**ï¼ˆ2ï¼‰å¥½å¤„**

**ä½¿å¾— Java ç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·æœ‰ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»**ï¼Œä»è€Œä½¿å¾—åŸºç¡€ç±»å¾—åˆ°ç»Ÿä¸€ï¼š

- ç³»ç»Ÿç±»é˜²æ­¢å†…å­˜ä¸­å‡ºç°å¤šä»½åŒæ ·çš„å­—èŠ‚ç 
- ä¿è¯ Java ç¨‹åºå®‰å…¨ç¨³å®šè¿è¡Œ

ä¾‹å¦‚ï¼š `java.lang.Object` å­˜æ”¾åœ¨ rt.jar ä¸­ï¼Œå¦‚æœç¼–å†™å¦å¤–ä¸€ä¸ª `java.lang.Object` çš„ç±»å¹¶æ”¾åˆ° `classpath` ä¸­ï¼Œç¨‹åºå¯ä»¥ç¼–è¯‘é€šè¿‡ã€‚å› ä¸ºåŒäº²å§”æ´¾æ¨¡å‹çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨ rt.jar ä¸­çš„ `Object` æ¯”åœ¨ `classpath` ä¸­çš„ `Object` ä¼˜å…ˆçº§æ›´é«˜ï¼Œå› ä¸º rt.jar ä¸­çš„ `Object` ä½¿ç”¨çš„æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè€Œ `classpath` ä¸­çš„ `Object` ä½¿ç”¨çš„æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚æ­£å› ä¸º rt.jar ä¸­çš„ `Object` ä¼˜å…ˆçº§æ›´é«˜ï¼Œå› ä¸ºç¨‹åºä¸­æ‰€æœ‰çš„ `Object` éƒ½æ˜¯è¿™ä¸ª `Object`ã€‚

**ï¼ˆ3ï¼‰å®ç°**

ä»¥ä¸‹æ˜¯æŠ½è±¡ç±» `java.lang.ClassLoader` çš„ä»£ç ç‰‡æ®µï¼Œå…¶ä¸­çš„ `loadClass()` æ–¹æ³•è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

```java
public abstract class ClassLoader {
    // The parent class loader for delegation
    private final ClassLoader parent;

    public Class<?> loadClass(String name) throws ClassNotFoundException {
        return loadClass(name, false);
    }

    protected Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {
        synchronized (getClassLoadingLock(name)) {
            // é¦–å…ˆåˆ¤æ–­è¯¥ç±»å‹æ˜¯å¦å·²ç»è¢«åŠ è½½
            Class<?> c = findLoadedClass(name);
            if (c == null) {
                // å¦‚æœæ²¡æœ‰è¢«åŠ è½½ï¼Œå°±å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½æˆ–è€…å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½
                try {
                    if (parent != null) {
                        // å¦‚æœå­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œå°±å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½
                        c = parent.loadClass(name, false);
                    } else {
                        // å¦‚æœä¸å­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œå°±æ£€æŸ¥æ˜¯å¦æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œé€šè¿‡è°ƒç”¨æœ¬åœ°æ–¹æ³•native Class findBootstrapClass(String name)
                        c = findBootstrapClassOrNull(name);
                    }
                } catch (ClassNotFoundException e) {
                    // å¦‚æœçˆ¶ç±»åŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œä¼šæŠ›å‡º ClassNotFoundException
                }

                if (c == null) {
                    // å¦‚æœçˆ¶ç±»åŠ è½½å™¨å’Œå¯åŠ¨ç±»åŠ è½½å™¨éƒ½ä¸èƒ½å®ŒæˆåŠ è½½ä»»åŠ¡ï¼Œæ‰è°ƒç”¨è‡ªèº«çš„åŠ è½½åŠŸèƒ½
                    c = findClass(name);
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }

    protected Class<?> findClass(String name) throws ClassNotFoundException {
        throw new ClassNotFoundException(name);
    }
}
```

ã€è¯´æ˜ã€‘

- å…ˆæ£€æŸ¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®©çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ã€‚
- å½“çˆ¶ç±»åŠ è½½å™¨åŠ è½½å¤±è´¥æ—¶æŠ›å‡º `ClassNotFoundException`ï¼Œæ­¤æ—¶å°è¯•è‡ªå·±å»åŠ è½½ã€‚

### ClassLoader å‚æ•°

åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šå¯åŠ¨ java åº”ç”¨æ—¶ï¼Œé€šå¸¸ä¼šæŒ‡å®šä¸€äº› `ClassLoader` å‚æ•°ï¼Œä»¥åŠ è½½åº”ç”¨æ‰€éœ€è¦çš„ libï¼š

```shell
java -jar xxx.jar -classpath lib/*
```

`ClassLoader` ç›¸å…³å‚æ•°é€‰é¡¹ï¼š

| å‚æ•°é€‰é¡¹                                     | ClassLoader ç±»å‹        | è¯´æ˜                                                                  |
| -------------------------------------------- | ----------------------- | --------------------------------------------------------------------- |
| `-Xbootclasspath`                            | `Bootstrap ClassLoader` | è®¾ç½® `Bootstrap ClassLoader` æœç´¢è·¯å¾„ã€‚ã€ä¸å¸¸ç”¨ã€‘                     |
| `-Xbootclasspath/a`                          | `Bootstrap ClassLoader` | æŠŠè·¯å¾„æ·»åŠ åˆ°å·²å­˜åœ¨çš„ `Bootstrap ClassLoader` æœç´¢è·¯å¾„åé¢ã€‚ã€å¸¸ç”¨ã€‘   |
| `-Xbootclasspath/p`                          | `Bootstrap ClassLoader` | æŠŠè·¯å¾„æ·»åŠ åˆ°å·²å­˜åœ¨çš„ `Bootstrap ClassLoader` æœç´¢è·¯å¾„å‰é¢ã€‚ã€ä¸å¸¸ç”¨ã€‘ |
| `-Djava.ext.dirs`                            | `ExtClassLoader`        | è®¾ç½® `ExtClassLoader` æœç´¢è·¯å¾„ã€‚                                      |
| `-Djava.class.path` æˆ– `-cp` æˆ– `-classpath` | `AppClassLoader`        | è®¾ç½® `AppClassLoader` æœç´¢è·¯å¾„ã€‚                                      |

## å››ã€ç±»çš„åŠ è½½

### ç±»åŠ è½½æ–¹å¼

ç±»åŠ è½½æœ‰ä¸‰ç§æ–¹å¼ï¼š

- å‘½ä»¤è¡Œå¯åŠ¨åº”ç”¨æ—¶å€™ç”± JVM åˆå§‹åŒ–åŠ è½½
- é€šè¿‡ `Class.forName()` æ–¹æ³•åŠ¨æ€åŠ è½½
- é€šè¿‡ `ClassLoader.loadClass()` æ–¹æ³•åŠ¨æ€åŠ è½½

**`Class.forName()` å’Œ `ClassLoader.loadClass()` åŒºåˆ«**

- `Class.forName()` å°†ç±»çš„ `.class` æ–‡ä»¶åŠ è½½åˆ° jvm ä¸­ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ç±»è¿›è¡Œè§£é‡Šï¼Œæ‰§è¡Œç±»ä¸­çš„ `static` å—ï¼›
- `ClassLoader.loadClass()` åªå¹²ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°† `.class` æ–‡ä»¶åŠ è½½åˆ° jvm ä¸­ï¼Œä¸ä¼šæ‰§è¡Œ `static` ä¸­çš„å†…å®¹ï¼Œåªæœ‰åœ¨ `newInstance` æ‰ä¼šå»æ‰§è¡Œ `static` å—ã€‚
- `Class.forName(name, initialize, loader)` å¸¦å‚å‡½æ•°ä¹Ÿå¯æ§åˆ¶æ˜¯å¦åŠ è½½ `static` å—ã€‚å¹¶ä¸”åªæœ‰è°ƒç”¨äº† `newInstance()` æ–¹æ³•é‡‡ç”¨è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºç±»çš„å¯¹è±¡ ã€‚

### åŠ è½½ç±»é”™è¯¯

#### ClassNotFoundException

`ClassNotFoundException` å¼‚å¸¸å‡ºé•œç‡æé«˜ã€‚**`ClassNotFoundException` è¡¨ç¤ºå½“å‰ `classpath` ä¸‹æ‰¾ä¸åˆ°æŒ‡å®šç±»**ã€‚

å¸¸è§é—®é¢˜åŸå› ï¼š

- è°ƒç”¨ `Class` çš„ `forName()` æ–¹æ³•ï¼Œæœªæ‰¾åˆ°ç±»ã€‚
- è°ƒç”¨ `ClassLoader` ä¸­çš„ `loadClass()` æ–¹æ³•ï¼Œæœªæ‰¾åˆ°ç±»ã€‚
- è°ƒç”¨ `ClassLoader` ä¸­çš„ `findSystemClass()` æ–¹æ³•ï¼Œæœªæ‰¾åˆ°ç±»ã€‚

ã€ç¤ºä¾‹ã€‘æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œä¼šæŠ›å‡º `ClassNotFoundException` å¼‚å¸¸ï¼š

```java
public class ClassNotFoundExceptionDemo {
    public static void main(String[] args) {
        try {
            Class.forName("NotFound");
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```

è§£å†³æ–¹æ³•ï¼šæ£€æŸ¥ `classpath` ä¸‹æœ‰æ²¡æœ‰ç›¸åº”çš„ class æ–‡ä»¶ã€‚

#### NoClassDefFoundError

å¸¸è§é—®é¢˜åŸå› ï¼š

- ç±»ä¾èµ–çš„ Class æˆ–è€… jar ä¸å­˜åœ¨ã€‚
- ç±»æ–‡ä»¶å­˜åœ¨ï¼Œä½†æ˜¯å­˜åœ¨ä¸åŒçš„åŸŸä¸­ã€‚

è§£å†³æ–¹æ³•ï¼šç°ä»£ Java é¡¹ç›®ï¼Œä¸€èˆ¬ä½¿ç”¨ `maven`ã€`gradle` ç­‰æ„å»ºå·¥å…·ç®¡ç†é¡¹ç›®ï¼Œä»”ç»†æ£€æŸ¥æ‰¾ä¸åˆ°çš„ç±»æ‰€åœ¨çš„ jar åŒ…æ˜¯å¦å·²æ·»åŠ ä¸ºä¾èµ–ã€‚

#### UnsatisfiedLinkError

è¿™ä¸ªå¼‚å¸¸å€’ä¸æ˜¯å¾ˆå¸¸è§ï¼Œä½†æ˜¯å‡ºé”™çš„è¯ï¼Œé€šå¸¸æ˜¯åœ¨ JVM å¯åŠ¨çš„æ—¶å€™å¦‚æœä¸€ä¸å°å¿ƒå°†åœ¨ JVM ä¸­çš„æŸä¸ª lib åˆ é™¤äº†ï¼Œå¯èƒ½å°±ä¼šæŠ¥è¿™ä¸ªé”™è¯¯äº†ã€‚

ã€ç¤ºä¾‹ã€‘æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œä¼šæŠ›å‡º `UnsatisfiedLinkError` é”™è¯¯ã€‚

```java
public class UnsatisfiedLinkErrorDemo {

    public native void nativeMethod();

    static {
        System.loadLibrary("NoLib");
    }

    public static void main(String[] args) {
        new UnsatisfiedLinkErrorDemo().nativeMethod();
    }

}
```

ã€è¾“å‡ºã€‘

```java
java.lang.UnsatisfiedLinkError: no NoLib in java.library.path
	at java.lang.ClassLoader.loadLibrary(ClassLoader.java:1867)
	at java.lang.Runtime.loadLibrary0(Runtime.java:870)
	at java.lang.System.loadLibrary(System.java:1122)
	at io.github.dunwu.javacore.jvm.classloader.exception.UnsatisfiedLinkErrorDemo.<clinit>(UnsatisfiedLinkErrorDemo.java:12)
```

#### ClassCastException

`ClassCastException` å¼‚å¸¸é€šå¸¸æ˜¯åœ¨ç¨‹åºä¸­å¼ºåˆ¶ç±»å‹è½¬æ¢å¤±è´¥æ—¶å‡ºç°ã€‚

ã€ç¤ºä¾‹ã€‘æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œä¼šæŠ›å‡º `ClassCastException` å¼‚å¸¸ã€‚

```java
public class ClassCastExceptionDemo {

    public static void main(String[] args) {
        Object obj = new Object();
        EmptyClass newObj = (EmptyClass) obj;
    }

    static class EmptyClass {}

}
```

ã€è¾“å‡ºã€‘

```java
Exception in thread "main" java.lang.ClassCastException: java.lang.Object cannot be cast to io.github.dunwu.javacore.jvm.classloader.exception.ClassCastExceptionDemo$EmptyClass
	at io.github.dunwu.javacore.jvm.classloader.exception.ClassCastExceptionDemo.main(ClassCastExceptionDemo.java:11)
```

## å‚è€ƒèµ„æ–™

- [ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹](https://item.jd.com/11252778.html)
- [ä¸€ç¯‡å›¾æ–‡å½»åº•å¼„æ‡‚ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æœºåˆ¶](https://juejin.im/post/5e479c2cf265da575f4e65e4)
- [Jvm ç³»åˆ—(ä¸€):Java ç±»çš„åŠ è½½æœºåˆ¶](http://www.ityouknow.com/jvm/2017/08/19/class-loading-principle.html)
