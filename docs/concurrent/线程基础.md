# çº¿ç¨‹åŸºç¡€

> ğŸ““ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ[javacore](https://github.com/dunwu/javacore)ã€

<!-- TOC depthFrom:2 depthTo:3 -->

- [çº¿ç¨‹ç®€ä»‹](#çº¿ç¨‹ç®€ä»‹)
    - [ä»€ä¹ˆæ˜¯çº¿ç¨‹](#ä»€ä¹ˆæ˜¯çº¿ç¨‹)
    - [çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ](#çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ)
- [å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹](#å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹)
    - [æ„é€ çº¿ç¨‹](#æ„é€ çº¿ç¨‹)
    - [ä¸­æ–­çº¿ç¨‹](#ä¸­æ–­çº¿ç¨‹)
    - [ç»ˆæ­¢çº¿ç¨‹](#ç»ˆæ­¢çº¿ç¨‹)
    - [Thread ä¸­çš„é‡è¦æ–¹æ³•](#thread-ä¸­çš„é‡è¦æ–¹æ³•)
- [çº¿ç¨‹é—´é€šä¿¡](#çº¿ç¨‹é—´é€šä¿¡)
    - [wait/notify/notifyAll](#waitnotifynotifyall)
    - [çº¿ç¨‹çš„ç¤¼è®©](#çº¿ç¨‹çš„ç¤¼è®©)
    - [ThreadLocal](#threadlocal)
    - [ç®¡é“è¾“å…¥/è¾“å‡ºæµ](#ç®¡é“è¾“å…¥è¾“å‡ºæµ)
- [FAQ](#faq)
    - [start() å’Œ run() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ Thread ç±»çš„ run() æ–¹æ³•ä¹ˆï¼Ÿ](#start-å’Œ-run-æœ‰ä»€ä¹ˆåŒºåˆ«å¯ä»¥ç›´æ¥è°ƒç”¨-thread-ç±»çš„-run-æ–¹æ³•ä¹ˆ)
    - [sleep()ã€yield()ã€join() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆ sleep()å’Œ yield()æ–¹æ³•æ˜¯é™æ€çš„ï¼Ÿ](#sleepyieldjoin-æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ä¸ºä»€ä¹ˆ-sleepå’Œ-yieldæ–¹æ³•æ˜¯é™æ€çš„)
    - [ä¸ºä»€ä¹ˆ sleep() å’Œ yield() æ–¹æ³•æ˜¯é™æ€çš„](#ä¸ºä»€ä¹ˆ-sleep-å’Œ-yield-æ–¹æ³•æ˜¯é™æ€çš„)
    - [Java çš„çº¿ç¨‹ä¼˜å…ˆçº§å¦‚ä½•æ§åˆ¶ï¼Ÿé«˜ä¼˜å…ˆçº§çš„ Java çº¿ç¨‹ä¸€å®šå…ˆæ‰§è¡Œå—ï¼Ÿ](#java-çš„çº¿ç¨‹ä¼˜å…ˆçº§å¦‚ä½•æ§åˆ¶é«˜ä¼˜å…ˆçº§çš„-java-çº¿ç¨‹ä¸€å®šå…ˆæ‰§è¡Œå—)
    - [ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ˆæŠ¤çº¿ç¨‹ï¼Ÿå¦‚ä½•åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹ï¼Ÿ](#ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ä¸ºä»€ä¹ˆè¦ç”¨å®ˆæŠ¤çº¿ç¨‹å¦‚ä½•åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹)
    - [ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³• wait(), notify()å’Œ notifyAll()è¢«å®šä¹‰åœ¨ Object ç±»é‡Œï¼Ÿ](#ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³•-wait-notifyå’Œ-notifyallè¢«å®šä¹‰åœ¨-object-ç±»é‡Œ)
    - [ä¸ºä»€ä¹ˆ wait(), notify()å’Œ notifyAll()å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ï¼Ÿ](#ä¸ºä»€ä¹ˆ-wait-notifyå’Œ-notifyallå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨)
- [èµ„æ–™](#èµ„æ–™)

<!-- /TOC -->

## çº¿ç¨‹ç®€ä»‹

### ä»€ä¹ˆæ˜¯çº¿ç¨‹

ç°ä»£æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯çº¿ç¨‹ï¼Œä¹Ÿå«è½»é‡çº§è¿›ç¨‹ï¼ˆLight Weight Processï¼‰ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œå¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹éƒ½æ‹¥æœ‰å„è‡ªçš„è®¡æ•°å™¨ã€å †æ ˆå’Œå±€éƒ¨å˜é‡ç­‰å±æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®å…±äº«çš„å†…å­˜å˜é‡ã€‚

### çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ

<p align="center">
  <img src="http://dunwu.test.upcdn.net/cs/java/concurrent/thread-state.png">
</p>

`java.lang.Thread.State` ä¸­å®šä¹‰äº† **6** ç§ä¸åŒçš„çº¿ç¨‹çŠ¶æ€ï¼Œåœ¨ç»™å®šçš„ä¸€ä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹åªèƒ½å¤„äºå…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€ã€‚

ä»¥ä¸‹æ˜¯å„çŠ¶æ€çš„è¯´æ˜ï¼Œä»¥åŠçŠ¶æ€é—´çš„è”ç³»ï¼š

- **å¼€å§‹ï¼ˆNewï¼‰** - è¿˜æ²¡æœ‰è°ƒç”¨ `start()` æ–¹æ³•çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚
- **å¯è¿è¡Œï¼ˆRunnableï¼‰** - å·²ç»è°ƒç”¨äº† `start()` æ–¹æ³•çš„çº¿ç¨‹çŠ¶æ€ã€‚æ­¤çŠ¶æ€æ„å‘³ç€ï¼Œçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œä¸€æ—¦è¢«çº¿ç¨‹è°ƒåº¦å™¨åˆ†é…äº† CPU æ—¶é—´ç‰‡ï¼Œå°±å¯ä»¥è¿è¡Œçº¿ç¨‹ã€‚
- **é˜»å¡ï¼ˆBlockedï¼‰** - é˜»å¡çŠ¶æ€ã€‚çº¿ç¨‹é˜»å¡çš„çº¿ç¨‹çŠ¶æ€ç­‰å¾…ç›‘è§†å™¨é”å®šã€‚å¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…ç›‘è§†å™¨é”å®šï¼Œä»¥ä¾¿åœ¨è°ƒç”¨ `Object.wait()` ä¹‹åè¾“å…¥åŒæ­¥å—/æ–¹æ³•æˆ–é‡æ–°è¾“å…¥åŒæ­¥å—/æ–¹æ³•ã€‚
- **ç­‰å¾…ï¼ˆWaitingï¼‰** - ç­‰å¾…çŠ¶æ€ã€‚ä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œæ˜¯ç”±äºæ‰§è¡Œäº† 3 ä¸ªæ–¹æ³•ä¸­çš„ä»»æ„æ–¹æ³•ï¼š
  - `Object.wait()`
  - `Thread.join()`
  - `LockSupport.park()`
- **å®šæ—¶ç­‰å¾…ï¼ˆTimed waitingï¼‰** - ç­‰å¾…æŒ‡å®šæ—¶é—´çš„çŠ¶æ€ã€‚ä¸€ä¸ªçº¿ç¨‹å¤„äºå®šæ—¶ç­‰å¾…çŠ¶æ€ï¼Œæ˜¯ç”±äºæ‰§è¡Œäº†ä»¥ä¸‹æ–¹æ³•ä¸­çš„ä»»æ„æ–¹æ³•ï¼š
  - `Thread.sleep(sleeptime)`
  - `Object.wait(timeout)`
  - `Thread.join(timeout)`
  - `LockSupport.parkNanos(timeout)`
  - `LockSupport.parkUntil(timeout)`
- **ç»ˆæ­¢(Terminated)** - çº¿ç¨‹ `run()` æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œæˆ–è€…å› å¼‚å¸¸é€€å‡ºäº† `run()` æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚æ­»äº¡çš„çº¿ç¨‹ä¸å¯å†æ¬¡å¤ç”Ÿã€‚

## å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹

### æ„é€ çº¿ç¨‹

æ„é€ çº¿ç¨‹ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼

- ç»§æ‰¿ `Thread` ç±»
- å®ç° `Runnable` æ¥å£
- å®ç° `Callable` æ¥å£

#### ç»§æ‰¿ Thread ç±»

é€šè¿‡ç»§æ‰¿ Thread ç±»æ„é€ çº¿ç¨‹çš„æ­¥éª¤ï¼š

- å®šä¹‰ Thread ç±»çš„å­ç±»ï¼Œå¹¶é‡å†™è¯¥ç±»çš„ run() æ–¹æ³•ï¼Œè¯¥ run() æ–¹æ³•çš„æ–¹æ³•ä½“å°±ä»£è¡¨äº†çº¿ç¨‹è¦å®Œæˆçš„ä»»åŠ¡ã€‚å› æ­¤æŠŠ run() æ–¹æ³•ç§°ä¸ºæ‰§è¡Œä½“ã€‚
- åˆ›å»º Thread å­ç±»çš„å®ä¾‹ï¼Œå³åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ã€‚
- è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start() æ–¹æ³•æ¥å¯åŠ¨è¯¥çº¿ç¨‹ã€‚

ç¤ºä¾‹ï¼š

```java
public class ThreadDemo02 {

    public static void main(String[] args) {
        Thread02 mt1 = new Thread02("çº¿ç¨‹A "); // å®ä¾‹åŒ–å¯¹è±¡
        Thread02 mt2 = new Thread02("çº¿ç¨‹B "); // å®ä¾‹åŒ–å¯¹è±¡
        mt1.start(); // è°ƒç”¨çº¿ç¨‹ä¸»ä½“
        mt2.start(); // è°ƒç”¨çº¿ç¨‹ä¸»ä½“
    }

    static class Thread02 extends Thread {

        private int ticket = 5;

        Thread02(String name) {
            super(name);
        }

        @Override
        public void run() {
            for (int i = 0; i < 100; i++) {
                if (this.ticket > 0) {
                    System.out.println(this.getName() + " å–ç¥¨ï¼šticket = " + ticket--);
                }
            }
        }
    }
}
```

#### å®ç° Runnable æ¥å£

é€šè¿‡å®ç° Runnable æ¥å£æ„é€ çº¿ç¨‹çš„æ­¥éª¤ï¼š

- å®šä¹‰ Runnable æ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™è¯¥æ¥å£çš„ run() æ–¹æ³•ï¼Œè¯¥ run() æ–¹æ³•çš„æ–¹æ³•ä½“åŒæ ·æ˜¯è¯¥çº¿ç¨‹çš„çº¿ç¨‹æ‰§è¡Œä½“ã€‚
- åˆ›å»º Runnable å®ç°ç±»çš„å®ä¾‹ï¼Œå¹¶ä¾æ­¤å®ä¾‹ä½œä¸º Thread çš„ target æ¥åˆ›å»º Thread å¯¹è±¡ï¼Œè¯¥ Thread å¯¹è±¡æ‰æ˜¯çœŸæ­£çš„çº¿ç¨‹å¯¹è±¡ã€‚
- è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start() æ–¹æ³•æ¥å¯åŠ¨è¯¥çº¿ç¨‹ã€‚

ç¤ºä¾‹ï¼š

```java
public class RunnableDemo {

    public static void main(String[] args) {
        MyThread t = new MyThread("Runnable çº¿ç¨‹"); // å®ä¾‹åŒ–å¯¹è±¡
        new Thread(t).run(); // è°ƒç”¨çº¿ç¨‹ä¸»ä½“
        new Thread(t).run(); // è°ƒç”¨çº¿ç¨‹ä¸»ä½“
        new Thread(t).run(); // è°ƒç”¨çº¿ç¨‹ä¸»ä½“
    }

    static class MyThread implements Runnable {

        private int ticket = 5;
        private String name;

        MyThread(String name) {
            this.name = name;
        }

        @Override
        public void run() {
            for (int i = 0; i < 100; i++) {
                if (this.ticket > 0) {
                    System.out.println(this.name + " å–ç¥¨ï¼šticket = " + ticket--);
                }
            }
        }
    }
}
```

#### å®ç° Callable æ¥å£

é€šè¿‡å®ç° Callable æ¥å£æ„é€ çº¿ç¨‹çš„æ­¥éª¤ï¼š

- åˆ›å»º Callable æ¥å£çš„å®ç°ç±»ï¼Œå¹¶å®ç° call() æ–¹æ³•ï¼Œè¯¥ call() æ–¹æ³•å°†ä½œä¸ºçº¿ç¨‹æ‰§è¡Œä½“ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼ã€‚
- åˆ›å»º Callable å®ç°ç±»çš„å®ä¾‹ï¼Œä½¿ç”¨ FutureTask ç±»æ¥åŒ…è£… Callable å¯¹è±¡ï¼Œè¯¥ FutureTask å¯¹è±¡å°è£…äº†è¯¥ Callable å¯¹è±¡çš„ call() æ–¹æ³•çš„è¿”å›å€¼ã€‚
- ä½¿ç”¨ FutureTask å¯¹è±¡ä½œä¸º Thread å¯¹è±¡çš„ target åˆ›å»ºå¹¶å¯åŠ¨æ–°çº¿ç¨‹ã€‚
- è°ƒç”¨ FutureTask å¯¹è±¡çš„ get() æ–¹æ³•æ¥è·å¾—å­çº¿ç¨‹æ‰§è¡Œç»“æŸåçš„è¿”å›å€¼ã€‚

ç¤ºä¾‹ï¼š

```java
public class CallableAndFutureDemo {

    public static void main(String[] args) {
        Callable<Integer> callable = () -> new Random().nextInt(100);
        FutureTask<Integer> future = new FutureTask<>(callable);
        new Thread(future).start();
        try {
            Thread.sleep(1000);// å¯èƒ½åšä¸€äº›äº‹æƒ…
            System.out.println(future.get());
        } catch (InterruptedException | ExecutionException e) {
            e.printStackTrace();
        }
    }
}
```

#### ä¸‰ç§åˆ›å»ºçº¿ç¨‹æ–¹å¼å¯¹æ¯”

- **å®ç° Runnable æ¥å£ä¼˜äºç»§æ‰¿ Thread ç±»**ï¼Œå› ä¸ºå®ç°æ¥å£æ–¹å¼æ›´ä¾¿äºæ‰©å±•ç±»ã€‚
- å®ç° Runnable æ¥å£çš„çº¿ç¨‹æ²¡æœ‰è¿”å›å€¼ï¼›è€Œ**å®ç° Callable æ¥å£çš„çº¿ç¨‹æœ‰è¿”å›å€¼**ã€‚

### ä¸­æ–­çº¿ç¨‹

å½“ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›´æ¥é€šè¿‡ `interrupt()` æ–¹æ³•ä¸­æ–­å…¶è¿è¡ŒçŠ¶æ€ã€‚

```java
public class ThreadInterruptDemo {

    public static void main(String[] args) {
        MyThread mt = new MyThread(); // å®ä¾‹åŒ–Runnableå­ç±»å¯¹è±¡
        Thread t = new Thread(mt, "çº¿ç¨‹"); // å®ä¾‹åŒ–Threadå¯¹è±¡
        t.start(); // å¯åŠ¨çº¿ç¨‹
        try {
            Thread.sleep(2000); // çº¿ç¨‹ä¼‘çœ 2ç§’
        } catch (InterruptedException e) {
            System.out.println("3ã€ä¼‘çœ è¢«ç»ˆæ­¢");
        }
        t.interrupt(); // ä¸­æ–­çº¿ç¨‹æ‰§è¡Œ
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            System.out.println("1ã€è¿›å…¥run()æ–¹æ³•");
            try {
                Thread.sleep(10000); // çº¿ç¨‹ä¼‘çœ 10ç§’
                System.out.println("2ã€å·²ç»å®Œæˆäº†ä¼‘çœ ");
            } catch (InterruptedException e) {
                System.out.println("3ã€ä¼‘çœ è¢«ç»ˆæ­¢");
                return; // è¿”å›è°ƒç”¨å¤„
            }
            System.out.println("4ã€run()æ–¹æ³•æ­£å¸¸ç»“æŸ");
        }
    }
}
```

### ç»ˆæ­¢çº¿ç¨‹

Thread ä¸­çš„ stop æ–¹æ³•æœ‰ç¼ºé™·ï¼Œå·²åºŸå¼ƒã€‚

å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹æœ‰ä¸¤ç§æ–¹æ³•ï¼š

1.  ä¸­æ–­çŠ¶æ€æ˜¯çº¿ç¨‹çš„ä¸€ä¸ªæ ‡è¯†ä½ï¼Œè€Œä¸­æ–­æ“ä½œæ˜¯ä¸€ç§ç®€ä¾¿çš„çº¿ç¨‹é—´äº¤äº’æ–¹å¼ï¼Œè€Œè¿™ç§äº¤äº’æ–¹å¼æœ€é€‚åˆç”¨æ¥å–æ¶ˆæˆ–åœæ­¢ä»»åŠ¡ã€‚
2.  è¿˜å¯ä»¥åˆ©ç”¨ä¸€ä¸ª boolean å˜é‡æ¥æ§åˆ¶æ˜¯å¦éœ€è¦åœæ­¢ä»»åŠ¡å¹¶ç»ˆæ­¢è¯¥çº¿ç¨‹ã€‚

```java
public class ThreadStopDemo03 {

    public static void main(String[] args) throws Exception {
        MyTask one = new MyTask();
        Thread countThread = new Thread(one, "CountThread");
        countThread.start();
        // ç¡çœ 1ç§’ï¼Œmainçº¿ç¨‹å¯¹CountThreadè¿›è¡Œä¸­æ–­ï¼Œä½¿CountThreadèƒ½å¤Ÿæ„ŸçŸ¥ä¸­æ–­è€Œç»“æŸ
        TimeUnit.SECONDS.sleep(1);
        countThread.interrupt();
        MyTask two = new MyTask();
        countThread = new Thread(two, "CountThread");
        countThread.start();
        // ç¡çœ 1ç§’ï¼Œmainçº¿ç¨‹å¯¹Runner twoè¿›è¡Œå–æ¶ˆï¼Œä½¿CountThreadèƒ½å¤Ÿæ„ŸçŸ¥onä¸ºfalseè€Œç»“æŸ
        TimeUnit.SECONDS.sleep(1);
        two.cancel();
    }

    private static class MyTask implements Runnable {

        private long i;
        private volatile boolean on = true;

        @Override
        public void run() {
            while (on && !Thread.currentThread().isInterrupted()) {
                i++;
            }
            System.out.println("Count i = " + i);
        }

        void cancel() {
            on = false;
        }
    }
}
```

### Thread ä¸­çš„é‡è¦æ–¹æ³•

- `run` - çº¿ç¨‹çš„æ‰§è¡Œå®ä½“ã€‚
- `start` - çº¿ç¨‹çš„å¯åŠ¨æ–¹æ³•ã€‚
- `setName`ã€`getName` - å¯ä»¥é€šè¿‡ setName()ã€ getName() æ¥è®¾ç½®ã€è·å–çº¿ç¨‹åç§°ã€‚
- `setPriority`ã€`getPriority` - åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çº¿ç¨‹åœ¨è¿è¡Œå‰éƒ½ä¼šä¿æŒåœ¨å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œå“ªä¸ªçº¿ç¨‹ä¼˜å…ˆçº§é«˜ï¼Œå“ªä¸ªçº¿ç¨‹å°±æœ‰å¯èƒ½è¢«å…ˆæ‰§è¡Œã€‚å¯ä»¥é€šè¿‡ setPriorityã€getPriority æ¥è®¾ç½®ã€è·å–çº¿ç¨‹ä¼˜å…ˆçº§ã€‚
- `setDaemon`ã€`isDaemon` - å¯ä»¥ä½¿ç”¨ setDaemon() æ–¹æ³•è®¾ç½®çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼›å¯ä»¥ä½¿ç”¨ isDaemon() æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚
- `isAlive` - å¯ä»¥é€šè¿‡ isAlive æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨ã€‚
- `interrupt` - å½“ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›´æ¥é€šè¿‡ interrupt() æ–¹æ³•ä¸­æ–­å…¶è¿è¡ŒçŠ¶æ€ã€‚
- `join` - ä½¿ç”¨ join() æ–¹æ³•è®©ä¸€ä¸ªçº¿ç¨‹å¼ºåˆ¶è¿è¡Œï¼Œçº¿ç¨‹å¼ºåˆ¶è¿è¡ŒæœŸé—´ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è¿è¡Œï¼Œå¿…é¡»ç­‰å¾…æ­¤çº¿ç¨‹å®Œæˆä¹‹åæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚
- `Thread.sleep` - ä½¿ç”¨ Thread.sleep() æ–¹æ³•å³å¯å®ç°ä¼‘çœ ã€‚
- `Thread.yield` - å¯ä»¥ä½¿ç”¨ Thread.yield() æ–¹æ³•å°†ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œæš‚æ—¶è®©ç»™å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚

#### è®¾ç½®/è·å–çº¿ç¨‹åç§°

åœ¨ Thread ç±»ä¸­å¯ä»¥é€šè¿‡ `setName()`ã€ `getName()` æ¥è®¾ç½®ã€è·å–çº¿ç¨‹åç§°ã€‚

```java
public class ThreadNameDemo {

    public static void main(String[] args) {
        MyThread mt = new MyThread(); // å®ä¾‹åŒ–Runnableå­ç±»å¯¹è±¡
        new Thread(mt).start(); // ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®çº¿ç¨‹åç§°
        new Thread(mt, "çº¿ç¨‹-A").start(); // æ‰‹å·¥è®¾ç½®çº¿ç¨‹åç§°
        Thread t = new Thread(mt); // æ‰‹å·¥è®¾ç½®çº¿ç¨‹åç§°
        t.setName("çº¿ç¨‹-B");
        t.start();
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            for (int i = 0; i < 3; i++) {
                System.out.println(Thread.currentThread().getName() + "è¿è¡Œï¼Œi = " + i); // å–å¾—å½“å‰çº¿ç¨‹çš„åå­—
            }
        }
    }
}
```

#### åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨

åœ¨ Thread ç±»ä¸­å¯ä»¥é€šè¿‡ `isAlive()` æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨ã€‚

```java
public class ThreadAliveDemo {

    public static void main(String[] args) {
        MyThread mt = new MyThread(); // å®ä¾‹åŒ–Runnableå­ç±»å¯¹è±¡
        Thread t = new Thread(mt, "çº¿ç¨‹"); // å®ä¾‹åŒ–Threadå¯¹è±¡
        System.out.println("çº¿ç¨‹å¼€å§‹æ‰§è¡Œä¹‹å‰ --> " + t.isAlive()); // åˆ¤æ–­æ˜¯å¦å¯åŠ¨
        t.start(); // å¯åŠ¨çº¿ç¨‹
        System.out.println("çº¿ç¨‹å¼€å§‹æ‰§è¡Œä¹‹å --> " + t.isAlive()); // åˆ¤æ–­æ˜¯å¦å¯åŠ¨
        for (int i = 0; i < 3; i++) {
            System.out.println(" mainè¿è¡Œ --> " + i);
        }
        // ä»¥ä¸‹çš„è¾“å‡ºç»“æœä¸ç¡®å®š
        System.out.println("ä»£ç æ‰§è¡Œä¹‹å --> " + t.isAlive()); // åˆ¤æ–­æ˜¯å¦å¯åŠ¨

    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            for (int i = 0; i < 3; i++) {
                System.out.println(Thread.currentThread().getName() + "è¿è¡Œï¼Œi = " + i);
            }
        }
    }
}
```

#### å®ˆæŠ¤çº¿ç¨‹

åœ¨ Java ç¨‹åºä¸­ï¼Œåªè¦å‰å°æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œåˆ™æ•´ä¸ª Java è¿›ç¨‹å°±ä¸ä¼šæ¶ˆå¤±ï¼Œæ‰€ä»¥æ­¤æ—¶å¯ä»¥è®¾ç½®ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œè¿™æ ·å³ä½¿ Java è¿›ç¨‹ç»“æŸäº†ï¼Œæ­¤å®ˆæŠ¤çº¿ç¨‹ä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œã€‚å¯ä»¥ä½¿ç”¨ `setDaemon()` æ–¹æ³•è®¾ç½®çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼›å¯ä»¥ä½¿ç”¨ `isDaemon()` æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚

```java
public class ThreadDaemonDemo {

    public static void main(String[] args) {
        Thread t = new Thread(new MyThread(), "çº¿ç¨‹");
        t.setDaemon(true); // æ­¤çº¿ç¨‹åœ¨åå°è¿è¡Œ
        System.out.println("çº¿ç¨‹ t æ˜¯å¦æ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼š" + t.isDaemon());
        t.start(); // å¯åŠ¨çº¿ç¨‹
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            while (true) {
                System.out.println(Thread.currentThread().getName() + "åœ¨è¿è¡Œã€‚");
            }
        }
    }
}
```

#### è®¾ç½®/è·å–çº¿ç¨‹ä¼˜å…ˆçº§

åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çº¿ç¨‹åœ¨è¿è¡Œå‰éƒ½ä¼šä¿æŒåœ¨å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œå“ªä¸ªçº¿ç¨‹ä¼˜å…ˆçº§é«˜ï¼Œå“ªä¸ªçº¿ç¨‹å°±æœ‰å¯èƒ½è¢«å…ˆæ‰§è¡Œã€‚

```java
public class ThreadPriorityDemo {

    public static void main(String[] args) {
        System.out.println("ä¸»æ–¹æ³•çš„ä¼˜å…ˆçº§ï¼š" + Thread.currentThread().getPriority());
        System.out.println("MAX_PRIORITY = " + Thread.MAX_PRIORITY);
        System.out.println("NORM_PRIORITY = " + Thread.NORM_PRIORITY);
        System.out.println("MIN_PRIORITY = " + Thread.MIN_PRIORITY);

        Thread t1 = new Thread(new MyThread(), "çº¿ç¨‹A"); // å®ä¾‹åŒ–çº¿ç¨‹å¯¹è±¡
        Thread t2 = new Thread(new MyThread(), "çº¿ç¨‹B"); // å®ä¾‹åŒ–çº¿ç¨‹å¯¹è±¡
        Thread t3 = new Thread(new MyThread(), "çº¿ç¨‹C"); // å®ä¾‹åŒ–çº¿ç¨‹å¯¹è±¡
        t1.setPriority(Thread.MIN_PRIORITY); // ä¼˜å…ˆçº§æœ€ä½
        t2.setPriority(Thread.MAX_PRIORITY); // ä¼˜å…ˆçº§æœ€ä½
        t3.setPriority(Thread.NORM_PRIORITY); // ä¼˜å…ˆçº§æœ€ä½
        t1.start(); // å¯åŠ¨çº¿ç¨‹
        t2.start(); // å¯åŠ¨çº¿ç¨‹
        t3.start(); // å¯åŠ¨çº¿ç¨‹
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            for (int i = 0; i < 5; i++) {
                try {
                    Thread.sleep(500); // çº¿ç¨‹ä¼‘çœ 
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // å–å¾—å½“å‰çº¿ç¨‹çš„åå­—
                String out =
                    Thread.currentThread().getName() + "ï¼Œä¼˜å…ˆçº§ï¼š" + Thread.currentThread().getPriority() + "ï¼Œè¿è¡Œï¼ši = " + i;
                System.out.println(out);
            }
        }
    }
}
```

## çº¿ç¨‹é—´é€šä¿¡

### wait/notify/notifyAll

waitã€notifyã€notifyAll æ˜¯ Object ç±»ä¸­çš„æ–¹æ³•ã€‚

- `wait` - çº¿ç¨‹è‡ªåŠ¨é‡Šæ”¾å…¶å æœ‰çš„å¯¹è±¡é”ï¼Œå¹¶ç­‰å¾… notifyã€‚
- `notify` - å”¤é†’ä¸€ä¸ªæ­£åœ¨ wait å½“å‰å¯¹è±¡é”çš„çº¿ç¨‹ï¼Œå¹¶è®©å®ƒæ‹¿åˆ°å¯¹è±¡é”ã€‚
- `notifyAll` - å”¤é†’æ‰€æœ‰æ­£åœ¨ wait å‰å¯¹è±¡é”çš„çº¿ç¨‹ã€‚

ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ç¤ºä¾‹ï¼š

```java
public class ThreadWaitNotifyDemo02 {

    private static final int QUEUE_SIZE = 10;
    private static final PriorityQueue<Integer> queue = new PriorityQueue<>(QUEUE_SIZE);

    public static void main(String[] args) {
        new Producer("ç”Ÿäº§è€…A").start();
        new Producer("ç”Ÿäº§è€…B").start();
        new Consumer("æ¶ˆè´¹è€…A").start();
        new Consumer("æ¶ˆè´¹è€…B").start();
    }

    static class Consumer extends Thread {

        Consumer(String name) {
            super(name);
        }

        @Override
        public void run() {
            while (true) {
                synchronized (queue) {
                    while (queue.size() == 0) {
                        try {
                            System.out.println("é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…æ•°æ®");
                            queue.wait();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                            queue.notifyAll();
                        }
                    }
                    queue.poll(); // æ¯æ¬¡ç§»èµ°é˜Ÿé¦–å…ƒç´ 
                    queue.notifyAll();
                    try {
                        Thread.sleep(500);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    System.out.println(Thread.currentThread().getName() + " ä»é˜Ÿåˆ—å–èµ°ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—å½“å‰æœ‰ï¼š" + queue.size() + "ä¸ªå…ƒç´ ");
                }
            }
        }
    }

    static class Producer extends Thread {

        Producer(String name) {
            super(name);
        }

        @Override
        public void run() {
            while (true) {
                synchronized (queue) {
                    while (queue.size() == QUEUE_SIZE) {
                        try {
                            System.out.println("é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…æœ‰ç©ºä½™ç©ºé—´");
                            queue.wait();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                            queue.notifyAll();
                        }
                    }
                    queue.offer(1); // æ¯æ¬¡æ’å…¥ä¸€ä¸ªå…ƒç´ 
                    queue.notifyAll();
                    try {
                        Thread.sleep(500);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    System.out.println(Thread.currentThread().getName() + " å‘é˜Ÿåˆ—å–ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—å½“å‰æœ‰ï¼š" + queue.size() + "ä¸ªå…ƒç´ ");
                }
            }
        }
    }
}
```

### çº¿ç¨‹çš„ç¤¼è®©

åœ¨çº¿ç¨‹æ“ä½œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `Thread.yield()` æ–¹æ³•å°†ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œæš‚æ—¶è®©ç»™å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚

```java
public class ThreadYieldDemo {

    public static void main(String[] args) {
        MyThread t = new MyThread();
        new Thread(t, "çº¿ç¨‹A").start();
        new Thread(t, "çº¿ç¨‹B").start();
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            for (int i = 0; i < 5; i++) {
                try {
                    Thread.sleep(1000);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread().getName() + "è¿è¡Œï¼Œi = " + i);
                if (i == 2) {
                    System.out.print("çº¿ç¨‹ç¤¼è®©ï¼š");
                    Thread.yield();
                }
            }
        }
    }
}
```

#### çº¿ç¨‹çš„å¼ºåˆ¶æ‰§è¡Œ

åœ¨çº¿ç¨‹æ“ä½œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `join()` æ–¹æ³•è®©ä¸€ä¸ªçº¿ç¨‹å¼ºåˆ¶è¿è¡Œï¼Œçº¿ç¨‹å¼ºåˆ¶è¿è¡ŒæœŸé—´ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è¿è¡Œï¼Œå¿…é¡»ç­‰å¾…æ­¤çº¿ç¨‹å®Œæˆä¹‹åæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚

```java
public class ThreadJoinDemo {

    public static void main(String[] args) {
        MyThread mt = new MyThread(); // å®ä¾‹åŒ–Runnableå­ç±»å¯¹è±¡
        Thread t = new Thread(mt, "mythread"); // å®ä¾‹åŒ–Threadå¯¹è±¡
        t.start(); // å¯åŠ¨çº¿ç¨‹
        for (int i = 0; i < 50; i++) {
            if (i > 10) {
                try {
                    t.join(); // çº¿ç¨‹å¼ºåˆ¶è¿è¡Œ
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            System.out.println("Main çº¿ç¨‹è¿è¡Œ --> " + i);
        }
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            for (int i = 0; i < 50; i++) {
                System.out.println(Thread.currentThread().getName() + " è¿è¡Œï¼Œi = " + i); // å–å¾—å½“å‰çº¿ç¨‹çš„åå­—
            }
        }
    }
}
```

#### çº¿ç¨‹çš„ä¼‘çœ 

ç›´æ¥ä½¿ç”¨ `Thread.sleep()` æ–¹æ³•å³å¯å®ç°ä¼‘çœ ã€‚

```java
public class ThreadSleepDemo {

    public static void main(String[] args) {
        new Thread(new MyThread("çº¿ç¨‹A", 1000)).start();
        new Thread(new MyThread("çº¿ç¨‹A", 2000)).start();
        new Thread(new MyThread("çº¿ç¨‹A", 3000)).start();
    }

    static class MyThread implements Runnable {

        private String name;
        private int time;

        private MyThread(String name, int time) {
            this.name = name; // è®¾ç½®çº¿ç¨‹åç§°
            this.time = time; // è®¾ç½®ä¼‘çœ æ—¶é—´
        }

        @Override
        public void run() {
            try {
                Thread.sleep(this.time); // ä¼‘çœ æŒ‡å®šçš„æ—¶é—´
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(this.name + "çº¿ç¨‹ï¼Œä¼‘çœ " + this.time + "æ¯«ç§’ã€‚");
        }
    }
}
```

### ThreadLocal

ThreadLocalï¼Œå¾ˆå¤šåœ°æ–¹å«åšçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œä¹Ÿæœ‰äº›åœ°æ–¹å«åšçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå…¶å®æ„æ€å·®ä¸å¤šã€‚å¯èƒ½å¾ˆå¤šæœ‹å‹éƒ½çŸ¥é“ ThreadLocal ä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨çš„å‰¯æœ¬å˜é‡ã€‚

#### æºç 

ThreadLocal çš„ä¸»è¦æ–¹æ³•ï¼š

```java
public class ThreadLocal<T> {
    public T get() {}
	public void remove() {}
	public void set(T value) {}
	public static <S> ThreadLocal<S> withInitial(Supplier<? extends S> supplier) {}
}
```

- get()æ–¹æ³•æ˜¯ç”¨æ¥è·å– ThreadLocal åœ¨å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„å˜é‡å‰¯æœ¬ã€‚
- set()ç”¨æ¥è®¾ç½®å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚
- remove()ç”¨æ¥ç§»é™¤å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚
- initialValue()æ˜¯ä¸€ä¸ª protected æ–¹æ³•ï¼Œä¸€èˆ¬æ˜¯ç”¨æ¥åœ¨ä½¿ç”¨æ—¶è¿›è¡Œé‡å†™çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªå»¶è¿ŸåŠ è½½æ–¹æ³•ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜ã€‚

##### get() æºç å®ç°

**get æºç **

```java
public T get() {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null) {
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings("unchecked")
            T result = (T)e.value;
            return result;
        }
    }
    return setInitialValue();
}
```

1.  å–å¾—å½“å‰çº¿ç¨‹ã€‚
2.  é€šè¿‡ getMap() æ–¹æ³•è·å– ThreadLocalMapã€‚
3.  æˆåŠŸï¼Œè¿”å› valueï¼›å¤±è´¥ï¼Œè¿”å› setInitialValue()ã€‚

##### ThreadLocalMap æºç å®ç°

**ThreadLocalMap æºç **

ThreadLocalMap æ˜¯ ThreadLocal çš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚

ThreadLocalMap çš„ Entry ç»§æ‰¿äº† WeakReferenceï¼Œå¹¶ä¸”ä½¿ç”¨ ThreadLocal ä½œä¸ºé”®å€¼ã€‚

##### setInitialValue æºç å®ç°

```java
private T setInitialValue() {
    T value = initialValue();
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
    return value;
}
```

å¦‚æœ map ä¸ä¸ºç©ºï¼Œå°±è®¾ç½®é”®å€¼å¯¹ï¼›ä¸ºç©ºï¼Œå†åˆ›å»º Mapï¼Œçœ‹ä¸€ä¸‹ createMap çš„å®ç°ï¼š

```java
void createMap(Thread t, T firstValue) {
    t.threadLocals = new ThreadLocalMap(this, firstValue);
}
```

##### ThreadLocal æºç å°ç»“

è‡³æ­¤ï¼Œå¯èƒ½å¤§éƒ¨åˆ†æœ‹å‹å·²ç»æ˜ç™½äº† ThreadLocal æ˜¯å¦‚ä½•ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºå˜é‡çš„å‰¯æœ¬çš„ï¼š

1.  åœ¨æ¯ä¸ªçº¿ç¨‹ Thread å†…éƒ¨æœ‰ä¸€ä¸ª ThreadLocal.ThreadLocalMap ç±»å‹çš„æˆå‘˜å˜é‡ threadLocalsï¼Œè¿™ä¸ª threadLocals å°±æ˜¯ç”¨æ¥å­˜å‚¨å®é™…çš„å˜é‡å‰¯æœ¬çš„ï¼Œé”®å€¼ä¸ºå½“å‰ ThreadLocal å˜é‡ï¼Œvalue ä¸ºå˜é‡å‰¯æœ¬ï¼ˆå³ T ç±»å‹çš„å˜é‡ï¼‰ã€‚
2.  åœ¨ Thread é‡Œé¢ï¼ŒthreadLocals ä¸ºç©ºï¼Œå½“é€šè¿‡ ThreadLocal å˜é‡è°ƒç”¨ get()æ–¹æ³•æˆ–è€… set()æ–¹æ³•ï¼Œå°±ä¼šå¯¹ Thread ç±»ä¸­çš„ threadLocals è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”ä»¥å½“å‰ ThreadLocal å˜é‡ä¸ºé”®å€¼ï¼Œä»¥ ThreadLocal è¦ä¿å­˜çš„å‰¯æœ¬å˜é‡ä¸º valueï¼Œå­˜åˆ° threadLocalsã€‚
3.  åœ¨å½“å‰çº¿ç¨‹é‡Œé¢ï¼Œå¦‚æœè¦ä½¿ç”¨å‰¯æœ¬å˜é‡ï¼Œå°±å¯ä»¥é€šè¿‡ get æ–¹æ³•åœ¨ threadLocals é‡Œé¢æŸ¥æ‰¾ã€‚

#### ç¤ºä¾‹

ThreadLocal æœ€å¸¸è§çš„åº”ç”¨åœºæ™¯ä¸ºç”¨äºè§£å†³æ•°æ®åº“è¿æ¥ã€Session ç®¡ç†ç­‰é—®é¢˜ã€‚

ç¤ºä¾‹ - æ•°æ®åº“è¿æ¥

```java
private static ThreadLocal<Connection> connectionHolder
= new ThreadLocal<Connection>() {
public Connection initialValue() {
    return DriverManager.getConnection(DB_URL);
}
};

public static Connection getConnection() {
return connectionHolder.get();
}
```

ç¤ºä¾‹ - Session ç®¡ç†

```java
private static final ThreadLocal threadSession = new ThreadLocal();

public static Session getSession() throws InfrastructureException {
    Session s = (Session) threadSession.get();
    try {
        if (s == null) {
            s = getSessionFactory().openSession();
            threadSession.set(s);
        }
    } catch (HibernateException ex) {
        throw new InfrastructureException(ex);
    }
    return s;
}
```

### ç®¡é“è¾“å…¥/è¾“å‡ºæµ

ç®¡é“è¾“å…¥/è¾“å‡ºæµå’Œæ™®é€šçš„æ–‡ä»¶è¾“å…¥/è¾“å‡ºæµæˆ–è€…ç½‘ç»œè¾“å…¥/è¾“å‡ºæµä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¸»è¦ç”¨äºçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œè€Œä¼ è¾“çš„åª’ä»‹ä¸ºå†…å­˜ã€‚
ç®¡é“è¾“å…¥/è¾“å‡ºæµä¸»è¦åŒ…æ‹¬äº†å¦‚ä¸‹ 4 ç§å…·ä½“å®ç°ï¼šPipedOutputStreamã€PipedInputStreamã€PipedReader å’Œ PipedWriterï¼Œå‰ä¸¤ç§é¢å‘å­—èŠ‚ï¼Œè€Œåä¸¤ç§é¢å‘å­—ç¬¦ã€‚

```java
public class Piped {

    public static void main(String[] args) throws Exception {
        PipedWriter out = new PipedWriter();
        PipedReader in = new PipedReader();
        // å°†è¾“å‡ºæµå’Œè¾“å…¥æµè¿›è¡Œè¿æ¥ï¼Œå¦åˆ™åœ¨ä½¿ç”¨æ—¶ä¼šæŠ›å‡ºIOException
        out.connect(in);
        Thread printThread = new Thread(new Print(in), "PrintThread");
        printThread.start();
        int receive = 0;
        try {
            while ((receive = System.in.read()) != -1) {
                out.write(receive);
            }
        } finally {
            out.close();
        }
    }

    static class Print implements Runnable {

        private PipedReader in;

        Print(PipedReader in) {
            this.in = in;
        }

        public void run() {
            int receive = 0;
            try {
                while ((receive = in.read()) != -1) {
                    System.out.print((char) receive);
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

## FAQ

### start() å’Œ run() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ Thread ç±»çš„ run() æ–¹æ³•ä¹ˆï¼Ÿ

run() æ–¹æ³•æ˜¯çº¿ç¨‹çš„æ‰§è¡Œä½“ã€‚

start() æ–¹æ³•ä¼šå¯åŠ¨çº¿ç¨‹ï¼Œç„¶å JVM ä¼šè®©è¿™ä¸ªçº¿ç¨‹å»æ‰§è¡Œ run() æ–¹æ³•ã€‚

å¯ä»¥ç›´æ¥è°ƒç”¨ Thread ç±»çš„ run() æ–¹æ³•ä¹ˆï¼Ÿ

- å¯ä»¥ã€‚ä½†æ˜¯å¦‚æœç›´æ¥è°ƒç”¨ Thread çš„ run()æ–¹æ³•ï¼Œå®ƒçš„è¡Œä¸ºå°±ä¼šå’Œæ™®é€šçš„æ–¹æ³•ä¸€æ ·ã€‚
- ä¸ºäº†åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œå¿…é¡»ä½¿ç”¨ Thread.start()æ–¹æ³•ã€‚

### sleep()ã€yield()ã€join() æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆ sleep()å’Œ yield()æ–¹æ³•æ˜¯é™æ€çš„ï¼Ÿ

- yield()
  - yield() æ–¹æ³•å¯ä»¥è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœï¼Œä½†å®ƒä¸ä¼šé˜»å¡è¯¥çº¿ç¨‹ï¼Œå®ƒåªæ˜¯å°†è¯¥çº¿ç¨‹ä» Running çŠ¶æ€è½¬å…¥ Runnable çŠ¶æ€ã€‚
  - å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨äº† yield() æ–¹æ³•æš‚åœä¹‹åï¼Œåªæœ‰ä¼˜å…ˆçº§ä¸å½“å‰çº¿ç¨‹ç›¸åŒï¼Œæˆ–è€…ä¼˜å…ˆçº§æ¯”å½“å‰çº¿ç¨‹æ›´é«˜çš„å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹æ‰ä¼šè·å¾—æ‰§è¡Œçš„æœºä¼šã€‚
- sleep()
  - sleep() æ–¹æ³•éœ€è¦æŒ‡å®šç­‰å¾…çš„æ—¶é—´ï¼Œå®ƒå¯ä»¥è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹åœ¨æŒ‡å®šçš„æ—¶é—´å†…æš‚åœæ‰§è¡Œï¼Œè¿›å…¥ Blocked çŠ¶æ€ã€‚
  - è¯¥æ–¹æ³•æ—¢å¯ä»¥è®©å…¶ä»–åŒä¼˜å…ˆçº§æˆ–è€…é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹å¾—åˆ°æ‰§è¡Œçš„æœºä¼šï¼Œä¹Ÿå¯ä»¥è®©ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å¾—åˆ°æ‰§è¡Œæœºä¼šã€‚
  - ä½†æ˜¯ï¼Œ sleep() æ–¹æ³•ä¸ä¼šé‡Šæ”¾â€œé”æ ‡å¿—â€ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæœ‰ synchronized åŒæ­¥å—ï¼Œå…¶ä»–çº¿ç¨‹ä»ç„¶ä¸èƒ½è®¿é—®å…±äº«æ•°æ®ã€‚
- join()
  - join() æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹è½¬å…¥ Blocked çŠ¶æ€ï¼Œç­‰å¾…è°ƒç”¨ join() æ–¹æ³•çš„çº¿ç¨‹ç»“æŸåæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

> å‚è€ƒé˜…è¯»ï¼š[Java çº¿ç¨‹ä¸­ yield ä¸ join æ–¹æ³•çš„åŒºåˆ«](http://www.importnew.com/14958.html)
> å‚è€ƒé˜…è¯»ï¼š[sleep()ï¼Œwait()ï¼Œyield()å’Œ join()æ–¹æ³•çš„åŒºåˆ«](https://blog.csdn.net/xiangwanpeng/article/details/54972952)

### ä¸ºä»€ä¹ˆ sleep() å’Œ yield() æ–¹æ³•æ˜¯é™æ€çš„

- Thread ç±»çš„ sleep() å’Œ yield() æ–¹æ³•å°†å¤„ç† Running çŠ¶æ€çš„çº¿ç¨‹ã€‚æ‰€ä»¥åœ¨å…¶ä»–å¤„äºé Running çŠ¶æ€çš„çº¿ç¨‹ä¸Šæ‰§è¡Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™äº›æ–¹æ³•æ˜¯é™æ€çš„ã€‚å®ƒä»¬å¯ä»¥åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸­å·¥ä½œï¼Œå¹¶é¿å…ç¨‹åºå‘˜é”™è¯¯çš„è®¤ä¸ºå¯ä»¥åœ¨å…¶ä»–éè¿è¡Œçº¿ç¨‹è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚

### Java çš„çº¿ç¨‹ä¼˜å…ˆçº§å¦‚ä½•æ§åˆ¶ï¼Ÿé«˜ä¼˜å…ˆçº§çš„ Java çº¿ç¨‹ä¸€å®šå…ˆæ‰§è¡Œå—ï¼Ÿ

- Java ä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§å¦‚ä½•æ§åˆ¶
  - Java ä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§çš„èŒƒå›´æ˜¯ [1,10]ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå…·æœ‰ä¼˜å…ˆæƒã€‚å¯ä»¥é€šè¿‡ `thread.setPriority(Thread.MAX_PRIORITY)` çš„æ–¹å¼è®¾ç½®ï¼Œé»˜è®¤ä¼˜å…ˆçº§ä¸º 5ã€‚
- é«˜ä¼˜å…ˆçº§çš„ Java çº¿ç¨‹ä¸€å®šå…ˆæ‰§è¡Œå—
  - å³ä½¿è®¾ç½®äº†çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿ**æ— æ³•ä¿è¯é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸€å®šå…ˆæ‰§è¡Œ**ã€‚
  - åŸå› ï¼šè¿™æ˜¯å› ä¸ºçº¿ç¨‹ä¼˜å…ˆçº§ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œç„¶è€Œï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿæ”¯æŒçš„çº¿ç¨‹ä¼˜å…ˆçº§å¹¶ä¸ç›¸åŒï¼Œä¸èƒ½å¾ˆå¥½çš„å’Œ Java ä¸­çº¿ç¨‹ä¼˜å…ˆçº§ä¸€ä¸€å¯¹åº”ã€‚
  - ç»“è®ºï¼šJava çº¿ç¨‹ä¼˜å…ˆçº§æ§åˆ¶å¹¶ä¸å¯é ã€‚

### ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å®ˆæŠ¤çº¿ç¨‹ï¼Ÿå¦‚ä½•åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹ï¼Ÿ

- ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹
  - å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯åœ¨åå°æ‰§è¡Œå¹¶ä¸”ä¸ä¼šé˜»æ­¢ JVM ç»ˆæ­¢çš„çº¿ç¨‹ã€‚
  - ä¸å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰ç›¸åçš„ï¼Œå«ç”¨æˆ·çº¿ç¨‹ï¼ˆUser Threadï¼‰ï¼Œä¹Ÿå°±æ˜¯éå®ˆæŠ¤çº¿ç¨‹ã€‚
- ä¸ºä»€ä¹ˆè¦ç”¨å®ˆæŠ¤çº¿ç¨‹
  - å®ˆæŠ¤çº¿ç¨‹çš„ä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œç”¨äºä¸ºç³»ç»Ÿä¸­çš„å…¶å®ƒå¯¹è±¡å’Œçº¿ç¨‹æä¾›æœåŠ¡ã€‚å…¸å‹çš„åº”ç”¨å°±æ˜¯åƒåœ¾å›æ”¶å™¨ã€‚
- å¦‚ä½•åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹
  - ä½¿ç”¨ thread.setDaemon(true) å¯ä»¥è®¾ç½® thread çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚
  - æ³¨æ„ç‚¹ï¼š
    - æ­£åœ¨è¿è¡Œçš„ç”¨æˆ·çº¿ç¨‹æ— æ³•è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ thread.setDaemon(true) å¿…é¡»åœ¨ thread.start() ä¹‹å‰è®¾ç½®ï¼Œå¦åˆ™ä¼šæŠ›å‡º llegalThreadStateException å¼‚å¸¸ï¼›
    - ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹åˆ›å»ºçš„å­çº¿ç¨‹ä¾ç„¶æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚
    - ä¸è¦è®¤ä¸ºæ‰€æœ‰çš„åº”ç”¨éƒ½å¯ä»¥åˆ†é…ç»™ Daemon æ¥è¿›è¡ŒæœåŠ¡ï¼Œæ¯”å¦‚è¯»å†™æ“ä½œæˆ–è€…è®¡ç®—é€»è¾‘ã€‚

> å‚è€ƒé˜…è¯»ï¼š[Java ä¸­å®ˆæŠ¤çº¿ç¨‹çš„æ€»ç»“](https://blog.csdn.net/shimiso/article/details/8964414)

### ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³• wait(), notify()å’Œ notifyAll()è¢«å®šä¹‰åœ¨ Object ç±»é‡Œï¼Ÿ

Java çš„æ¯ä¸ªå¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªé”(monitorï¼Œä¹Ÿå¯ä»¥æˆä¸ºç›‘è§†å™¨) å¹¶ä¸” wait()ï¼Œnotify()ç­‰æ–¹æ³•ç”¨äºç­‰å¾…å¯¹è±¡çš„é”æˆ–è€…é€šçŸ¥å…¶ä»–çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨å¯ç”¨ã€‚åœ¨ Java çš„çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰å¯ä¾›ä»»ä½•å¯¹è±¡ä½¿ç”¨çš„é”å’ŒåŒæ­¥å™¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™äº›æ–¹æ³•æ˜¯ Object ç±»çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ · Java çš„æ¯ä¸€ä¸ªç±»éƒ½æœ‰ç”¨äºçº¿ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ–¹æ³•

### ä¸ºä»€ä¹ˆ wait(), notify()å’Œ notifyAll()å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ï¼Ÿ

å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ wait()æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹å¿…é¡»æ‹¥æœ‰è¯¥å¯¹è±¡çš„é”ï¼Œæ¥ç€å®ƒå°±ä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„ notify()æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨å¯¹è±¡çš„ notify()æ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä»¥ä¾¿å…¶ä»–åœ¨ç­‰å¾…çš„çº¿ç¨‹å°±å¯ä»¥å¾—åˆ°è¿™ä¸ªå¯¹è±¡é”ã€‚ç”±äºæ‰€æœ‰çš„è¿™äº›æ–¹æ³•éƒ½éœ€è¦çº¿ç¨‹æŒæœ‰å¯¹è±¡çš„é”ï¼Œè¿™æ ·å°±åªèƒ½é€šè¿‡åŒæ­¥æ¥å®ç°ï¼Œæ‰€ä»¥ä»–ä»¬åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è¢«è°ƒç”¨ã€‚

> å‚è€ƒé˜…è¯»ï¼š[Java å¹¶å‘ç¼–ç¨‹ï¼švolatile å…³é”®å­—è§£æ](http://www.cnblogs.com/dolphin0520/p/3920373.html)

## èµ„æ–™

- [Java å¹¶å‘ç¼–ç¨‹å®æˆ˜](https://item.jd.com/10922250.html)
- [Java å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯](https://item.jd.com/11740734.html)
- https://stackoverflow.com/questions/27406200/visualvm-thread-states
- https://docs.oracle.com/javase/8/docs/api/index.html
- https://www.journaldev.com/1037/java-thread-wait-notify-and-notifyall-example
- http://www.importnew.com/14958.html
- https://blog.csdn.net/xiangwanpeng/article/details/54972952
- https://blog.csdn.net/shimiso/article/details/8964414
