# Java å¹¶å‘æ ¸å¿ƒæœºåˆ¶

> **ğŸ“¦ æœ¬æ–‡ä»¥åŠç¤ºä¾‹æºç å·²å½’æ¡£åœ¨ [javacore](https://github.com/dunwu/javacore)**
>
> Java å¯¹äºå¹¶å‘çš„æ”¯æŒä¸»è¦æ±‡èšåœ¨ `java.util.concurrent`ï¼Œå³ J.U.Cã€‚è€Œ J.U.C çš„æ ¸å¿ƒæ˜¯ `AQS`ã€‚

<!-- TOC depthFrom:2 depthTo:3 -->

- [ä¸€ã€J.U.C ç®€ä»‹](#ä¸€juc-ç®€ä»‹)
- [äºŒã€synchronized](#äºŒsynchronized)
  - [synchronized çš„ç”¨æ³•](#synchronized-çš„ç”¨æ³•)
  - [synchronized çš„åŸç†](#synchronized-çš„åŸç†)
  - [synchronized çš„ä¼˜åŒ–](#synchronized-çš„ä¼˜åŒ–)
- [ä¸‰ã€volatile](#ä¸‰volatile)
  - [volatile çš„è¦ç‚¹](#volatile-çš„è¦ç‚¹)
  - [volatile çš„ç”¨æ³•](#volatile-çš„ç”¨æ³•)
  - [volatile çš„åŸç†](#volatile-çš„åŸç†)
- [å››ã€CAS](#å››cas)
  - [CAS çš„è¦ç‚¹](#cas-çš„è¦ç‚¹)
  - [CAS çš„åŸç†](#cas-çš„åŸç†)
  - [CAS çš„åº”ç”¨](#cas-çš„åº”ç”¨)
  - [CAS çš„é—®é¢˜](#cas-çš„é—®é¢˜)
- [äº”ã€ThreadLocal](#äº”threadlocal)
  - [ThreadLocal çš„ç”¨æ³•](#threadlocal-çš„ç”¨æ³•)
  - [ThreadLocal çš„åŸç†](#threadlocal-çš„åŸç†)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

<!-- /TOC -->

## ä¸€ã€J.U.C ç®€ä»‹

Java çš„ `java.util.concurrent` åŒ…ï¼ˆç®€ç§° J.U.Cï¼‰ä¸­æä¾›äº†å¤§é‡å¹¶å‘å·¥å…·ç±»ï¼Œæ˜¯ Java å¹¶å‘èƒ½åŠ›çš„ä¸»è¦ä½“ç°ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯å…¨éƒ¨ï¼Œæœ‰éƒ¨åˆ†å¹¶å‘èƒ½åŠ›çš„æ”¯æŒåœ¨å…¶ä»–åŒ…ä¸­ï¼‰ã€‚ä»åŠŸèƒ½ä¸Šï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºï¼š

- åŸå­ç±» - å¦‚ï¼š`AtomicInteger`ã€`AtomicIntegerArray`ã€`AtomicReference`ã€`AtomicStampedReference` ç­‰ã€‚
- é” - å¦‚ï¼š`ReentrantLock`ã€`ReentrantReadWriteLock` ç­‰ã€‚
- å¹¶å‘å®¹å™¨ - å¦‚ï¼š`ConcurrentHashMap`ã€`CopyOnWriteArrayList`ã€`CopyOnWriteArraySet` ç­‰ã€‚
- é˜»å¡é˜Ÿåˆ— - å¦‚ï¼š`ArrayBlockingQueue`ã€`LinkedBlockingQueue` ç­‰ã€‚
- éé˜»å¡é˜Ÿåˆ— - å¦‚ï¼š `ConcurrentLinkedQueue` ã€`LinkedTransferQueue` ç­‰ã€‚
- `Executor` æ¡†æ¶ï¼ˆçº¿ç¨‹æ± ï¼‰- å¦‚ï¼š`ThreadPoolExecutor`ã€`Executors` ç­‰ã€‚

æˆ‘ä¸ªäººç†è§£ï¼ŒJava å¹¶å‘æ¡†æ¶å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å±‚æ¬¡ã€‚

![](http://dunwu.test.upcdn.net/cs/java/javacore/concurrent/java-concurrent-basic-mechanism.png)

ç”± Java å¹¶å‘æ¡†æ¶å›¾ä¸éš¾çœ‹å‡ºï¼ŒJ.U.C åŒ…ä¸­çš„å·¥å…·ç±»æ˜¯åŸºäº `synchronized`ã€`volatile`ã€`CAS`ã€`ThreadLocal` è¿™æ ·çš„å¹¶å‘æ ¸å¿ƒæœºåˆ¶æ‰“é€ çš„ã€‚æ‰€ä»¥ï¼Œè¦æƒ³æ·±å…¥ç†è§£ J.U.C å·¥å…·ç±»çš„ç‰¹æ€§ã€ä¸ºä»€ä¹ˆå…·æœ‰è¿™æ ·é‚£æ ·çš„ç‰¹æ€§ï¼Œå°±å¿…é¡»å…ˆç†è§£è¿™äº›æ ¸å¿ƒæœºåˆ¶ã€‚

## äºŒã€synchronized

> `synchronized` æ˜¯ Java ä¸­çš„å…³é”®å­—ï¼Œæ˜¯ **åˆ©ç”¨é”çš„æœºåˆ¶æ¥å®ç°äº’æ–¥åŒæ­¥çš„**ã€‚
>
> **`synchronized` å¯ä»¥ä¿è¯åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªä»£ç å—**ã€‚
>
> å¦‚æœä¸éœ€è¦ `Lock` ã€`ReadWriteLock` æ‰€æä¾›çš„é«˜çº§åŒæ­¥ç‰¹æ€§ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ `synchronized` ï¼Œç†ç”±å¦‚ä¸‹ï¼š
>
> - Java 1.6 ä»¥åï¼Œ`synchronized` åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå…¶æ€§èƒ½å·²ç»ä¸ `Lock` ã€`ReadWriteLock` åŸºæœ¬ä¸ŠæŒå¹³ã€‚ä»è¶‹åŠ¿æ¥çœ‹ï¼ŒJava æœªæ¥ä»å°†ç»§ç»­ä¼˜åŒ– `synchronized` ï¼Œè€Œä¸æ˜¯ `ReentrantLock` ã€‚
> - `ReentrantLock` æ˜¯ Oracle JDK çš„ APIï¼Œåœ¨å…¶ä»–ç‰ˆæœ¬çš„ JDK ä¸­ä¸ä¸€å®šæ”¯æŒï¼›è€Œ `synchronized` æ˜¯ JVM çš„å†…ç½®ç‰¹æ€§ï¼Œæ‰€æœ‰ JDK ç‰ˆæœ¬éƒ½æä¾›æ”¯æŒã€‚

### synchronized çš„ç”¨æ³•

`synchronized` æœ‰ 3 ç§åº”ç”¨æ–¹å¼ï¼š

- **åŒæ­¥å®ä¾‹æ–¹æ³•** - å¯¹äºæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡
- **åŒæ­¥é™æ€æ–¹æ³•** - å¯¹äºé™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„ `Class` å¯¹è±¡
- **åŒæ­¥ä»£ç å—** - å¯¹äºåŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯ `synchonized` æ‹¬å·é‡Œé…ç½®çš„å¯¹è±¡

> è¯´æ˜ï¼š
>
> ç±»ä¼¼ `Vector`ã€`Hashtable` è¿™ç±»åŒæ­¥ç±»ï¼Œå°±æ˜¯ä½¿ç”¨ `synchonized` ä¿®é¥°å…¶é‡è¦æ–¹æ³•ï¼Œæ¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚
>
> äº‹å®ä¸Šï¼Œè¿™ç±»åŒæ­¥å®¹å™¨ä¹Ÿéç»å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼Œå½“æ‰§è¡Œè¿­ä»£å™¨éå†ï¼Œæ ¹æ®æ¡ä»¶åˆ é™¤å…ƒç´ è¿™ç§åœºæ™¯ä¸‹ï¼Œå°±å¯èƒ½å‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µã€‚æ­¤å¤–ï¼ŒJava 1.6 é’ˆå¯¹ `synchonized` è¿›è¡Œä¼˜åŒ–å‰ï¼Œç”±äºé˜»å¡ï¼Œå…¶æ€§èƒ½ä¸é«˜ã€‚
>
> ç»¼ä¸Šï¼Œè¿™ç±»åŒæ­¥å®¹å™¨ï¼Œåœ¨ç°ä»£ Java ç¨‹åºä¸­ï¼Œå·²ç»æ¸æ¸ä¸ç”¨äº†ã€‚

#### åŒæ­¥å®ä¾‹æ–¹æ³•

âŒ é”™è¯¯ç¤ºä¾‹ - æœªåŒæ­¥çš„ç¤ºä¾‹

```java
public class NoSynchronizedDemo implements Runnable {

    public static final int MAX = 100000;

    private static int count = 0;

    public static void main(String[] args) throws InterruptedException {
        NoSynchronizedDemo instance = new NoSynchronizedDemo();
        Thread t1 = new Thread(instance);
        Thread t2 = new Thread(instance);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println(count);
    }

    @Override
    public void run() {
        for (int i = 0; i < MAX; i++) {
            increase();
        }
    }

    public void increase() {
        count++;
    }

}
// è¾“å‡ºç»“æœ: å°äº 200000 çš„éšæœºæ•°å­—
```

Java å®ä¾‹æ–¹æ³•åŒæ­¥æ˜¯åŒæ­¥åœ¨æ‹¥æœ‰è¯¥æ–¹æ³•çš„å¯¹è±¡ä¸Šã€‚è¿™æ ·ï¼Œæ¯ä¸ªå®ä¾‹å…¶æ–¹æ³•åŒæ­¥éƒ½åŒæ­¥åœ¨ä¸åŒçš„å¯¹è±¡ä¸Šï¼Œå³è¯¥æ–¹æ³•æ‰€å±çš„å®ä¾‹ã€‚åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿåœ¨å®ä¾‹æ–¹æ³•åŒæ­¥å—ä¸­è¿è¡Œã€‚å¦‚æœæœ‰å¤šä¸ªå®ä¾‹å­˜åœ¨ï¼Œé‚£ä¹ˆä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡å¯ä»¥åœ¨ä¸€ä¸ªå®ä¾‹åŒæ­¥å—ä¸­æ‰§è¡Œæ“ä½œã€‚ä¸€ä¸ªå®ä¾‹ä¸€ä¸ªçº¿ç¨‹ã€‚

```java
public class SynchronizedDemo implements Runnable {

    private static final int MAX = 100000;

    private static int count = 0;

    public static void main(String[] args) throws InterruptedException {
        SynchronizedDemo instance = new SynchronizedDemo();
        Thread t1 = new Thread(instance);
        Thread t2 = new Thread(instance);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println(count);
    }

    @Override
    public void run() {
        for (int i = 0; i < MAX; i++) {
            increase();
        }
    }

    /**
     * synchronized ä¿®é¥°æ™®é€šæ–¹æ³•
     */
    public synchronized void increase() {
        count++;
    }

}
```

#### åŒæ­¥é™æ€æ–¹æ³•

é™æ€æ–¹æ³•çš„åŒæ­¥æ˜¯æŒ‡åŒæ­¥åœ¨è¯¥æ–¹æ³•æ‰€åœ¨çš„ç±»å¯¹è±¡ä¸Šã€‚å› ä¸ºåœ¨ JVM ä¸­ä¸€ä¸ªç±»åªèƒ½å¯¹åº”ä¸€ä¸ªç±»å¯¹è±¡ï¼Œæ‰€ä»¥åŒæ—¶åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒä¸€ä¸ªç±»ä¸­çš„é™æ€åŒæ­¥æ–¹æ³•ã€‚

å¯¹äºä¸åŒç±»ä¸­çš„é™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œæ¯ä¸ªç±»ä¸­çš„é™æ€åŒæ­¥æ–¹æ³•è€Œæ— éœ€ç­‰å¾…ã€‚ä¸ç®¡ç±»ä¸­çš„é‚£ä¸ªé™æ€åŒæ­¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¸€ä¸ªç±»åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚

```java
public class SynchronizedDemo2 implements Runnable {

    private static final int MAX = 100000;

    private static int count = 0;

    public static void main(String[] args) throws InterruptedException {
        SynchronizedDemo2 instance = new SynchronizedDemo2();
        Thread t1 = new Thread(instance);
        Thread t2 = new Thread(instance);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println(count);
    }

    @Override
    public void run() {
        for (int i = 0; i < MAX; i++) {
            increase();
        }
    }

    /**
     * synchronized ä¿®é¥°é™æ€æ–¹æ³•
     */
    public synchronized static void increase() {
        count++;
    }

}
```

#### åŒæ­¥ä»£ç å—

æœ‰æ—¶ä½ ä¸éœ€è¦åŒæ­¥æ•´ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯åŒæ­¥æ–¹æ³•ä¸­çš„ä¸€éƒ¨åˆ†ã€‚Java å¯ä»¥å¯¹æ–¹æ³•çš„ä¸€éƒ¨åˆ†è¿›è¡ŒåŒæ­¥ã€‚

æ³¨æ„ Java åŒæ­¥å—æ„é€ å™¨ç”¨æ‹¬å·å°†å¯¹è±¡æ‹¬èµ·æ¥ã€‚åœ¨ä¸Šä¾‹ä¸­ï¼Œä½¿ç”¨äº† `this`ï¼Œå³ä¸ºè°ƒç”¨ add æ–¹æ³•çš„å®ä¾‹æœ¬èº«ã€‚åœ¨åŒæ­¥æ„é€ å™¨ä¸­ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„å¯¹è±¡å«åšç›‘è§†å™¨å¯¹è±¡ã€‚ä¸Šè¿°ä»£ç ä½¿ç”¨ç›‘è§†å™¨å¯¹è±¡åŒæ­¥ï¼ŒåŒæ­¥å®ä¾‹æ–¹æ³•ä½¿ç”¨è°ƒç”¨æ–¹æ³•æœ¬èº«çš„å®ä¾‹ä½œä¸ºç›‘è§†å™¨å¯¹è±¡ã€‚

ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿåœ¨åŒæ­¥äºåŒä¸€ä¸ªç›‘è§†å™¨å¯¹è±¡çš„ Java æ–¹æ³•å†…æ‰§è¡Œã€‚

```java
public class SynchronizedDemo3 implements Runnable {

    private static final int MAX = 100000;

    private static int count = 0;

    public static void main(String[] args) throws InterruptedException {
        SynchronizedDemo3 instance = new SynchronizedDemo3();
        Thread t1 = new Thread(instance);
        Thread t2 = new Thread(instance);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println(count);
    }

    @Override
    public void run() {
        for (int i = 0; i < MAX; i++) {
            increase();
        }
    }

    /**
     * synchronized ä¿®é¥°ä»£ç å—
     */
    public static void increase() {
        synchronized (SynchronizedDemo3.class) {
            count++;
        }
    }

}
```

### synchronized çš„åŸç†

`synchronized` ç»è¿‡ç¼–è¯‘åï¼Œä¼šåœ¨åŒæ­¥å—çš„å‰ååˆ†åˆ«å½¢æˆ `monitorenter` å’Œ `monitorexit` è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½éœ€è¦ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å‚æ•°æ¥æŒ‡æ˜è¦é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚å¦‚æœ `synchronized` æ˜ç¡®åˆ¶å®šäº†å¯¹è±¡å‚æ•°ï¼Œé‚£å°±æ˜¯è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼›å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œé‚£å°±æ ¹æ® `synchronized` ä¿®é¥°çš„æ˜¯å®ä¾‹æ–¹æ³•è¿˜æ˜¯é™æ€æ–¹æ³•ï¼Œå»å¯¹å¯¹åº”çš„å¯¹è±¡å®ä¾‹æˆ– Class å¯¹è±¡æ¥ä½œä¸ºé”å¯¹è±¡ã€‚

`synchronized` åŒæ­¥å—å¯¹åŒä¸€çº¿ç¨‹æ¥è¯´æ˜¯å¯é‡å…¥çš„ï¼Œä¸ä¼šå‡ºç°é”æ­»é—®é¢˜ã€‚

`synchronized` åŒæ­¥å—æ˜¯äº’æ–¥çš„ï¼Œå³å·²è¿›å…¥çš„çº¿ç¨‹æ‰§è¡Œå®Œæˆå‰ï¼Œä¼šé˜»å¡å…¶ä»–è¯•å›¾è¿›å…¥çš„çº¿ç¨‹ã€‚

#### é”çš„æœºåˆ¶

é”å…·å¤‡ä»¥ä¸‹ä¸¤ç§ç‰¹æ€§ï¼š

- **äº’æ–¥æ€§**ï¼šå³åœ¨åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰æŸä¸ªå¯¹è±¡é”ï¼Œé€šè¿‡è¿™ç§ç‰¹æ€§æ¥å®ç°å¤šçº¿ç¨‹ä¸­çš„åè°ƒæœºåˆ¶ï¼Œè¿™æ ·åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹éœ€åŒæ­¥çš„ä»£ç å—(å¤åˆæ“ä½œ)è¿›è¡Œè®¿é—®ã€‚äº’æ–¥æ€§æˆ‘ä»¬ä¹Ÿå¾€å¾€ç§°ä¸ºæ“ä½œçš„åŸå­æ€§ã€‚
- **å¯è§æ€§**ï¼šå¿…é¡»ç¡®ä¿åœ¨é”è¢«é‡Šæ”¾ä¹‹å‰ï¼Œå¯¹å…±äº«å˜é‡æ‰€åšçš„ä¿®æ”¹ï¼Œå¯¹äºéšåè·å¾—è¯¥é”çš„å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„ï¼ˆå³åœ¨è·å¾—é”æ—¶åº”è·å¾—æœ€æ–°å…±äº«å˜é‡çš„å€¼ï¼‰ï¼Œå¦åˆ™å¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½æ˜¯åœ¨æœ¬åœ°ç¼“å­˜çš„æŸä¸ªå‰¯æœ¬ä¸Šç»§ç»­æ“ä½œä»è€Œå¼•èµ·ä¸ä¸€è‡´ã€‚

#### é”ç±»å‹

- **å¯¹è±¡é”** - åœ¨ Java ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª `monitor` å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å…¶å®å°±æ˜¯ Java å¯¹è±¡çš„é”ï¼Œé€šå¸¸ä¼šè¢«ç§°ä¸ºâ€œå†…ç½®é”â€æˆ–â€œå¯¹è±¡é”â€ã€‚ç±»çš„å¯¹è±¡å¯ä»¥æœ‰å¤šä¸ªï¼Œæ‰€ä»¥æ¯ä¸ªå¯¹è±¡æœ‰å…¶ç‹¬ç«‹çš„å¯¹è±¡é”ï¼Œäº’ä¸å¹²æ‰°ã€‚
- **ç±»é”** - åœ¨ Java ä¸­ï¼Œé’ˆå¯¹æ¯ä¸ªç±»ä¹Ÿæœ‰ä¸€ä¸ªé”ï¼Œå¯ä»¥ç§°ä¸ºâ€œç±»é”â€ï¼Œç±»é”å®é™…ä¸Šæ˜¯é€šè¿‡å¯¹è±¡é”å®ç°çš„ï¼Œå³ç±»çš„ Class å¯¹è±¡é”ã€‚æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ª Class å¯¹è±¡ï¼Œæ‰€ä»¥æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªç±»é”ã€‚

### synchronized çš„ä¼˜åŒ–

> Java 1.6 ä»¥åï¼Œ`synchronized` åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå…¶æ€§èƒ½å·²ç»ä¸ `Lock` ã€`ReadWriteLock` åŸºæœ¬ä¸ŠæŒå¹³ã€‚

#### è‡ªæ—‹é”

äº’æ–¥åŒæ­¥è¿›å…¥é˜»å¡çŠ¶æ€çš„å¼€é”€éƒ½å¾ˆå¤§ï¼Œåº”è¯¥å°½é‡é¿å…ã€‚åœ¨è®¸å¤šåº”ç”¨ä¸­ï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ã€‚è‡ªæ—‹é”çš„æ€æƒ³æ˜¯è®©ä¸€ä¸ªçº¿ç¨‹åœ¨è¯·æ±‚ä¸€ä¸ªå…±äº«æ•°æ®çš„é”æ—¶æ‰§è¡Œå¿™å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…èƒ½è·å¾—é”ï¼Œå°±å¯ä»¥é¿å…è¿›å…¥é˜»å¡çŠ¶æ€ã€‚

è‡ªæ—‹é”è™½ç„¶èƒ½é¿å…è¿›å…¥é˜»å¡çŠ¶æ€ä»è€Œå‡å°‘å¼€é”€ï¼Œä½†æ˜¯å®ƒéœ€è¦è¿›è¡Œå¿™å¾ªç¯æ“ä½œå ç”¨ CPU æ—¶é—´ï¼Œå®ƒåªé€‚ç”¨äºå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€å¾ˆçŸ­çš„åœºæ™¯ã€‚

åœ¨ Java 1.6 ä¸­å¼•å…¥äº†è‡ªé€‚åº”çš„è‡ªæ—‹é”ã€‚è‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ¬¡æ•°ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ¬¡æ•°åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚

#### é”æ¶ˆé™¤

**é”æ¶ˆé™¤æ˜¯æŒ‡å¯¹äºè¢«æ£€æµ‹å‡ºä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„å…±äº«æ•°æ®çš„é”è¿›è¡Œæ¶ˆé™¤**ã€‚

é”æ¶ˆé™¤ä¸»è¦æ˜¯é€šè¿‡é€ƒé€¸åˆ†ææ¥æ”¯æŒï¼Œå¦‚æœå †ä¸Šçš„å…±äº«æ•°æ®ä¸å¯èƒ½é€ƒé€¸å‡ºå»è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå®ƒä»¬å½“æˆç§æœ‰æ•°æ®å¯¹å¾…ï¼Œä¹Ÿå°±å¯ä»¥å°†å®ƒä»¬çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚

å¯¹äºä¸€äº›çœ‹èµ·æ¥æ²¡æœ‰åŠ é”çš„ä»£ç ï¼Œå…¶å®éšå¼çš„åŠ äº†å¾ˆå¤šé”ã€‚ä¾‹å¦‚ä¸‹é¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä»£ç å°±éšå¼åŠ äº†é”ï¼š

```java
public static String concatString(String s1, String s2, String s3) {
    return s1 + s2 + s3;
}
```

String æ˜¯ä¸€ä¸ªä¸å¯å˜çš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šå¯¹ String çš„æ‹¼æ¥è‡ªåŠ¨ä¼˜åŒ–ã€‚åœ¨ Java 1.5 ä¹‹å‰ï¼Œä¼šè½¬åŒ–ä¸º StringBuffer å¯¹è±¡çš„è¿ç»­ append() æ“ä½œï¼š

```java
public static String concatString(String s1, String s2, String s3) {
    StringBuffer sb = new StringBuffer();
    sb.append(s1);
    sb.append(s2);
    sb.append(s3);
    return sb.toString();
}
```

æ¯ä¸ª append() æ–¹æ³•ä¸­éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å—ã€‚è™šæ‹Ÿæœºè§‚å¯Ÿå˜é‡ sbï¼Œå¾ˆå¿«å°±ä¼šå‘ç°å®ƒçš„åŠ¨æ€ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨ concatString() æ–¹æ³•å†…éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsb çš„æ‰€æœ‰å¼•ç”¨æ°¸è¿œä¸ä¼šé€ƒé€¸åˆ° concatString() æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®åˆ°å®ƒï¼Œå› æ­¤å¯ä»¥è¿›è¡Œæ¶ˆé™¤ã€‚

#### é”ç²—åŒ–

å¦‚æœ**ä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”**ï¼Œé¢‘ç¹çš„åŠ é”æ“ä½œå°±ä¼šå¯¼è‡´æ€§èƒ½æŸè€—ã€‚

ä¸Šä¸€èŠ‚çš„ç¤ºä¾‹ä»£ç ä¸­è¿ç»­çš„ append() æ–¹æ³•å°±å±äºè¿™ç±»æƒ…å†µã€‚å¦‚æœ**è™šæ‹Ÿæœºæ¢æµ‹åˆ°ç”±è¿™æ ·çš„ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨**ã€‚å¯¹äºä¸Šä¸€èŠ‚çš„ç¤ºä¾‹ä»£ç å°±æ˜¯æ‰©å±•åˆ°ç¬¬ä¸€ä¸ª append() æ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ª append() æ“ä½œä¹‹åï¼Œè¿™æ ·åªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚

#### è½»é‡çº§é”

Java 1.6 å¼•å…¥äº†åå‘é”å’Œè½»é‡çº§é”ï¼Œä»è€Œè®©é”æ‹¥æœ‰äº†å››ä¸ªçŠ¶æ€ï¼š

- **æ— é”çŠ¶æ€ï¼ˆunlockedï¼‰**
- **åå‘é”çŠ¶æ€ï¼ˆbiasbleï¼‰**
- **è½»é‡çº§é”çŠ¶æ€ï¼ˆlightweight lockedï¼‰**
- **é‡é‡çº§é”çŠ¶æ€ï¼ˆinflatedï¼‰**

**è½»é‡çº§é”**æ˜¯ç›¸å¯¹äºä¼ ç»Ÿçš„é‡é‡çº§é”è€Œè¨€ï¼Œå®ƒ **ä½¿ç”¨ CAS æ“ä½œæ¥é¿å…é‡é‡çº§é”ä½¿ç”¨äº’æ–¥é‡çš„å¼€é”€**ã€‚å¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„ï¼Œå› æ­¤ä¹Ÿå°±ä¸éœ€è¦éƒ½ä½¿ç”¨äº’æ–¥é‡è¿›è¡ŒåŒæ­¥ï¼Œå¯ä»¥å…ˆé‡‡ç”¨ CAS æ“ä½œè¿›è¡ŒåŒæ­¥ï¼Œå¦‚æœ CAS å¤±è´¥äº†å†æ”¹ç”¨äº’æ–¥é‡è¿›è¡ŒåŒæ­¥ã€‚

å½“å°è¯•è·å–ä¸€ä¸ªé”å¯¹è±¡æ—¶ï¼Œå¦‚æœé”å¯¹è±¡æ ‡è®°ä¸º 0 01ï¼Œè¯´æ˜é”å¯¹è±¡çš„é”æœªé”å®šï¼ˆunlockedï¼‰çŠ¶æ€ã€‚æ­¤æ—¶è™šæ‹Ÿæœºåœ¨å½“å‰çº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»º Lock Recordï¼Œç„¶åä½¿ç”¨ CAS æ“ä½œå°†å¯¹è±¡çš„ Mark Word æ›´æ–°ä¸º Lock Record æŒ‡é’ˆã€‚å¦‚æœ CAS æ“ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±è·å–äº†è¯¥å¯¹è±¡ä¸Šçš„é”ï¼Œå¹¶ä¸”å¯¹è±¡çš„ Mark Word çš„é”æ ‡è®°å˜ä¸º 00ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡å¤„äºè½»é‡çº§é”çŠ¶æ€ã€‚

#### åå‘é”

åå‘é”çš„æ€æƒ³æ˜¯åå‘äº**è®©ç¬¬ä¸€ä¸ªè·å–é”å¯¹è±¡çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹åœ¨ä¹‹åè·å–è¯¥é”å°±ä¸å†éœ€è¦è¿›è¡ŒåŒæ­¥æ“ä½œï¼Œç”šè‡³è¿ CAS æ“ä½œä¹Ÿä¸å†éœ€è¦**ã€‚

## ä¸‰ã€volatile

### volatile çš„è¦ç‚¹

volatile æ˜¯è½»é‡çº§çš„ synchronizedï¼Œå®ƒåœ¨å¤šå¤„ç†å™¨å¼€å‘ä¸­ä¿è¯äº†å…±äº«å˜é‡çš„â€œå¯è§æ€§â€ã€‚

å¯è§æ€§çš„æ„æ€æ˜¯å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ä¸€ä¸ªå…±äº«å˜é‡æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½è¯»åˆ°è¿™ä¸ªä¿®æ”¹çš„å€¼ã€‚

ä¸€æ—¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆç±»çš„æˆå‘˜å˜é‡ã€ç±»çš„é™æ€æˆå‘˜å˜é‡ï¼‰è¢« volatile ä¿®é¥°ä¹‹åï¼Œé‚£ä¹ˆå°±å…·å¤‡äº†ä¸¤å±‚è¯­ä¹‰ï¼š

1. ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚
2. ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚

å¦‚æœä¸€ä¸ªå­—æ®µè¢«å£°æ˜æˆ volatileï¼ŒJava çº¿ç¨‹å†…å­˜æ¨¡å‹ç¡®ä¿æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°è¿™ä¸ªå˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚

### volatile çš„ç”¨æ³•

å¦‚æœ `volatile` å˜é‡ä¿®é¥°ç¬¦ä½¿ç”¨æ°å½“çš„è¯ï¼Œå®ƒæ¯” `synchronized` çš„ä½¿ç”¨å’Œæ‰§è¡Œæˆæœ¬æ›´ä½ï¼Œå› ä¸ºå®ƒä¸ä¼šå¼•èµ·çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å’Œè°ƒåº¦ã€‚ä½†æ˜¯ï¼Œ`volatile` æ— æ³•æ›¿ä»£ `synchronized` ï¼Œå› ä¸º `volatile` æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚

é€šå¸¸æ¥è¯´ï¼Œ**ä½¿ç”¨ `volatile` å¿…é¡»å…·å¤‡ä»¥ä¸‹ 2 ä¸ªæ¡ä»¶**ï¼š

- å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–äºå½“å‰å€¼
- è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­ 

ç¤ºä¾‹ï¼šçŠ¶æ€æ ‡è®°é‡

```java
volatile boolean flag = false;

while(!flag) {
    doSomething();
}

public void setFlag() {
    flag = true;
}
```

ç¤ºä¾‹ï¼šåŒé‡é”å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹ç±»

```java
class Singleton {
    private volatile static Singleton instance = null;

    private Singleton() {}

    public static Singleton getInstance() {
        if(instance==null) {
            synchronized (Singleton.class) {
                if(instance==null)
                    instance = new Singleton();
            }
        }
        return instance;
    }
}
```

### volatile çš„åŸç†

è§‚å¯ŸåŠ å…¥ volatile å…³é”®å­—å’Œæ²¡æœ‰åŠ å…¥ volatile å…³é”®å­—æ—¶æ‰€ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å‘ç°ï¼Œ**åŠ å…¥ `volatile` å…³é”®å­—æ—¶ï¼Œä¼šå¤šå‡ºä¸€ä¸ª `lock` å‰ç¼€æŒ‡ä»¤**ã€‚

**`lock` å‰ç¼€æŒ‡ä»¤å®é™…ä¸Šç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœ**ï¼ˆä¹Ÿæˆå†…å­˜æ …æ ï¼‰ï¼Œå†…å­˜å±éšœä¼šæä¾› 3 ä¸ªåŠŸèƒ½ï¼š

- å®ƒç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ä¸ä¼šæŠŠå…¶åé¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼Œä¹Ÿä¸ä¼šæŠŠå‰é¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœçš„åé¢ï¼›å³åœ¨æ‰§è¡Œåˆ°å†…å­˜å±éšœè¿™å¥æŒ‡ä»¤æ—¶ï¼Œåœ¨å®ƒå‰é¢çš„æ“ä½œå·²ç»å…¨éƒ¨å®Œæˆï¼›
- å®ƒä¼šå¼ºåˆ¶å°†å¯¹ç¼“å­˜çš„ä¿®æ”¹æ“ä½œç«‹å³å†™å…¥ä¸»å­˜ï¼›
- å¦‚æœæ˜¯å†™æ“ä½œï¼Œå®ƒä¼šå¯¼è‡´å…¶ä»– CPU ä¸­å¯¹åº”çš„ç¼“å­˜è¡Œæ— æ•ˆã€‚

## å››ã€CAS

### CAS çš„è¦ç‚¹

äº’æ–¥åŒæ­¥æ˜¯æœ€å¸¸è§çš„å¹¶å‘æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µã€‚

**äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜**ï¼Œå› æ­¤äº’æ–¥åŒæ­¥ä¹Ÿè¢«ç§°ä¸ºé˜»å¡åŒæ­¥ã€‚äº’æ–¥åŒæ­¥å±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜ã€‚æ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”ï¼ˆè¿™é‡Œè®¨è®ºçš„æ˜¯æ¦‚å¿µæ¨¡å‹ï¼Œå®é™…ä¸Šè™šæ‹Ÿæœºä¼šä¼˜åŒ–æ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„åŠ é”ï¼‰ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦å”¤é†’ç­‰æ“ä½œã€‚

éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥ï¼šå…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼Œå¦åˆ™é‡‡å–è¡¥å¿æªæ–½ï¼ˆä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰ã€‚è¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„è®¸å¤šå®ç°éƒ½ä¸éœ€è¦å°†çº¿ç¨‹é˜»å¡ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚

ä¸ºä»€ä¹ˆè¯´ä¹è§‚é”éœ€è¦ **ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•** æ‰èƒ½è¿›è¡Œï¼Ÿå› ä¸ºéœ€è¦æ“ä½œå’Œå†²çªæ£€æµ‹è¿™ä¸¤ä¸ªæ­¥éª¤å…·å¤‡åŸå­æ€§ã€‚è€Œè¿™ç‚¹æ˜¯ç”±ç¡¬ä»¶æ¥å®Œæˆï¼Œå¦‚æœå†ä½¿ç”¨äº’æ–¥åŒæ­¥æ¥ä¿è¯å°±å¤±å»æ„ä¹‰äº†ã€‚ç¡¬ä»¶æ”¯æŒçš„åŸå­æ€§æ“ä½œæœ€å…¸å‹çš„æ˜¯ï¼šCASã€‚

**CASï¼ˆCompare and Swapï¼‰**ï¼Œå­—é¢æ„æ€ä¸º**æ¯”è¾ƒå¹¶äº¤æ¢**ã€‚CAS æœ‰ 3 ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šå†…å­˜å€¼ Vï¼Œæ—§çš„é¢„æœŸå€¼ Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼ Bã€‚å½“ä¸”ä»…å½“é¢„æœŸå€¼ A å’Œå†…å­˜å€¼ V ç›¸åŒæ—¶ï¼Œå°†å†…å­˜å€¼ V ä¿®æ”¹ä¸º Bï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚

### CAS çš„åŸç†

Java æ˜¯å¦‚ä½•å®ç° CAS ?

Java ä¸»è¦åˆ©ç”¨ `Unsafe` è¿™ä¸ªç±»æä¾›çš„ CAS æ“ä½œã€‚

`Unsafe` çš„ CAS ä¾èµ–çš„æ˜¯ JV M é’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿå®ç°çš„ `Atomic::cmpxchg` æŒ‡ä»¤ã€‚

`Atomic::cmpxchg` çš„å®ç°ä½¿ç”¨äº†æ±‡ç¼–çš„ CAS æ“ä½œï¼Œå¹¶ä½¿ç”¨ CPU æä¾›çš„ `lock` ä¿¡å·ä¿è¯å…¶åŸå­æ€§ã€‚

### CAS çš„åº”ç”¨

#### åŸå­ç±»

> åŸå­ç±»æ˜¯ CAS åœ¨ Java ä¸­æœ€å…¸å‹çš„åº”ç”¨ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå¸¸è§çš„ä»£ç ç‰‡æ®µã€‚

```Java
if(a==b) {
    a++;
}
```

å¦‚æœ `a++` æ‰§è¡Œå‰ï¼Œ a çš„å€¼è¢«ä¿®æ”¹äº†æ€ä¹ˆåŠï¼Ÿè¿˜èƒ½å¾—åˆ°é¢„æœŸå€¼å—ï¼Ÿå‡ºç°è¯¥é—®é¢˜çš„åŸå› æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä»¥ä¸Šä»£ç ç‰‡æ®µä¸æ˜¯åŸå­æ“ä½œï¼Œéšæ—¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰€ç¯¡æ”¹ã€‚

è§£å†³è¿™ç§é—®é¢˜çš„æœ€ç»å…¸æ–¹å¼æ˜¯åº”ç”¨åŸå­ç±»çš„ `incrementAndGet` æ–¹æ³•ã€‚

```Java
public class AtomicIntegerDemo {

    public static void main(String[] args) throws InterruptedException {
        ExecutorService executorService = Executors.newFixedThreadPool(3);
        final AtomicInteger count = new AtomicInteger(0);
        for (int i = 0; i < 10; i++) {
            executorService.execute(new Runnable() {
                @Override
                public void run() {
                    count.incrementAndGet();
                }
            });
        }

        executorService.shutdown();
        executorService.awaitTermination(3, TimeUnit.SECONDS);
        System.out.println("Final Count is : " + count.get());
    }

}
```

J.U.C åŒ…ä¸­æä¾›äº† `AtomicBoolean`ã€`AtomicInteger`ã€`AtomicLong` åˆ†åˆ«é’ˆå¯¹ `Boolean`ã€`Integer`ã€`Long` æ‰§è¡ŒåŸå­æ“ä½œï¼Œæ“ä½œå’Œä¸Šé¢çš„ç¤ºä¾‹å¤§ä½“ç›¸ä¼¼ï¼Œä¸åšèµ˜è¿°ã€‚

#### è‡ªæ—‹é”

åˆ©ç”¨åŸå­ç±»ï¼ˆæœ¬è´¨ä¸Šæ˜¯ CASï¼‰ï¼Œå¯ä»¥å®ç°è‡ªæ—‹é”ã€‚

æ‰€è°“è‡ªæ—‹é”ï¼Œæ˜¯æŒ‡çº¿ç¨‹åå¤æ£€æŸ¥é”å˜é‡æ˜¯å¦å¯ç”¨ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ç”±äºçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä¿æŒæ‰§è¡Œï¼Œå› æ­¤æ˜¯ä¸€ç§å¿™ç­‰å¾…ã€‚ä¸€æ—¦è·å–äº†è‡ªæ—‹é”ï¼Œçº¿ç¨‹ä¼šä¸€ç›´ä¿æŒè¯¥é”ï¼Œç›´è‡³æ˜¾å¼é‡Šæ”¾è‡ªæ—‹é”ã€‚

ç¤ºä¾‹ï¼šéçº¿ç¨‹å®‰å…¨ç¤ºä¾‹

```java
public class AtomicReferenceDemo {

    private static int ticket = 10;

    public static void main(String[] args) {
        ExecutorService executorService = Executors.newFixedThreadPool(3);
        for (int i = 0; i < 5; i++) {
            executorService.execute(new MyThread());
        }
        executorService.shutdown();
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            while (ticket > 0) {
                System.out.println(Thread.currentThread().getName() + " å–å‡ºäº†ç¬¬ " + ticket + " å¼ ç¥¨");
                ticket--;
            }
        }

    }

}
```

è¾“å‡ºç»“æœï¼š

```
pool-1-thread-2 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 8 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 9 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 6 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 7 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 4 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 5 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 2 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 3 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 1 å¼ ç¥¨
```

å¾ˆæ˜æ˜¾ï¼Œå‡ºç°äº†é‡å¤å”®ç¥¨çš„æƒ…å†µã€‚

ç¤ºä¾‹ï¼šä½¿ç”¨è‡ªæ—‹é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨

å¯ä»¥é€šè¿‡è‡ªæ—‹é”è¿™ç§éé˜»å¡åŒæ­¥æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸‹é¢ä½¿ç”¨ `AtomicReference` æ¥å®ç°ä¸€ä¸ªè‡ªæ—‹é”ã€‚

```java
public class AtomicReferenceDemo2 {

    private static int ticket = 10;

    public static void main(String[] args) {
        threadSafeDemo();
    }

    private static void threadSafeDemo() {
        SpinLock lock = new SpinLock();
        ExecutorService executorService = Executors.newFixedThreadPool(3);
        for (int i = 0; i < 5; i++) {
            executorService.execute(new MyThread(lock));
        }
        executorService.shutdown();
    }

    static class SpinLock {

        private AtomicReference<Thread> atomicReference = new AtomicReference<>();

        public void lock() {
            Thread current = Thread.currentThread();
            while (!atomicReference.compareAndSet(null, current)) {}
        }

        public void unlock() {
            Thread current = Thread.currentThread();
            atomicReference.compareAndSet(current, null);
        }

    }

    static class MyThread implements Runnable {

        private SpinLock lock;

        public MyThread(SpinLock lock) {
            this.lock = lock;
        }

        @Override
        public void run() {
            while (ticket > 0) {
                lock.lock();
                if (ticket > 0) {
                    System.out.println(Thread.currentThread().getName() + " å–å‡ºäº†ç¬¬ " + ticket + " å¼ ç¥¨");
                    ticket--;
                }
                lock.unlock();
            }
        }

    }

}
```

è¾“å‡ºç»“æœï¼š

```
pool-1-thread-2 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 9 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 8 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 7 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 6 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 5 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 4 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 3 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 2 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 1 å¼ ç¥¨
```

### CAS çš„é—®é¢˜

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒCAS æ¯”é”æ€§èƒ½æ›´é«˜ã€‚å› ä¸º CAS æ˜¯ä¸€ç§éé˜»å¡ç®—æ³•ï¼Œæ‰€ä»¥å…¶é¿å…äº†çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„ç­‰å¾…æ—¶é—´ã€‚

ä½†æ˜¯ï¼ŒCAS ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ã€‚

#### ABA é—®é¢˜

å¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ã€‚

J.U.C åŒ…æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„åŸå­å¼•ç”¨ç±» `AtomicStampedReference` æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯ CAS çš„æ­£ç¡®æ€§ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ ABA é—®é¢˜ä¸ä¼šå½±å“ç¨‹åºå¹¶å‘çš„æ­£ç¡®æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³ ABA é—®é¢˜ï¼Œæ”¹ç”¨ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆã€‚

#### å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§

è‡ªæ—‹ CAS ï¼ˆä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚

å¦‚æœ JVM èƒ½æ”¯æŒå¤„ç†å™¨æä¾›çš„ `pause` æŒ‡ä»¤é‚£ä¹ˆæ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æå‡ï¼Œ`pause` æŒ‡ä»¤æœ‰ä¸¤ä¸ªä½œç”¨ï¼š

- å®ƒå¯ä»¥å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤ï¼ˆde-pipelineï¼‰,ä½¿ CPU ä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„æ‰§è¡Œèµ„æºï¼Œå»¶è¿Ÿçš„æ—¶é—´å–å†³äºå…·ä½“å®ç°çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šå»¶è¿Ÿæ—¶é—´æ˜¯é›¶ã€‚
- å®ƒå¯ä»¥é¿å…åœ¨é€€å‡ºå¾ªç¯çš„æ—¶å€™å› å†…å­˜é¡ºåºå†²çªï¼ˆmemory order violationï¼‰è€Œå¼•èµ· CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼ˆCPU pipeline flushï¼‰ï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚

æ¯”è¾ƒèŠ±è´¹ CPU èµ„æºï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•ç”¨ä¹Ÿä¼šåšä¸€äº›æ— ç”¨åŠŸã€‚

#### åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§

å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚

æˆ–è€…æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚æœ‰ä¸¤ä¸ªå…±äº«å˜é‡ `i ï¼ 2, j = a`ï¼Œåˆå¹¶ä¸€ä¸‹ `ij=2a`ï¼Œç„¶åç”¨ CAS æ¥æ“ä½œ `ij`ã€‚ä» Java 1.5 å¼€å§‹ JDK æä¾›äº† `AtomicReference` ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œä½ å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡Œ CAS æ“ä½œã€‚

## äº”ã€ThreadLocal

> **`ThreadLocal` æ˜¯ä¸€ä¸ªå­˜å‚¨çº¿ç¨‹æœ¬åœ°å‰¯æœ¬çš„å·¥å…·ç±»**ã€‚
>
> è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸ä¸€å®šéè¦è¿›è¡ŒåŒæ­¥ã€‚åŒæ­¥åªæ˜¯ä¿è¯å…±äº«æ•°æ®äº‰ç”¨æ—¶çš„æ­£ç¡®æ€§ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æœ¬æ¥å°±ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œé‚£ä¹ˆè‡ªç„¶æ— é¡»åŒæ­¥ã€‚
>
> Java ä¸­çš„ **æ— åŒæ­¥æ–¹æ¡ˆ** æœ‰ï¼š
>
> - **å¯é‡å…¥ä»£ç ** - ä¹Ÿå«çº¯ä»£ç ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„ **è¿”å›ç»“æœæ˜¯å¯ä»¥é¢„æµ‹çš„**ï¼Œå³åªè¦è¾“å…¥äº†ç›¸åŒçš„æ•°æ®ï¼Œå°±èƒ½è¿”å›ç›¸åŒçš„ç»“æœï¼Œé‚£å®ƒå°±æ»¡è¶³å¯é‡å…¥æ€§ï¼Œå½“ç„¶ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
> - **çº¿ç¨‹æœ¬åœ°å­˜å‚¨** - ä½¿ç”¨ **`ThreadLocal` ä¸ºå…±äº«å˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°å‰¯æœ¬**ï¼Œè¿™ä¸ªå‰¯æœ¬åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ï¼Œé‚£ä¹ˆè‡ªç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

### ThreadLocal çš„ç”¨æ³•

`ThreadLocal` çš„æ–¹æ³•ï¼š

```java
public class ThreadLocal<T> {
    public T get() {}
    public void set(T value) {}
    public void remove() {}
    public static <S> ThreadLocal<S> withInitial(Supplier<? extends S> supplier) {}
}
```

> è¯´æ˜ï¼š
>
> - `get` - ç”¨äºè·å– `ThreadLocal` åœ¨å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„å˜é‡å‰¯æœ¬ã€‚
> - `set` - ç”¨äºè®¾ç½®å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚
> - `remove` - ç”¨äºåˆ é™¤å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚å¦‚æœæ­¤çº¿ç¨‹å±€éƒ¨å˜é‡éšåè¢«å½“å‰çº¿ç¨‹è¯»å–ï¼Œåˆ™å…¶å€¼å°†é€šè¿‡è°ƒç”¨å…¶ `initialValue` æ–¹æ³•é‡æ–°åˆå§‹åŒ–ï¼Œé™¤éå…¶å€¼ç”±ä¸­é—´çº¿ç¨‹ä¸­çš„å½“å‰çº¿ç¨‹è®¾ç½®ã€‚ è¿™å¯èƒ½ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ `initialValue` æ–¹æ³•ã€‚
> - `initialValue` - ä¸º ThreadLocal è®¾ç½®é»˜è®¤çš„ `get` åˆå§‹å€¼ï¼Œéœ€è¦é‡å†™ `initialValue` æ–¹æ³• ã€‚

`ThreadLocal` å¸¸ç”¨äºé˜²æ­¢å¯¹å¯å˜çš„å•ä¾‹ï¼ˆSingletonï¼‰å˜é‡æˆ–å…¨å±€å˜é‡è¿›è¡Œå…±äº«ã€‚å…¸å‹åº”ç”¨åœºæ™¯æœ‰ï¼šç®¡ç†æ•°æ®åº“è¿æ¥ã€Sessionã€‚

ç¤ºä¾‹ - æ•°æ®åº“è¿æ¥

```java
private static ThreadLocal<Connection> connectionHolder = new ThreadLocal<Connection>() {
    @Override
    public Connection initialValue() {
        return DriverManager.getConnection(DB_URL);
    }
};

public static Connection getConnection() {
    return connectionHolder.get();
}
```

ç¤ºä¾‹ - Session ç®¡ç†

```java
private static final ThreadLocal<Session> sessionHolder = new ThreadLocal<>();

public static Session getSession() {
    Session session = (Session) sessionHolder.get();
    try {
        if (session == null) {
            session = createSession();
            sessionHolder.set(session);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
    return session;
}
```

ç¤ºä¾‹ - å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

```java
public class ThreadLocalDemo {

    private static ThreadLocal<Integer> threadLocal = new ThreadLocal<Integer>() {
        @Override
        protected Integer initialValue() {
            return 0;
        }
    };

    public static void main(String[] args) {
        ExecutorService executorService = Executors.newFixedThreadPool(10);
        for (int i = 0; i < 10; i++) {
            executorService.execute(new MyThread());
        }
        executorService.shutdown();
    }

    static class MyThread implements Runnable {

        @Override
        public void run() {
            int count = threadLocal.get();
            for (int i = 0; i < 10; i++) {
                try {
                    count++;
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            threadLocal.set(count);
            threadLocal.remove();
            System.out.println(Thread.currentThread().getName() + " : " + count);
        }

    }

}
```

å…¨éƒ¨è¾“å‡º count = 10

### ThreadLocal çš„åŸç†

#### å­˜å‚¨ç»“æ„

`Thread` ç±»ä¸­ç»´æŠ¤ç€ä¸€ä¸ª `ThreadLocal.ThreadLocalMap` ç±»å‹çš„æˆå‘˜ `threadLocals`ã€‚è¿™ä¸ªæˆå‘˜å°±æ˜¯ç”¨æ¥å­˜å‚¨çº¿ç¨‹ç‹¬å çš„å˜é‡å‰¯æœ¬ã€‚

`ThreadLocalMap` æ˜¯ `ThreadLocal` çš„å†…éƒ¨ç±»ï¼Œå®ƒç»´æŠ¤ç€ä¸€ä¸ª `Entry` æ•°ç»„ï¼Œ `Entry` ç”¨äºä¿å­˜é”®å€¼å¯¹ï¼Œå…¶ key æ˜¯ `ThreadLocal` å¯¹è±¡ï¼Œvalue æ˜¯ä¼ é€’è¿›æ¥çš„å¯¹è±¡ï¼ˆå˜é‡å‰¯æœ¬ï¼‰ã€‚

#### å¦‚ä½•è§£å†³ Hash å†²çª

`ThreadLocalMap` è™½ç„¶æ˜¯ç±»ä¼¼ `Map` ç»“æ„çš„æ•°æ®ç»“æ„ï¼Œä½†å®ƒå¹¶æ²¡æœ‰å®ç° `Map` æ¥å£ã€‚å®ƒä¸æ”¯æŒ `Map` æ¥å£ä¸­çš„ `next` æ–¹æ³•ï¼Œè¿™æ„å‘³ç€ `ThreadLocalMap` ä¸­è§£å†³ Hash å†²çªçš„æ–¹å¼å¹¶é **æ‹‰é“¾è¡¨** æ–¹å¼ã€‚

å®é™…ä¸Šï¼Œ**`ThreadLocalMap` é‡‡ç”¨çº¿æ€§æ¢æµ‹çš„æ–¹å¼æ¥è§£å†³ Hash å†²çª**ã€‚æ‰€è°“çº¿æ€§æ¢æµ‹ï¼Œå°±æ˜¯æ ¹æ®åˆå§‹ key çš„ hashcode å€¼ç¡®å®šå…ƒç´ åœ¨ table æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœå‘ç°è¿™ä¸ªä½ç½®ä¸Šå·²ç»è¢«å…¶ä»–çš„ key å€¼å ç”¨ï¼Œåˆ™åˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½®ã€‚

#### å†…å­˜æ³„æ¼é—®é¢˜

ThreadLocalMap çš„ `Entry` ç»§æ‰¿äº† `WeakReference`ï¼Œæ‰€ä»¥å®ƒçš„ key ï¼ˆ`ThreadLocal` å¯¹è±¡ï¼‰æ˜¯å¼±å¼•ç”¨ï¼Œè€Œ value ï¼ˆå˜é‡å‰¯æœ¬ï¼‰æ˜¯å¼ºå¼•ç”¨ã€‚

- å¦‚æœ `ThreadLocal` å¯¹è±¡æ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨æ¥å¼•ç”¨å®ƒï¼Œé‚£ä¹ˆ `ThreadLocal` å¯¹è±¡ä¼šåœ¨ä¸‹æ¬¡ GC æ—¶è¢«å›æ”¶ã€‚
- æ­¤æ—¶ï¼Œ`Entry` ä¸­çš„ key å·²ç»è¢«å›æ”¶ï¼Œä½†æ˜¯ value ç”±äºæ˜¯å¼ºå¼•ç”¨ä¸ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚å¦‚æœåˆ›å»º `ThreadLocal` çš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œé‚£ä¹ˆ value å°±ä¼šä¸€ç›´å¾—ä¸åˆ°å›æ”¶ï¼Œäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚

é‚£ä¹ˆå¦‚ä½•é¿å…å†…å­˜æ³„æ¼å‘¢ï¼Ÿæ–¹æ³•å°±æ˜¯ï¼š**ä½¿ç”¨ `ThreadLocal` çš„ `set` æ–¹æ³•åï¼Œæ˜¾ç¤ºçš„è°ƒç”¨ `remove` æ–¹æ³•** ã€‚

```java
ThreadLocal<String> threadLocal = new ThreadLocal();
try {
    threadLocal.set("xxx");
    // ...
} finally {
    threadLocal.remove();
}
```

## å‚è€ƒèµ„æ–™

- [ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹](https://item.jd.com/10922250.html)
- [ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹](https://item.jd.com/11740734.html)
- [ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹](https://item.jd.com/11252778.html)
- [Java å¹¶å‘ç¼–ç¨‹ï¼švolatile å…³é”®å­—è§£æ](http://www.cnblogs.com/dolphin0520/p/3920373.html)
- [Java å¹¶å‘ç¼–ç¨‹ï¼šsynchronized](http://www.cnblogs.com/dolphin0520/p/3923737.html)
- [æ·±å…¥ç†è§£ Java å¹¶å‘ä¹‹ synchronized å®ç°åŸç†](https://blog.csdn.net/javazejian/article/details/72828483)
- [Java CAS å®Œå…¨è§£è¯»](https://www.jianshu.com/p/473e14d5ab2d)
- [Java ä¸­ CAS è¯¦è§£](https://blog.csdn.net/ls5718/article/details/52563959)
- [ThreadLocal ç»ˆæç¯‡](https://juejin.im/post/5a64a581f265da3e3b7aa02d)
- [synchronized å®ç°åŸç†åŠé”ä¼˜åŒ–](https://nicky-chen.github.io/2018/05/14/synchronized-principle/)
- [Non-blocking Algorithms](http://tutorials.jenkov.com/java-concurrency/non-blocking-algorithms.html)
